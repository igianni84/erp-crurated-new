# Ralph Progress Log
Started: Wed Feb  4 08:12:32 CET 2026
---

## Codebase Patterns
- Use `HasUuid` trait for UUID primary keys with `$table->uuid('id')->primary()` in migrations
- Use `Auditable` trait with `created_by`/`updated_by` columns and `auditLogs()` MorphMany relationship
- Use `SoftDeletes` trait with `$table->softDeletes()` in migrations
- Customer module enums go in `App\Enums\Customer\` namespace
- Customer module models go in `App\Models\Customer\` namespace
- Enums need `label()`, `color()`, and `icon()` methods for Filament compatibility
- Migration naming: `YYYY_MM_DD_XXXXXX_create_table_name_table.php`
- Use `foreignId()->constrained()->nullOnDelete()` for FK references to users table
- Use `foreignUuid()->constrained()->cascadeOnDelete()` for FK references to UUID tables (Module K uses UUIDs)
- Filament Resources for Customer module go in `App\Filament\Resources\Customer\` namespace
- For PHPStan on Filament bulk actions, add `/** @var Collection<int, ModelName> $records */` PHPDoc before each() call

---

## 2026-02-04 - US-001
- What was implemented:
  - Created `PartyType` enum (individual, legal_entity) with label/color/icon methods
  - Created `PartyStatus` enum (active, inactive) with label/color/icon methods
  - Created `Party` model with HasUuid, Auditable, SoftDeletes traits
  - Created migration for `parties` table with unique constraint on (tax_id, jurisdiction)
  - Created `PartyRole` stub model for relationship placeholder (full implementation in US-002)
- Files changed:
  - app/Enums/Customer/PartyType.php (new)
  - app/Enums/Customer/PartyStatus.php (new)
  - app/Models/Customer/Party.php (new)
  - app/Models/Customer/PartyRole.php (new - stub)
  - database/migrations/2026_02_04_390000_create_parties_table.php (new)
- **Learnings for future iterations:**
  - Customer module uses `App\Enums\Customer\` and `App\Models\Customer\` namespaces
  - Migration sequence for Module K starts at 390000
  - PartyRole stub created to satisfy Party relationship, will be completed in US-002
---

## 2026-02-04 - US-002
- What was implemented:
  - Created `PartyRoleType` enum (customer, supplier, producer, partner) with label/color/icon methods
  - Completed `PartyRole` model with HasUuid, Auditable traits and role type casting
  - Created migration for `party_roles` table with FK to parties and unique constraint on (party_id, role)
  - Updated `Party` model with addRole/removeRole methods and role checking helpers (isCustomer, isSupplier, isProducer, isPartner)
- Files changed:
  - app/Enums/Customer/PartyRoleType.php (new)
  - app/Models/Customer/PartyRole.php (updated from stub)
  - app/Models/Customer/Party.php (updated - added role helpers)
  - database/migrations/2026_02_04_390001_create_party_roles_table.php (new)
- **Learnings for future iterations:**
  - Use `foreignUuid()->constrained()->cascadeOnDelete()` for FK references to UUID tables (vs foreignId for int tables)
  - Migration sequence continues: 390001 for party_roles
  - Party model uses union type `PartyRoleType|string` to accept both enum and string values for backward compatibility
---

## 2026-02-04 - US-003
- What was implemented:
  - Created `PartyResource` Filament resource in `App\Filament\Resources\Customer` namespace
  - List view with columns: legal_name, party_type (badge), roles (badges), jurisdiction, status (badge), tax_id, vat_number, updated_at
  - Filters: party_type, role (with custom query for relationship), status, jurisdiction (dynamic), TrashedFilter
  - Search on: legal_name, tax_id, vat_number
  - Bulk actions: activate, deactivate with confirmation
  - CRUD pages: ListParties, CreateParty, ViewParty, EditParty
  - Added "Customers" navigation group to AdminPanelProvider
- Files changed:
  - app/Providers/Filament/AdminPanelProvider.php (updated - added Customers navigation group)
  - app/Filament/Resources/Customer/PartyResource.php (new)
  - app/Filament/Resources/Customer/PartyResource/Pages/ListParties.php (new)
  - app/Filament/Resources/Customer/PartyResource/Pages/CreateParty.php (new)
  - app/Filament/Resources/Customer/PartyResource/Pages/ViewParty.php (new)
  - app/Filament/Resources/Customer/PartyResource/Pages/EditParty.php (new)
- **Learnings for future iterations:**
  - Filament Resources in Customer module go in `App\Filament\Resources\Customer\` namespace
  - Use `->with('roles')` in `getEloquentQuery()` to eager load relationships for list display
  - For bulk actions with Collection, use PHPDoc annotation `/** @var Collection<int, Model> $records */` before the each() call to satisfy PHPStan
  - Role filter needs custom query using `whereHas()` to filter by relationship
  - Navigation groups must be defined in AdminPanelProvider's `navigationGroups()` array
---

## 2026-02-04 - US-004
- What was implemented:
  - Extended `ViewParty` page with tabs using Filament Infolists Tabs component
  - Tab Overview: identity summary with Party ID, legal name, party type, status, created/updated dates, and assigned roles
  - Tab Roles: list of assigned roles with add role (modal form) and remove role (confirmation) actions
  - Tab Legal: tax_id, vat_number, jurisdiction fields with compliance notes section (placeholder)
  - Tab Audit: full audit trail timeline with filters (event type, date range), shows user, timestamp, and changes
  - Header actions: Activate/Deactivate contextual actions that show/hide based on party status
- Files changed:
  - app/Filament/Resources/Customer/PartyResource/Pages/ViewParty.php (updated - complete rewrite with tabs)
- **Learnings for future iterations:**
  - Use `Tabs::make()->tabs([...])` with `persistTabInQueryString()` for persistent tab state
  - For repeatable entries with actions, use `RepeatableEntry` with `\Filament\Infolists\Components\Actions\Action` inside
  - Audit trail pattern: use `getStateUsing()` with HTML output for custom timeline rendering
  - Header section actions use `\Filament\Infolists\Components\Actions\Action` (different from `Filament\Actions\Action`)
  - For modal forms in infolist actions, use standard Filament form components in the `form()` method
  - Tab badges show counts using `badge()` method, e.g., `->badge($count > 0 ? (string) $count : null)`
---

## 2026-02-04 - US-005
- What was implemented:
  - Created `CustomerType` enum (b2c, b2b, partner) with label/color/icon methods
  - Created `CustomerStatus` enum (prospect, active, suspended, closed) with label/color/icon methods
  - Enhanced existing `Customer` model with Party relationship, Auditable trait, and Module K fields
  - Created migration to add Module K fields to existing customers table (party_id FK, customer_type, default_billing_address_id, created_by, updated_by)
  - Created `PartyRoleObserver` to auto-create Customer when Party receives customer role
  - Added backward-compatible STATUS_* constants to Customer model for existing code compatibility
  - Updated ViewCustomer page to use CustomerStatus enum for badge colors/icons
- Files changed:
  - app/Enums/Customer/CustomerType.php (new)
  - app/Enums/Customer/CustomerStatus.php (new)
  - app/Models/Customer/Customer.php (updated - added Party relationship, enum casts, backward-compat constants)
  - app/Observers/Customer/PartyRoleObserver.php (new)
  - app/Providers/AppServiceProvider.php (updated - registered PartyRoleObserver)
  - app/Filament/Resources/Customer/CustomerResource/Pages/ViewCustomer.php (updated - use CustomerStatus enum)
  - database/migrations/2026_02_04_390002_add_module_k_fields_to_customers_table.php (new)
- **Learnings for future iterations:**
  - When enhancing existing models with enum status, keep backward-compatible constants for existing code (deprecated)
  - Module K migrations alter existing tables: use `Schema::table()` with `after()` to position new columns
  - Observer pattern is clean way to auto-create related models when roles are assigned
  - Observers are registered in AppServiceProvider's `boot()` method using `Model::observe(Observer::class)`
  - Migration sequence continues: 390002 for customers table enhancement
---
