# Ralph Progress Log
Started: Tue Feb  3 18:51:45 CET 2026
---

## Codebase Patterns
- Enums should be PHP 8.1+ backed enums with `label()`, `color()`, and `icon()` helper methods for Filament integration
- Allocation-related enums go in `app/Enums/Allocation/`
- Use wine_variant_id + format_id as bottle SKU reference (no separate BottleSku model exists)
- Jobs go in `app/Jobs/{Module}/` - schedule in `routes/console.php` using `Schedule::job()->everyMinute()`
- Services go in `app/Services/{Module}/` - use DB::transaction() with lockForUpdate() for atomic quantity operations
- Filament Resources go in `app/Filament/Resources/{Module}/` with Pages subdirectory - use enum methods for badge styling
- Filament Wizard forms: use `CreateRecord\Concerns\HasWizard` trait in CreateXxx page class, override `form()` and `getSteps()`

---

## 2026-02-03 - US-002
- What was implemented: Verified that all three allocation enums already exist and meet acceptance criteria
- Files verified (no changes needed):
  - `app/Enums/Allocation/AllocationSourceType.php`
  - `app/Enums/Allocation/AllocationSupplyForm.php`
  - `app/Enums/Allocation/AllocationStatus.php`
- **Learnings for future iterations:**
  - Enums were created as part of US-001 setup, so this story was already complete
  - AllocationStatus includes transition helpers: `allowedTransitions()`, `canTransitionTo()`, `allowsConstraintEditing()`, `allowsConsumption()`, `isTerminal()`
  - All enums follow Filament patterns with label/color/icon methods
---

## 2026-02-03 - US-003
- What was implemented: AllocationConstraint model for authoritative commercial constraints on allocations
- Files changed:
  - `database/migrations/2026_02_03_260000_create_allocation_constraints_table.php` (new)
  - `app/Models/Allocation/AllocationConstraint.php` (new)
  - `app/Models/Allocation/Allocation.php` (added hasOne relationship and auto-create on allocation creation)
- **Learnings for future iterations:**
  - AllocationConstraint is automatically created when an Allocation is created (via `created` event in Allocation model boot)
  - Constraints can only be edited when Allocation is in Draft status (validated in AllocationConstraint's `updating` event)
  - The `constraint()` relationship uses HasOne pattern; the FK is `allocation_id` on the constraints table with unique constraint
  - JSON array fields use `'array'` cast in Laravel and `@property array<string>|null` PHPDoc for PHPStan
  - Helper methods: `getAllChannels()`, `getAllCustomerTypes()` return available options; `isChannelAllowed()`, etc. for constraint checking
---

## 2026-02-03 - US-004
- What was implemented: LiquidAllocationConstraint model for liquid-specific allocation constraints
- Files changed:
  - `database/migrations/2026_02_03_270000_create_liquid_allocation_constraints_table.php` (new)
  - `app/Models/Allocation/LiquidAllocationConstraint.php` (new)
  - `app/Models/Allocation/Allocation.php` (added liquidConstraint() relationship and isLiquid()/isBottled() helpers)
- **Learnings for future iterations:**
  - LiquidAllocationConstraint has a `saving` event that validates `allocation.supply_form === AllocationSupplyForm::Liquid`
  - Unlike AllocationConstraint, LiquidAllocationConstraint is NOT auto-created on Allocation creation (only applicable for liquid allocations)
  - Both constraint models follow the same pattern: unique FK to allocation_id, `updating` event to prevent edits on non-Draft allocations
  - Added `isLiquid()` and `isBottled()` helper methods to Allocation model for easier supply_form checks
---

## 2026-02-03 - US-005
- What was implemented: TemporaryReservation model for temporary holds on allocation quantity to prevent overselling
- Files changed:
  - `database/migrations/2026_02_03_280000_create_temporary_reservations_table.php` (new)
  - `app/Models/Allocation/TemporaryReservation.php` (new)
  - `app/Enums/Allocation/ReservationContextType.php` (new) - checkout, negotiation, manual_hold
  - `app/Enums/Allocation/ReservationStatus.php` (new) - active, expired, cancelled, converted
  - `app/Jobs/Allocation/ExpireReservationsJob.php` (new) - scheduled job to expire reservations
  - `app/Models/Allocation/Allocation.php` (added temporaryReservations() and activeReservations() relationships)
  - `routes/console.php` (added scheduled job registration)
- **Learnings for future iterations:**
  - TemporaryReservation does NOT consume allocation - it only "blocks" quantity temporarily
  - ReservationStatus has `isActive()`, `isTerminal()`, `allowedTransitions()`, `canTransitionTo()` helpers like AllocationStatus
  - Model includes helper methods: `expire()`, `cancel()`, `convert()` for state transitions
  - Scopes `active()` and `needsExpiration()` are available for querying
  - Jobs go in `app/Jobs/{Module}/` directory structure
  - Laravel 11+ scheduling is done in `routes/console.php` using `Schedule::job()->everyMinute()`
---

## 2026-02-03 - US-006
- What was implemented: AllocationService for centralizing allocation business logic
- Files changed:
  - `app/Services/Allocation/AllocationService.php` (new)
- **Methods implemented:**
  - `activate(Allocation)`: draft → active transition
  - `close(Allocation)`: active/exhausted → closed transition
  - `consumeAllocation(Allocation, quantity)`: decrements remaining, increments sold with DB transaction locking
  - `checkAvailability(Allocation, quantity)`: checks if quantity is available (remaining - active_reservations >= quantity)
  - `getRemainingAvailable(Allocation)`: returns remaining - sum(active_reservations.quantity)
  - `canActivate(Allocation)`, `canClose(Allocation)`: helper methods for checking allowed transitions
  - `markAsExhausted(Allocation)`: active → exhausted transition (auto-called when remaining reaches 0)
- **Learnings for future iterations:**
  - Services go in `app/Services/{Module}/` directory structure
  - Use `DB::transaction()` with `lockForUpdate()` for atomic operations that modify quantities
  - Always double-check availability after acquiring lock to prevent race conditions
  - Status transitions should auto-trigger where appropriate (e.g., exhausted when remaining=0)
  - Use explicit exception messages that explain what's wrong and how to fix it
---

## 2026-02-03 - US-007
- What was implemented: AllocationResource for Filament admin panel with comprehensive list view
- Files changed:
  - `app/Filament/Resources/Allocation/AllocationResource.php` (new)
  - `app/Filament/Resources/Allocation/AllocationResource/Pages/ListAllocations.php` (new)
  - `app/Filament/Resources/Allocation/AllocationResource/Pages/CreateAllocation.php` (new)
  - `app/Filament/Resources/Allocation/AllocationResource/Pages/ViewAllocation.php` (new)
  - `app/Filament/Resources/Allocation/AllocationResource/Pages/EditAllocation.php` (new)
- **Features implemented:**
  - Navigation group 'Allocations' with cube-transparent icon
  - All required columns: id, bottle_sku, supply_form, source_type, status, total_qty, sold_qty, remaining_qty, availability_window, constraint_summary, updated_at
  - Status, source_type, supply_form shown as badges with colors and icons from enums
  - Near exhaustion indicator: remaining_qty shows danger color, bold text, and warning icon when < 10%
  - Filters: status (multi-select, default excludes Closed), source_type (multi-select), supply_form, wine_variant/bottle_sku, near_exhaustion toggle, trashed
  - Search: wine name, producer, allocation ID via searchable columns
  - Eager loading of relationships (wineVariant.wineMaster, format, constraint) via modifyQueryUsing
- **Learnings for future iterations:**
  - Filament Resources go in `app/Filament/Resources/{Module}/` with Pages subdirectory
  - Use `formatStateUsing()` with enum's `label()` method for badge text
  - Use `color()` and `icon()` from enum for badge styling
  - For computed columns, use `state()` callback to call model methods like `getBottleSkuLabel()`
  - For searchable computed columns, use `searchable(query: ...)` with custom query builder
  - Use `modifyQueryUsing()` on table for eager loading relationships
  - Default filter values with `->default()` to pre-populate filter (e.g., exclude Closed status)
---

## 2026-02-03 - US-008
- What was implemented: Create Allocation wizard - Step 1 (Bottle SKU selection)
- Files changed:
  - `app/Filament/Resources/Allocation/AllocationResource/Pages/CreateAllocation.php` (modified to add wizard)
- **Features implemented:**
  - Wizard-based form using `CreateRecord\Concerns\HasWizard` trait
  - Step 1: Bottle SKU selection with cascading selects:
    - Wine selection via autocomplete search (searches by name or producer)
    - Vintage selection (dynamically filtered by selected WineMaster)
    - Format selection (all available formats ordered by volume_ml)
  - Bottle SKU preview showing full label: Wine (Producer) Vintage - Format
  - Info message: "Allocation always happens at Bottle SKU level (Wine + Vintage + Format)"
  - `mutateFormDataBeforeCreate()` removes temporary wine_master_id field
- **Learnings for future iterations:**
  - Use `CreateRecord\Concerns\HasWizard` trait for multi-step forms
  - For cascading selects: use `live()` + `afterStateUpdated()` to reset dependent fields
  - Use `hidden()` with `Get` callback to show/hide sections based on previous selections
  - Use `getSearchResultsUsing()` for custom autocomplete search logic
  - Use `getOptionLabelUsing()` to format existing option labels for display
  - Use `getAttribute()` instead of direct property access to avoid PHPStan strict type errors
---

## 2026-02-03 - US-009
- What was implemented: Create Allocation wizard - Step 2 (Source & Capacity)
- Files changed:
  - `app/Filament/Resources/Allocation/AllocationResource/Pages/CreateAllocation.php` (added getSourceAndCapacityStep method)
- **Features implemented:**
  - Source Type select with all AllocationSourceType enum options (producer_allocation, owned_stock, passive_consignment, third_party_custody)
  - Supply Form select with AllocationSupplyForm enum options (bottled, liquid)
  - Live inline guidance explaining implications of bottled vs liquid supply:
    - Bottled: ready for sale, individual serialization
    - Liquid: still in barrel/tank, bottling options may apply, additional constraints in Step 4
  - Total Quantity numeric input with minValue(1) validation and "bottles" suffix
  - Availability Window with start/end date pickers, afterOrEqual validation for end date
  - Serialization Required toggle (default true) with live inline guidance:
    - Enabled: unique identifier for provenance tracking, recommended for fine wine
    - Disabled: bottles not individually tracked, for commodity wines only
- **Learnings for future iterations:**
  - Use `live()` on fields that need to update guidance Placeholders dynamically
  - Use `native(false)` on Select components for better Filament-styled dropdowns
  - Use `afterOrEqual()` validation on DatePicker for date range validation (cleaner than custom rules)
  - Placeholder components with markdown (**bold**) work for inline guidance
  - Each step method returns a Wizard\Step - add to getSteps() array
---

## 2026-02-03 - US-010
- What was implemented: Create Allocation wizard - Step 3 (Commercial Constraints)
- Files changed:
  - `app/Filament/Resources/Allocation/AllocationResource/Pages/CreateAllocation.php` (added getCommercialConstraintsStep method, updated getSteps, mutateFormDataBeforeCreate, and added afterCreate)
- **Features implemented:**
  - Step 3: Commercial Constraints with shield-check icon
  - Prominent warning message: "⚠️ AUTHORITATIVE CONSTRAINTS — These constraints are binding and will be enforced by Module S"
  - CheckboxList for allowed_channels with options: b2c, b2b, private_sales, wholesale, club (displayed in 2 columns)
  - TagsInput for allowed_geographies (flexible input for ISO country/region codes)
  - CheckboxList for allowed_customer_types with options: retail, trade, private_client, club_member, internal (displayed in 2 columns)
  - Helper text explaining default behavior: empty = all allowed
  - Info note about constraints becoming read-only after activation
  - Nested form data handling via session storage + afterCreate hook to update AllocationConstraint
- **Learnings for future iterations:**
  - Use `constraint.field_name` dot notation for nested related model fields in wizard forms
  - For related model data in creation wizards, use session storage in `mutateFormDataBeforeCreate()` and apply in `afterCreate()` hook
  - CheckboxList with `->columns(2)` for compact multi-select display
  - TagsInput is flexible for user-defined values (like geography codes) vs CheckboxList for predefined options
  - Use PHPDoc `@var` type hints to help PHPStan understand `$this->record` type in afterCreate
---

## 2026-02-03 - US-011
- What was implemented: Create Allocation wizard - Step 4 (Advanced/Liquid Constraints)
- Files changed:
  - `app/Filament/Resources/Allocation/AllocationResource/Pages/CreateAllocation.php` (added getAdvancedConstraintsStep method, updated getSteps, mutateFormDataBeforeCreate, and afterCreate)
- **Features implemented:**
  - Step 4: Advanced Constraints with adjustments-horizontal icon
  - Liquid Allocation Constraints section (visible/expanded only when supply_form = liquid):
    - allowed_bottling_formats (TagsInput) - customers can choose from specified formats
    - allowed_case_configurations (TagsInput) - packaging options for customers
    - bottling_confirmation_deadline (DatePicker) - deadline for bottling preferences
    - Inline guidance explaining liquid allocation requirements
  - Advanced Commercial Constraints section (always available, collapsed by default for bottled, expanded for liquid):
    - composition_constraint_group (TextInput) - for vertical cases and themed selections
    - fungibility_exception (Toggle) - for non-interchangeable bottles
    - Inline guidance explaining composition groups and fungibility exceptions
  - Tip message for bottled allocations that advanced constraints are optional
  - LiquidAllocationConstraint created in afterCreate hook for liquid allocations with specified data
- **Learnings for future iterations:**
  - Use `->hidden()` combined with `->collapsed()` and `->collapsible()` to control section visibility and state based on other form fields
  - For liquid-specific related models (LiquidAllocationConstraint), create them in afterCreate only when the allocation is liquid using `$allocation->isLiquid()` helper
  - Session storage pattern works well for multiple related model data: store in `mutateFormDataBeforeCreate()`, apply in `afterCreate()`
  - Use `liquid_constraint.field_name` dot notation pattern consistent with `constraint.field_name` for nested model fields
---

## 2026-02-03 - US-012
- What was implemented: Create Allocation wizard - Step 5 (Review & Create)
- Files changed:
  - `app/Filament/Resources/Allocation/AllocationResource/Pages/CreateAllocation.php` (added getReviewStep method, getWizardSubmitActions, createAsDraft, createAndActivate, updated afterCreate)
  - `app/Policies/AllocationPolicy.php` (new) - Authorization policy for Allocation model
  - `app/Providers/AppServiceProvider.php` (updated to register AllocationPolicy)
- **Features implemented:**
  - Step 5: Review & Create with check-badge icon
  - Read-only summary sections for: Bottle SKU, Source & Capacity, Commercial Constraints
  - Advanced Constraints section (shown only if composition_constraint_group or fungibility_exception is set)
  - Liquid Allocation Constraints section (shown only for liquid allocations)
  - Draft warning message: "Draft allocations cannot be consumed and do not issue vouchers"
  - Before You Create section with guidance on both creation options
  - Two submit actions via custom getWizardSubmitActions() returning Blade component:
    - "Create as Draft" (primary button) - creates allocation in Draft status
    - "Create and Activate" (success button, role-based) - creates and immediately activates
  - AllocationPolicy with `activate` permission for role-based button visibility using @can directive
  - AfterCreate hook calls AllocationService::activate() when shouldActivateAfterCreate is true
  - Filament Notification messages for both success paths and activation failure
- **Learnings for future iterations:**
  - Custom wizard submit buttons can be implemented by returning HtmlString from getWizardSubmitActions() with Blade::render()
  - Use Livewire wire:click="methodName" to call page methods from custom buttons
  - For role-based actions in wizards, use @can directive with policy
  - Policies for models in subdirectories (App\Models\Allocation\Allocation) need explicit registration in AppServiceProvider using Gate::policy()
  - Property $shouldActivateAfterCreate pattern works for tracking button-specific behavior across create() and afterCreate()
---

## 2026-02-03 - US-013
- What was implemented: Allocation Detail view with 6 tabs organized using Filament Infolist Tabs
- Files changed:
  - `app/Filament/Resources/Allocation/AllocationResource/Pages/ViewAllocation.php` (complete rewrite with tabs)
  - `app/Models/Allocation/Allocation.php` (added auditLogs() morphMany relationship)
- **Features implemented:**
  - Tab 1 - Overview: Status & Identity (allocation ID, UUID, status badges, source type, supply form, serialization), Bottle SKU info, Quantities (total, sold, remaining, available), Availability Window, Lineage Rule explanation
  - Tab 2 - Constraints: Commercial constraints display with Edit link (visible only in Draft), Advanced constraints section (composition group, fungibility exception), Liquid constraints section (for liquid allocations)
  - Tab 3 - Capacity & Consumption: Capacity overview with utilization percentage, Active reservations impact showing reserved vs available quantity, Placeholder for future consumption breakdown by sellable SKU/channel/time (pending Voucher implementation)
  - Tab 4 - Reservations: RepeatableEntry showing all temporary reservations with ID, quantity, context type, status, expires_at, and reference; Summary counts by status (total, active, expired, converted)
  - Tab 5 - Vouchers: Placeholder for future voucher list (pending US-015+ implementation)
  - Tab 6 - Audit: RepeatableEntry showing auditLogs with event badge, user, timestamp, and formatted changes
  - Header Actions: Activate (visible for Draft, role-based), Close (visible for Active/Exhausted, role-based), Edit, More (Delete/Restore)
- **Learnings for future iterations:**
  - Use `Tabs::make()->tabs([...])` with separate methods for each Tab for clean organization
  - Use `->persistTabInQueryString()` to preserve active tab in URL
  - Tab badges can show counts with `->badge(fn () => ...)` and `->badgeColor()`
  - Use `RepeatableEntry::make('relationshipName')` to display hasMany relationships in infolist
  - TextEntry `->getStateUsing()` allows computed values; use service calls for business logic
  - Sections support `->headerActions([...])` for inline action buttons
  - AuditLog polymorphic relationship uses `morphMany(\App\Models\AuditLog::class, 'auditable')`
  - Authorization on header actions: `->authorize('policyMethod', $record)`
---
