# Ralph Progress Log
Started: Tue Feb  3 21:41:29 CET 2026
---

## Codebase Patterns
- Use `HasUuid` trait for UUID primary keys (models should use `$table->uuid('id')->primary()` in migrations)
- Use `Auditable` trait for audit logging (requires `created_by`, `updated_by` columns and `auditLogs()` MorphMany relation)
- Use `SoftDeletes` trait for soft deletion support
- Enums should include `label()`, `color()`, and `icon()` methods for Filament UI compatibility
- Commercial entities go in `app/Enums/Commercial/` and `app/Models/Commercial/`
- Migration naming: `YYYY_MM_DD_NNNNNN_action_table_name.php` where NNNNNN is sequence number
- Filament resources: main class in `app/Filament/Resources/`, pages in `Pages/` subdirectory
- Filament navigation groups are defined in `AdminPanelProvider.php`
- Use `$navigationGroup = 'Commercial'` for all Commercial module resources
- For table-based list pages (not CRUD resources), use Filament Page with HasTable interface and InteractsWithTable trait
- Module configuration goes in `config/{module}.php` (e.g., `config/commercial.php`) and is accessed via `config('module.key')`

---

## 2026-02-03 - US-001
- What was implemented:
  - ChannelType enum (b2c, b2b, private_club) with label/color/icon methods
  - ChannelStatus enum (active, inactive) with label/color/icon methods
  - Channel model with HasUuid, Auditable, SoftDeletes traits
  - channels migration with all required fields (name, channel_type, default_currency, allowed_commercial_models JSON, status)
- Files changed:
  - app/Enums/Commercial/ChannelType.php (created)
  - app/Enums/Commercial/ChannelStatus.php (created)
  - app/Models/Commercial/Channel.php (created)
  - database/migrations/2026_02_03_380000_create_channels_table.php (created)
- **Learnings for future iterations:**
  - Follow the existing enum pattern with label(), color(), icon() methods for Filament compatibility
  - Channel model serves as the foundational commercial entity - other entities (PriceBook, Offer) will reference it
  - allowed_commercial_models is a JSON array that can contain 'voucher_based' and 'sell_through'
---

## 2026-02-03 - US-002
- What was implemented:
  - PriceBookStatus enum (draft, active, expired, archived)
  - PricingPolicyStatus enum (draft, active, paused, archived)
  - PricingPolicyType enum (cost_plus_margin, reference_price_book, index_based, fixed_adjustment, rounding)
  - PricingPolicyInputSource enum (cost, emp, price_book, external_index)
  - OfferStatus enum (draft, active, paused, expired, cancelled)
  - OfferType enum (standard, promotion, bundle)
  - OfferVisibility enum (public, restricted)
  - ExecutionCadence enum (manual, scheduled, event_triggered)
  - All enums follow the established pattern with label(), color(), icon() methods
- Files changed:
  - app/Enums/Commercial/PriceBookStatus.php (created)
  - app/Enums/Commercial/PricingPolicyStatus.php (created)
  - app/Enums/Commercial/PricingPolicyType.php (created)
  - app/Enums/Commercial/PricingPolicyInputSource.php (created)
  - app/Enums/Commercial/OfferStatus.php (created)
  - app/Enums/Commercial/OfferType.php (created)
  - app/Enums/Commercial/OfferVisibility.php (created)
  - app/Enums/Commercial/ExecutionCadence.php (created)
- **Learnings for future iterations:**
  - The established enum pattern continues to work well for all commercial status/type enums
  - PHPStan config has an unused ignored pattern for "trait.unused" - this is a config issue, not code issue
  - Enums provide consistent Filament UI elements through color() and icon() methods
---

## 2026-02-03 - US-003
- What was implemented:
  - EmpSource enum (livex, internal, composite) with label/color/icon methods
  - EmpConfidenceLevel enum (high, medium, low) with label/color/icon methods
  - EstimatedMarketPrice model with HasUuid trait and belongsTo SellableSku relationship
  - estimated_market_prices migration with unique constraint on sellable_sku_id + market
  - Freshness indicators (isFresh, isStale, getFreshnessIndicator) for data quality tracking
- Files changed:
  - app/Enums/Commercial/EmpSource.php (created)
  - app/Enums/Commercial/EmpConfidenceLevel.php (created)
  - app/Models/Commercial/EstimatedMarketPrice.php (created)
  - database/migrations/2026_02_03_380001_create_estimated_market_prices_table.php (created)
- **Learnings for future iterations:**
  - EMP is a read-only entity in Module S (imported from external process), so no Auditable trait needed
  - The unique constraint on sellable_sku_id + market ensures one EMP per SKU per market
  - Freshness indicators help UI display data quality (fresh < 24h, recent 1-7 days, stale > 7 days)
  - SellableSku uses uuid primary key, so foreign keys use foreignUuid() in migrations
---

## 2026-02-03 - US-004
- What was implemented:
  - ChannelResource Filament resource with full CRUD capabilities
  - Commercial navigation group added to AdminPanelProvider
  - List view with columns: name, channel_type (badge), default_currency, status (badge), allowed_models (badges), updated_at
  - Filters for channel_type and status
  - Search by name
  - Create/View/Edit pages with form for all Channel fields
  - Soft delete support with restore action
- Files changed:
  - app/Filament/Resources/ChannelResource.php (created)
  - app/Filament/Resources/ChannelResource/Pages/ListChannels.php (created)
  - app/Filament/Resources/ChannelResource/Pages/CreateChannel.php (created)
  - app/Filament/Resources/ChannelResource/Pages/ViewChannel.php (created)
  - app/Filament/Resources/ChannelResource/Pages/EditChannel.php (created)
  - app/Providers/Filament/AdminPanelProvider.php (modified - added Commercial nav group)
- **Learnings for future iterations:**
  - Filament resources follow a consistent pattern: Resource class + Pages/ directory with List/Create/View/Edit pages
  - Badge columns with enums use formatStateUsing, color, and icon callbacks
  - JSON array fields (like allowed_commercial_models) can be displayed as comma-separated badges
  - Navigation groups must be registered in AdminPanelProvider for proper sidebar organization
  - Use getEloquentQuery() to include soft-deleted records in the list view
---

## 2026-02-03 - US-005
- What was implemented:
  - Channel Detail view with 4 tabs using Filament Infolist Tabs component
  - Tab Overview: Channel ID, name, channel_type (badge), default_currency, status (badge), allowed commercial models display (voucher_based/sell_through status)
  - Tab Price Books: Placeholder section explaining future Price Book integration (US-009+)
  - Tab Offers: Placeholder section explaining future Offer integration (US-033+)
  - Tab Audit: Full audit log timeline with filtering by event type and date range
  - Audit log HTML rendering with color-coded event badges and change tracking
- Files changed:
  - app/Filament/Resources/ChannelResource/Pages/ViewChannel.php (modified - added tabbed infolist with 4 tabs)
- **Learnings for future iterations:**
  - Use Filament Infolist with Tabs::make() for tabbed detail views, with persistTabInQueryString() for URL state
  - Tab methods (getOverviewTab, etc.) provide clean separation of concerns for complex views
  - Placeholder tabs are acceptable when dependent features (PriceBook, Offer) don't exist yet
  - Audit log display uses custom HTML generation with getStateUsing() and ->html() for rich formatting
  - Filter state in ViewRecord pages uses public properties (auditEventFilter, etc.) with action callbacks
---

## 2026-02-03 - US-006
- What was implemented:
  - PricingIntelligence Filament Page under Commercial navigation group
  - Table view with HasTable trait for advanced filtering and pagination
  - Columns: Sellable SKU (wine + vintage + format + packaging), market, emp_value, confidence, active_price_book_price (placeholder), active_offer_price (placeholder), delta_vs_emp (placeholder), freshness_indicator
  - Filters: market (multi-select), confidence_level (multi-select), stale_data toggle, missing_data toggle
  - Search by SKU code and wine name with deep relationship queries
  - Statistics cards showing total records, markets covered, stale data count, low confidence count
  - Placeholder notices for future Price Book and Offer integrations
  - Read-only view with no edit actions
- Files changed:
  - app/Filament/Pages/PricingIntelligence.php (created)
  - resources/views/filament/pages/pricing-intelligence.blade.php (created)
- **Learnings for future iterations:**
  - Filament Pages can implement HasTable interface for table-based views
  - Use InteractsWithTable trait with table() method for table configuration
  - Deep relationship searches require whereHas() with nested callbacks
  - Sortable columns with relationships need explicit join queries in sortable() callback
  - Placeholder columns with dashes and tooltips are good for features not yet implemented
  - Statistics can be exposed via public methods and accessed in Blade templates with $this->getStatistics()
---

## 2026-02-03 - US-007
- What was implemented:
  - PricingIntelligenceDetail Filament Page for detailed EMP analysis per Sellable SKU
  - Tab EMP Overview: SKU information, current EMP values by market with freshness indicators, source breakdown with visual percentages, historical trend placeholder
  - Tab Comparisons: Placeholder sections for EMP vs Price Book prices and EMP vs active Offer prices (pending US-009+, US-033+)
  - Tab Market Coverage: Visual display of markets with EMP data, data quality warnings for stale/low confidence/missing date data
  - Tab Signals & Alerts: Outlier detection using z-score analysis (>2 standard deviations), placeholder for price deviation alerts
  - Tab Audit: EMP update history with filtering by market and date range
  - Read-only view (no modification actions)
  - Link from PricingIntelligence list view to detail view
- Files changed:
  - app/Filament/Pages/PricingIntelligenceDetail.php (created)
  - resources/views/filament/pages/pricing-intelligence-detail.blade.php (created)
  - app/Filament/Pages/PricingIntelligence.php (modified - enabled view_detail action)
- **Learnings for future iterations:**
  - Filament Pages can use slug patterns with parameters like `pricing-intelligence/{record}` for dynamic routes
  - Use mount() method to load the record and related data based on URL parameters
  - Infolist tabs can have badges (e.g., alert count) using ->badge() and ->badgeColor()
  - Standard deviation-based outlier detection is effective for identifying EMP anomalies across markets
  - Public properties (auditMarketFilter, etc.) with Action form callbacks enable filter state management
  - Use `$shouldRegisterNavigation = false` for detail pages that shouldn't appear in navigation
---

## 2026-02-03 - US-008
- What was implemented:
  - CommercialOverview Filament Page as landing page for Commercial module
  - EMP Alerts widget showing: total EMP records, price deviations count (placeholder), stale data count, low confidence count
  - Alert cards with links to Pricing Intelligence page with appropriate filters
  - Alert severity system based on percentage thresholds (success, warning, danger)
  - Markets with data quality issues summary
  - Configurable threshold setting via config/commercial.php (default 15%)
  - Placeholder widgets for future features: Active Price Books, Active Offers, Pricing Policies
  - Quick Actions section with links to available features and placeholders for upcoming ones
- Files changed:
  - app/Filament/Pages/CommercialOverview.php (created)
  - resources/views/filament/pages/commercial-overview.blade.php (created)
  - config/commercial.php (created - commercial module configuration)
- **Learnings for future iterations:**
  - Use config() helper for retrievable settings (e.g., threshold values)
  - Config files are created in config/ directory and loaded automatically by Laravel
  - Alert severity can be computed dynamically using percentage-based thresholds
  - Dashboard pages benefit from placeholder sections explaining upcoming features
  - URL query parameters for Filament table filters use format `?tableFilters[filter_name][value]=1`
  - Quick action grids with disabled placeholders provide good UX for incomplete features
---

## 2026-02-03 - US-009
- What was implemented:
  - PriceBook model with HasUuid, Auditable, SoftDeletes traits
  - price_books migration with all required fields: id (uuid), name, market, channel_id (FK nullable), currency, valid_from, valid_to, status (enum), approved_at, approved_by
  - BelongsTo relationships: channel (optional), approver (User)
  - Status helper methods: isDraft, isActive, isExpired, isArchived, isApproved
  - Editability and activation checks: canBeActivated, canBeArchived, isEditable
  - Validity period helpers: isWithinValidityPeriod, isExpiringSoon
  - Scope for finding active price books: scopeActiveForContext(market, channelId, currency)
  - Composite index for efficient context lookups
- Files changed:
  - app/Models/Commercial/PriceBook.php (created)
  - database/migrations/2026_02_03_380002_create_price_books_table.php (created)
- **Learnings for future iterations:**
  - PriceBook is the authoritative pricing document - it contains base prices for SKUs
  - Channel relationship is optional (FK nullable) - some price books may be channel-agnostic
  - Approval workflow uses approved_at + approved_by fields, both nullable until approved
  - Status transitions follow specific rules: draft→active (requires approval), active→expired, expired→archived
  - Only one PriceBook can be active per market+channel+currency combination (enforced at service layer)
  - isExpiringSoon() checks for price books expiring within 30 days (for UI warnings)
---

## 2026-02-03 - US-010
- What was implemented:
  - PriceSource enum (manual, policy_generated) with label/color/icon methods
  - PriceBookEntry model with HasUuid trait
  - BelongsTo relationships: priceBook, sellableSku, pricingPolicy (optional)
  - price_book_entries migration with unique constraint on price_book_id + sellable_sku_id
  - Added entries() hasMany relationship to PriceBook model
  - Source helper methods: isManual, isPolicyGenerated, getSourceLabel, getSourceColor
- Files changed:
  - app/Enums/Commercial/PriceSource.php (created)
  - app/Models/Commercial/PriceBookEntry.php (created)
  - database/migrations/2026_02_03_380003_create_price_book_entries_table.php (created)
  - app/Models/Commercial/PriceBook.php (modified - added entries() relationship)
- **Learnings for future iterations:**
  - PriceBookEntry links Sellable SKUs to their prices within a PriceBook
  - policy_id FK is nullable and references PricingPolicy (to be created in US-020) - used phpstan-ignore for now
  - Unique constraint ensures one price per SKU per Price Book
  - cascadeOnDelete used for both price_book_id and sellable_sku_id FKs (entries deleted when parent removed)
  - Source enum tracks whether price was manually set or generated by a pricing policy
---

## 2026-02-03 - US-011
- What was implemented:
  - PriceBookResource Filament resource with navigation group 'Commercial'
  - List view with columns: name, market (badge), channel, currency (badge), valid_from, valid_to, status (badge), entries_count (with warning for empty), updated_at
  - Filters: status, channel, market, currency, expiring_soon (ternary), missing_prices (ternary), trashed
  - Search by name
  - Visual indicators: warning icon for Price Books expiring within 30 days, danger badge for Price Books with no entries
  - Create, View, Edit pages following standard Filament resource pattern
  - Edit action only visible for editable (draft) Price Books
- Files changed:
  - app/Filament/Resources/PriceBookResource.php (created)
  - app/Filament/Resources/PriceBookResource/Pages/ListPriceBooks.php (created)
  - app/Filament/Resources/PriceBookResource/Pages/CreatePriceBook.php (created)
  - app/Filament/Resources/PriceBookResource/Pages/ViewPriceBook.php (created)
  - app/Filament/Resources/PriceBookResource/Pages/EditPriceBook.php (created)
- **Learnings for future iterations:**
  - Use counts('relationship') for entry counts in table columns
  - TernaryFilter with queries callback enables complex filter logic (expiring soon, missing prices)
  - Model helper methods (isExpiringSoon, isEditable) can be used in table column callbacks for conditional styling
  - Form fields can be conditionally disabled based on record state (e.g., status disabled for active Price Books)
---

## 2026-02-03 - US-012, US-013, US-014, US-015
- What was implemented:
  - Multi-step wizard for PriceBook creation using HasWizard trait
  - Step 1 (Metadata): name, market (searchable select with common markets), channel (optional), currency
  - Step 2 (Validity): valid_from, valid_to with after() validation, overlap detection with existing price books
  - Step 3 (Initial Prices): Radio selection between Empty, Clone, CSV (CSV marked as not implemented)
  - Step 4 (Review): Summary of all data, status info, "Create as Draft" button
  - Clone functionality: copies entries from source PriceBook with source set to Manual
  - Overlap check: queries existing Draft/Active price books for same market+channel+currency with date overlap
- Files changed:
  - app/Filament/Resources/PriceBookResource/Pages/CreatePriceBook.php (modified - converted to wizard)
- **Learnings for future iterations:**
  - Use HasWizard trait with getSteps() method for wizard-based CreateRecord pages
  - Wizard::make($this->getSteps()) with submitAction() for custom submit button
  - HtmlString used for complex placeholder content with HTML formatting
  - Live fields (->live()) enable reactive UI based on form state
  - Session storage (session(['key' => value])) for passing data between mutateFormDataBeforeCreate and afterCreate
  - Overlap detection requires careful date comparison logic for nullable valid_to
---

## 2026-02-03 - US-016
- What was implemented:
  - PriceBook Detail view with 5 tabs using Filament Infolist Tabs
  - Tab Overview: name, market, currency, channel, status, validity period with expiring indicator, coverage stats (total/manual/policy entries)
  - Tab Prices: RepeatableEntry showing all price entries with SKU ID, base_price (money formatted), source badge
  - Tab Scope & Applicability: geographic scope, channel applicability info, priority rules explanation
  - Tab Lifecycle: current status, approval info, status transitions, editable state
  - Tab Audit: full audit log with filter by event type and date range
  - Header actions: Edit (visible only for draft), Activate (draft→active with confirmation), Archive (active→archived)
  - Activate action validates at least one price entry exists before allowing activation
- Files changed:
  - app/Filament/Resources/PriceBookResource/Pages/ViewPriceBook.php (modified - added 5 tabs and actions)
- **Learnings for future iterations:**
  - RepeatableEntry displays hasMany relationships in infolists
  - money() method on TextEntry formats currency values with proper symbol
  - Use getRecord() method instead of $this->record when accessing in closures for proper type inference
  - FontWeight enum should be used directly (FontWeight::Bold) not its ->value property for weight() method
  - Action visibility can be controlled via visible() with record state checks (canBeActivated, canBeArchived)
---

## 2026-02-03 - US-017
- What was implemented:
  - EntriesRelationManager for PriceBook resource showing price entries
  - Columns: sku_code (searchable), wine name, vintage, format, base_price (inline editable), source (badge), emp_value, delta_vs_emp (color coded)
  - TextInputColumn for inline editing of base_price (auto-updates source to Manual)
  - Filters: source type (manual/policy_generated), has_emp ternary filter
  - Bulk actions: Adjust by % (multiplier), Set Fixed Price
  - Create/Edit/Delete actions visible only when PriceBook is in Draft status
  - Added estimatedMarketPrices() relationship to SellableSku model
  - Delta calculation compares base_price with EMP value, color-coded (>15%: danger, >10%: warning)
- Files changed:
  - app/Filament/Resources/PriceBookResource/RelationManagers/EntriesRelationManager.php (created)
  - app/Filament/Resources/PriceBookResource.php (modified - registered relation manager)
  - app/Models/Pim/SellableSku.php (modified - added estimatedMarketPrices relationship)
- **Learnings for future iterations:**
  - TextInputColumn enables inline editing in tables with afterStateUpdated callback
  - Decimal columns in Eloquent are stored as strings - cast to float for arithmetic operations
  - Use getOwnerRecord() in RelationManager closures with instanceof check for type safety
  - TernaryFilter with whereHas/whereDoesntHave enables filtering by related model existence
  - Bulk actions can use Collection and mutate records with custom logic
---

## 2026-02-03 - US-018
- What was implemented:
  - PriceBook activation workflow with approval role check (Manager+ required)
  - Approval records approved_at and approved_by fields on activation
  - Validation: at least 1 price entry must exist before activation
  - Overlap detection: finds active PriceBooks for same market/channel/currency
  - Auto-expire overlapping PriceBooks with user confirmation
  - Disabled "Activate" button with tooltip for users without approver role
  - Model helper methods: hasEntries(), canBeActivatedWithEntries(), findOverlappingActivePriceBooks(), hasOverlappingActivePriceBooks()
  - Prices already read-only after activation (via isEditable() from US-016)
- Files changed:
  - app/Models/User.php (modified - added canApprovePriceBooks() method)
  - app/Models/Commercial/PriceBook.php (modified - added overlap detection methods)
  - app/Filament/Resources/PriceBookResource/Pages/ViewPriceBook.php (modified - enhanced activate action with validation and overlap handling)
- **Learnings for future iterations:**
  - User role checking for specific actions can be added via dedicated methods (canApprovePriceBooks)
  - UserRole enum hasAtLeast() method enables flexible permission checks (Manager+ means Manager, Admin, SuperAdmin)
  - Overlap detection for validity periods needs careful date comparison: check if new.valid_from <= existing.valid_to AND (existing.valid_from <= new.valid_to OR new.valid_to IS NULL)
  - Modal descriptions can use "\n" for multi-line text and bullet points for warnings
  - Disabled actions with tooltips provide good UX for explaining why actions are unavailable
---

## 2026-02-03 - US-019
- What was implemented:
  - PriceBookService class in `app/Services/Commercial/` centralizing all PriceBook business logic
  - `activate(PriceBook, User)` method: draft → active with approval, auto-expires overlapping PriceBooks
  - `archive(PriceBook)` method: active/expired → archived with audit logging
  - `expirePriceBook(PriceBook)` method: active → expired (internal helper)
  - `cloneToNew(PriceBook, newMetadata)` method: creates new draft from existing PriceBook with all entries
  - `getActiveForContext(channelId, market, currency)` method: finds applicable active PriceBook for a given context
  - `getPriceForSku(PriceBook, SellableSku)` method: returns PriceBookEntry or null
  - `getBasePriceForSku(PriceBook, SellableSku)` method: returns decimal price value or null
  - `canActivate(PriceBook)` and `canArchive(PriceBook)` helper methods
  - All state transitions with validation and explicit exceptions
  - Audit logging via `logStatusTransition()` with approval info
  - Updated ViewPriceBook to use PriceBookService for activate/archive actions
  - Fixed PHPStan issues in ViewPriceBook (type casting for form data, audit log values)
- Files changed:
  - app/Services/Commercial/PriceBookService.php (created)
  - app/Filament/Resources/PriceBookResource/Pages/ViewPriceBook.php (modified - uses service)
- **Learnings for future iterations:**
  - Services should be placed in `app/Services/{Module}/` directory (e.g., `app/Services/Commercial/`)
  - Service pattern: centralize business logic, return modified model, throw InvalidArgumentException for validation failures
  - DB::transaction() for multi-step operations (like cloning entries or expiring overlapping records)
  - Use `app(ServiceClass::class)` in Filament actions to resolve the service from container
  - Audit logging pattern: create audit log entry with old/new values via model's auditLogs() relationship
---

## 2026-02-03 - US-020
- What was implemented:
  - PricingPolicy model with HasUuid, Auditable, SoftDeletes traits
  - pricing_policies migration with all required fields: id (uuid), name, policy_type, input_source, target_price_book_id (FK nullable), logic_definition (JSON), execution_cadence, status, last_executed_at
  - BelongsTo relationship: targetPriceBook (PriceBook)
  - HasMany relationship: generatedEntries (PriceBookEntry)
  - Status helper methods: isDraft, isActive, isPaused, isArchived
  - State transition checks: canBeActivated, canBePaused, canBeResumed, canBeArchived
  - Execution helpers: canBeExecuted, canDryRun, hasBeenExecuted
  - Cadence helpers: isScheduled, isEventTriggered, isManualExecution
  - Logic definition accessors: getMarginPercentage, getMarkupValue, getRoundingRule, getTieredLogic
  - getLogicDescription() for plain-language policy explanation
  - Added pricingPolicies() relationship to PriceBook model
  - Updated PriceBookEntry.pricingPolicy() to use proper class reference
- Files changed:
  - app/Models/Commercial/PricingPolicy.php (created)
  - database/migrations/2026_02_03_380004_create_pricing_policies_table.php (created)
  - app/Models/Commercial/PriceBook.php (modified - added pricingPolicies relationship)
  - app/Models/Commercial/PriceBookEntry.php (modified - fixed pricingPolicy relationship)
- **Learnings for future iterations:**
  - PricingPolicy generates prices into a target PriceBook, never activates the PriceBook directly
  - logic_definition is a flexible JSON field containing: margin_percentage, markup_value, rounding_rule, tiered_logic
  - Status transitions differ from PriceBook: draft→active→paused (bidirectional)→archived
  - getLogicDescription() provides user-friendly explanation of policy rules for UI display
  - Policies can be scheduled, event-triggered, or manual - stored in execution_cadence field
---

## 2026-02-03 - US-021
- What was implemented:
  - PolicyScopeType enum (all, category, product, sku) with label/color/icon/description methods
  - PricingPolicyScope model with HasUuid trait and belongsTo pricingPolicy relationship
  - pricing_policy_scopes migration with: pricing_policy_id (FK), scope_type (enum), scope_reference (nullable), markets (JSON array nullable), channels (JSON array nullable)
  - Added scope() hasOne relationship to PricingPolicy model
  - Scope helper methods: isAllScope, isCategoryScope, isProductScope, isSkuScope
  - Market/channel restriction checks: hasMarketRestrictions, hasChannelRestrictions, isMarketInScope, isChannelInScope
  - getScopeDescription() for plain-language scope explanation
- Files changed:
  - app/Enums/Commercial/PolicyScopeType.php (created)
  - app/Models/Commercial/PricingPolicyScope.php (created)
  - database/migrations/2026_02_03_380005_create_pricing_policy_scopes_table.php (created)
  - app/Models/Commercial/PricingPolicy.php (modified - added scope() relationship)
- **Learnings for future iterations:**
  - PricingPolicyScope defines which SKUs a PricingPolicy applies to via scope_type
  - scope_reference holds the category/product/sku ID depending on scope_type (null for 'all')
  - Markets and channels arrays provide additional filtering beyond the base scope
  - hasOne relationship used instead of hasMany - each policy has exactly one scope definition
  - Scope resolution to actual Sellable SKUs will be handled by PricingPolicyService (US-032)
---

## 2026-02-03 - US-022
- What was implemented:
  - ExecutionType enum (manual, scheduled, dry_run) with label/color/icon methods
  - ExecutionStatus enum (success, partial, failed) with label/color/icon methods
  - PricingPolicyExecution model with HasUuid trait and belongsTo pricingPolicy relationship
  - pricing_policy_executions migration with: pricing_policy_id (FK), executed_at, execution_type, skus_processed, prices_generated, errors_count, status, log_summary
  - Added executions() hasMany relationship to PricingPolicy model
  - Helper methods: latestExecution(), successfulExecutionsCount(), failedExecutionsCount()
  - Execution model helpers: isSuccess, isPartial, isFailed, isDryRun, isManual, isScheduled, hasErrors, getSuccessRate, getSummary
- Files changed:
  - app/Enums/Commercial/ExecutionType.php (created)
  - app/Enums/Commercial/ExecutionStatus.php (created)
  - app/Models/Commercial/PricingPolicyExecution.php (created)
  - database/migrations/2026_02_03_380006_create_pricing_policy_executions_table.php (created)
  - app/Models/Commercial/PricingPolicy.php (modified - added executions() relationship and helper methods)
- **Learnings for future iterations:**
  - PricingPolicyExecution logs are immutable - they cannot be modified after creation
  - Execution model does not use Auditable trait since logs are already immutable
  - getSuccessRate() calculates success percentage based on prices_generated vs errors_count
  - latestExecution() on PricingPolicy returns the most recent execution for quick status checks
  - ExecutionType.DryRun is for preview executions that don't write to the Price Book
---

## 2026-02-03 - US-023
- What was implemented:
  - PricingPolicyResource Filament resource with navigation group 'Commercial'
  - List view with columns: name (with logic description), policy_type (badge), input_source (badge), target_price_book, status (badge), last_executed (with execution status icon), execution_cadence (badge)
  - Filters: status, policy_type, target_price_book, has_failed_executions (ternary), trashed
  - Search by name
  - Visual indicator for last execution status (icon and color from ExecutionStatus enum)
  - Create Pricing Policy CTA in header
  - Create, View, Edit pages following standard Filament resource pattern
  - Edit action only visible for editable (draft) policies
- Files changed:
  - app/Filament/Resources/PricingPolicyResource.php (created)
  - app/Filament/Resources/PricingPolicyResource/Pages/ListPricingPolicies.php (created)
  - app/Filament/Resources/PricingPolicyResource/Pages/CreatePricingPolicy.php (created)
  - app/Filament/Resources/PricingPolicyResource/Pages/ViewPricingPolicy.php (created)
  - app/Filament/Resources/PricingPolicyResource/Pages/EditPricingPolicy.php (created)
- **Learnings for future iterations:**
  - latestExecution() method on PricingPolicy provides quick access to the most recent execution for status display
  - Use static helper methods in Resource class to extract complex column logic (getLastExecutionIcon, etc.)
  - Ternary filters with whereHas/whereDoesntHave enable filtering by related model conditions
  - description() on TextColumn can show additional context (like getLogicDescription()) below the main value
---

## 2026-02-03 - US-024
- What was implemented:
  - Converted CreatePricingPolicy page to multi-step wizard using HasWizard trait
  - Step 1 (Type): name input with placeholder example, policy_type radio selection with 5 options
  - Policy type options: Cost + Margin, Reference Price Book, External Index (EMP/FX), Fixed Adjustment, Rounding/Normalization
  - Rich inline descriptions for each policy type with: title, description, input source, example, best for
  - Dynamic details panel that changes based on selected policy type with color-coded backgrounds
  - Default values set in mutateFormDataBeforeCreate: status=draft, execution_cadence=manual, input_source based on policy_type
  - Empty logic_definition initialized (to be populated in Step 3)
- Files changed:
  - app/Filament/Resources/PricingPolicyResource/Pages/CreatePricingPolicy.php (modified - converted to wizard)
- **Learnings for future iterations:**
  - HasWizard trait with getSteps() method enables wizard-based CreateRecord pages
  - Radio component with descriptions() method provides rich descriptions below each option
  - Live fields (->live()) enable reactive UI that updates based on user selection
  - HtmlString with dynamic color classes enables rich formatted info panels based on state
  - When using match expressions, avoid redundant default case when all values are already covered (PHPStan warning)
  - mutateFormDataBeforeCreate() is ideal for setting default values that depend on other form values
---

## 2026-02-03 - US-025
- What was implemented:
  - Step 2 (Inputs) for PricingPolicy wizard with dynamic fields based on policy_type
  - Cost + Margin: cost_source select (product_catalog, bottle_sku_cost, manual) with info panels
  - Reference Price Book: source_price_book_id select with preview (market, currency, status, entries count)
  - External Index: index_type radio (emp/fx_rate), EMP-specific options (market, confidence threshold), FX-specific options (source/target currency, rate buffer)
  - Fixed Adjustment: adjustment_type radio (percentage/fixed_amount), value input with live preview showing example calculations
  - Rounding: rounding_rule radio (.99, .95, .90, .00, nearest_5, nearest_10), rounding_direction (nearest/up/down), live preview examples
  - All inputs stored in logic_definition JSON field via mutateFormDataBeforeCreate
  - Temporary form fields cleaned up before model creation
- Files changed:
  - app/Filament/Resources/PricingPolicyResource/Pages/CreatePricingPolicy.php (modified - added getInputsStep)
- **Learnings for future iterations:**
  - Wizard steps can have dynamic visibility based on values from previous steps using Get $get
  - Fully-qualified class names (\App\Models\...) work well inline when imports aren't needed frequently
  - Live preview with calculated examples helps users understand the impact of their choices
  - Complex form data can be restructured in mutateFormDataBeforeCreate() to map UI fields to model JSON columns
  - Temporary form fields not in the model should be unset() before creation to avoid mass assignment issues
  - previewRounding() as a static method enables calling from within closures without $this context issues
---

## 2026-02-03 - US-026
- What was implemented:
  - Step 3 (Logic) for PricingPolicy wizard with dynamic fields based on policy_type
  - Cost + Margin: margin_type (percentage/fixed), margin_percentage input, markup_fixed_amount input
  - Cost + Margin: optional tiered margins with Repeater for category/price range tiers
  - Reference Price Book: adjustment_type (percentage/fixed), adjustment_value input
  - Reference Price Book: optional tiered adjustments with Repeater for category tiers
  - Index-Based: index_multiplier input (default 1.0), index_fixed_adjustment input
  - Fixed Adjustment: summary display of Step 2 configuration
  - Rounding: summary display of Step 2 configuration
  - Optional final rounding section for non-rounding policies (collapsible)
  - Formula Preview section showing plain-language summary (e.g., "Cost + 25% margin, rounded to .99")
  - Updated mutateFormDataBeforeCreate() to store all Step 3 fields in logic_definition JSON
  - Comprehensive data mapping: margin_percentage, markup_value, tiered_logic, adjustment_type/value, index_multiplier, rounding settings
- Files changed:
  - app/Filament/Resources/PricingPolicyResource/Pages/CreatePricingPolicy.php (modified - added getLogicStep)
- **Learnings for future iterations:**
  - Static methods (generateFormulaPreview) enable complex calculations in Placeholder content closures
  - Tiered logic uses Repeater component for dynamic tier configuration
  - Form values from multiple steps can be combined in mutateFormDataBeforeCreate() into a single JSON field
  - Collapsed sections (->collapsed()) are useful for optional advanced features like final rounding
  - PHPStan detects when conditions are always true (e.g., checking if a variable is empty when all switch cases assign it)
---

## 2026-02-03 - US-027
- What was implemented:
  - Step 4 (Scope & Target) for PricingPolicy wizard with target Price Book selection and SKU scope definition
  - Target Price Book section: searchable select for Draft/Active Price Books with preview showing market, currency, channel, status, and entry count
  - Warning displayed when targeting an already active Price Book
  - Scope Definition section with radio options: All SKUs, Category, Product, Specific SKUs
  - Category scope: text input for category name filter
  - Product scope: text input for product name filter (matches wine master name)
  - SKU scope: multi-select with searchable list of active Sellable SKUs
  - Market/Channel Filters section (collapsible): optional multi-select for market and channel restrictions
  - Scope Preview section: real-time SKU count based on scope selection with restrictions display
  - Allocation warning note informing users that policies only apply to SKUs with active allocations
  - Session-based data passing for scope data from mutateFormDataBeforeCreate() to afterCreate()
  - PricingPolicyScope record creation in afterCreate() with proper scope_type, scope_reference, markets, channels
- Files changed:
  - app/Filament/Resources/PricingPolicyResource/Pages/CreatePricingPolicy.php (modified - added getScopeAndTargetStep, updated mutateFormDataBeforeCreate, updated afterCreate)
- **Learnings for future iterations:**
  - Session storage is useful for passing complex nested data between mutateFormDataBeforeCreate() and afterCreate()
  - For multi-select SKU scope, store comma-separated IDs in scope_reference field
  - PHPStan warns about nullsafe operator (?->) when left side of ?? is unnecessary - use explicit null checks instead
  - Eager-loaded relationships can still be null, so explicit null checks are safer than nullsafe + coalesce pattern
  - Collapsible sections (->collapsed()) work well for optional filters that advanced users may want
---

## 2026-02-03 - US-028
- What was implemented:
  - Step 5 (Execution) for PricingPolicy wizard with execution cadence selection
  - Execution cadence options: Manual (on-demand), Scheduled (daily/weekly/monthly), Event-Triggered
  - Manual mode: info panel explaining the 4-step workflow (Activate → Dry Run → Execute → Review)
  - Scheduled mode: frequency selector (daily/weekly/monthly), day of week/month, time picker, schedule preview
  - Event-triggered mode: checkbox list for triggers (cost_change, emp_update, fx_change) with relevance suggestions
  - Important info banner explaining that policies generate draft prices, never activate directly
  - Execution cadence and schedule/trigger configuration stored in logic_definition JSON
  - Updated mutateFormDataBeforeCreate() to handle Step 5 fields and store schedule/trigger data
- Files changed:
  - app/Filament/Resources/PricingPolicyResource/Pages/CreatePricingPolicy.php (modified - added getExecutionStep, updated getSteps, updated mutateFormDataBeforeCreate)
- **Learnings for future iterations:**
  - ExecutionCadence enum has Manual, Scheduled, EventTriggered values with corresponding colors and icons
  - Schedule configuration stored as nested object in logic_definition: { schedule: { frequency, day_of_week, day_of_month, time } }
  - Event triggers stored as array in logic_definition: { event_triggers: ['cost_change', 'emp_update', 'fx_change'] }
  - PHPStan requires explicit type annotation for match() when all cases are covered but the variable type is string
  - CheckboxList with descriptions() provides inline help for each option
  - TimePicker component with seconds(false) provides clean time selection UI
---
