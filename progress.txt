# Ralph Progress Log
Started: Wed Feb  4 20:45:58 CET 2026

## Codebase Patterns
- Enums use PHP 8.1+ backed enums with string values
- Each enum includes label(), color(), icon() methods for Filament compatibility
- Status enums include allowedTransitions() and canTransitionTo() for state machine behavior
- Enums are organized in subdirectories by module: app/Enums/{ModuleName}/
- Use match expressions for enum method implementations
- Finance models use HasUuid, Auditable, SoftDeletes traits
- Finance models are in app/Models/Finance/ directory
- Immutability enforcement: use isDirty() in boot() static::updating() hook, throw InvalidArgumentException
- Currency calculations: use bcsub()/bccomp() for precision, cast as 'decimal:2'

---

## 2026-02-04 - US-E001
- What was implemented: Created 15 Finance enums for the ERP financial module
- Files changed:
  - app/Enums/Finance/InvoiceType.php (INV0-INV4 with codes, labels, icons, and source requirements)
  - app/Enums/Finance/InvoiceStatus.php (draft, issued, paid, partially_paid, credited, cancelled)
  - app/Enums/Finance/PaymentSource.php (stripe, bank_transfer)
  - app/Enums/Finance/PaymentStatus.php (pending, confirmed, failed, refunded)
  - app/Enums/Finance/ReconciliationStatus.php (pending, matched, mismatched)
  - app/Enums/Finance/CreditNoteStatus.php (draft, issued, applied)
  - app/Enums/Finance/RefundType.php (full, partial)
  - app/Enums/Finance/RefundMethod.php (stripe, bank_transfer)
  - app/Enums/Finance/RefundStatus.php (pending, processed, failed)
  - app/Enums/Finance/SubscriptionPlanType.php (membership, service)
  - app/Enums/Finance/BillingCycle.php (monthly, quarterly, annual)
  - app/Enums/Finance/SubscriptionStatus.php (active, suspended, cancelled)
  - app/Enums/Finance/StorageBillingStatus.php (pending, invoiced, paid, blocked)
  - app/Enums/Finance/XeroSyncType.php (invoice, credit_note, payment)
  - app/Enums/Finance/XeroSyncStatus.php (pending, synced, failed)
- **Learnings for future iterations:**
  - InvoiceType enum includes helper methods like requiresSourceReference(), requiresDueDate(), defaultDueDateDays() and expectedSourceType() to encapsulate business logic
  - Status enums should include helper methods for checking if certain operations are allowed (e.g., allowsEditing(), allowsPayment())
  - BillingCycle includes months() method for date calculations
  - ReconciliationStatus has allowsBusinessEvents() method - only matched payments trigger downstream events
---

## 2026-02-04 - US-E002
- What was implemented: Created Invoice model with migration and stub models for related entities
- Files changed:
  - database/migrations/2026_02_04_300000_create_invoices_table.php (invoices table with all required fields)
  - app/Models/Finance/Invoice.php (full model with relationships, immutability constraints, and helper methods)
  - app/Models/Finance/InvoiceLine.php (stub for relationship to pass typecheck)
  - app/Models/Finance/InvoicePayment.php (stub for relationship to pass typecheck)
  - app/Models/Finance/CreditNote.php (stub for relationship to pass typecheck)
- **Learnings for future iterations:**
  - Finance models go in app/Models/Finance/ directory
  - Use HasUuid, Auditable, SoftDeletes traits consistently for Finance models
  - Immutability enforcement uses isDirty() checks in boot() static::updating() hook
  - invoice_type is immutable from creation (throws InvalidArgumentException if changed)
  - After issuance (status != draft), amounts and currency become immutable
  - Create stub models for forward-referenced relationships to allow typecheck to pass
  - Use bcsub() and bccomp() for currency calculations to avoid floating point issues
  - The concat_space linter rule requires no spaces around string concatenation dots
---

## 2026-02-04 - US-E003
- What was implemented: Created InvoiceLine model with migration, relationships, and immutability enforcement
- Files changed:
  - database/migrations/2026_02_04_300001_create_invoice_lines_table.php (invoice_lines table with all required fields including FK to sellable_skus)
  - app/Models/Finance/InvoiceLine.php (full model replacing stub, with relationships, calculations, and immutability constraints)
- **Learnings for future iterations:**
  - InvoiceLine uses auto-calculated line_total in saving hook: (quantity * unit_price) + tax_amount
  - Use bcmul()/bcadd()/bcdiv() for all decimal calculations to maintain precision
  - Immutability on child models must check parent's status (invoice.status !== Draft) in updating and deleting hooks
  - InvoiceLine does NOT use HasUuid, Auditable, or SoftDeletes - only simple id
  - PHPStan requires explicit null checks instead of nullsafe operator (?->) when used with null coalescing (??)
  - Helper method recalculateTax() can be used to auto-compute tax_amount from tax_rate
---

## 2026-02-04 - US-E004
- What was implemented: Created Payment model with migration for received payments from Stripe and bank transfers
- Files changed:
  - database/migrations/2026_02_04_300002_create_payments_table.php (payments table with all required fields)
  - app/Models/Finance/Payment.php (full model with relationships, status helpers, and computed properties)
- **Learnings for future iterations:**
  - Payment model uses HasUuid, Auditable, SoftDeletes traits like other Finance models
  - Payment has two status fields: status (PaymentStatus) and reconciliation_status (ReconciliationStatus)
  - canTriggerBusinessEvents() checks both reconciliation_status=matched AND status=confirmed
  - Payment->customer is nullable for unreconciled payments from bank transfers
  - getTotalAppliedAmount() and getUnappliedAmount() use invoicePayments relationship to calculate applied amounts
  - stripe_payment_intent_id has unique constraint for idempotency
---

## 2026-02-04 - US-E005
- What was implemented: Created InvoicePayment pivot model to track payment applications to invoices
- Files changed:
  - database/migrations/2026_02_04_300003_create_invoice_payments_table.php (invoice_payments table with FKs and unique constraint)
  - app/Models/Finance/InvoicePayment.php (full model replacing stub, with relationships and validation)
- **Learnings for future iterations:**
  - InvoicePayment is a pivot model with simple id (not UUID) and no Auditable/SoftDeletes traits
  - Validation of amount constraints (sum per invoice <= total, sum per payment <= amount) done in boot() creating/updating hooks
  - Use static helper methods (getTotalAppliedToInvoice, getTotalAppliedFromPayment) for querying applied amounts
  - Unique constraint on (invoice_id, payment_id) prevents duplicate applications
  - applied_by field tracks who applied the payment (nullable for automated reconciliation)
---

## 2026-02-04 - US-E006
- What was implemented: Created CreditNote model with migration for credit notes issued against invoices
- Files changed:
  - database/migrations/2026_02_04_300004_create_credit_notes_table.php (credit_notes table with all required fields)
  - app/Models/Finance/CreditNote.php (full model replacing stub, with relationships and status helpers)
  - app/Models/Finance/Refund.php (stub for relationship to pass typecheck)
- **Learnings for future iterations:**
  - CreditNote uses HasUuid, Auditable, SoftDeletes traits like other Finance models
  - CreditNote preserves invoice_type of original invoice via helper methods (getOriginalInvoiceType())
  - reason field is required (NOT NULL in migration) - business rule for audit trail
  - CreditNote has relationships to Invoice, Customer, and forward reference to Refund (hasMany)
  - Status flow: draft → issued → applied (terminal state)
  - issuedByUser() relationship tracks who issued the credit note
  - Create stub models for forward-referenced relationships (Refund) to allow typecheck to pass
---

## 2026-02-04 - US-E007
- What was implemented: Created Refund model with migration for refunds linked to invoices and payments
- Files changed:
  - database/migrations/2026_02_04_300005_create_refunds_table.php (refunds table with all required fields including FKs)
  - app/Models/Finance/Refund.php (full model replacing stub, with relationships, validation, and status helpers)
- **Learnings for future iterations:**
  - Refund uses HasUuid, Auditable, SoftDeletes traits like other Finance models
  - Refund requires both invoice_id and payment_id that MUST be linked via InvoicePayment
  - Validation in boot() creating hook ensures invoice-payment link exists
  - Validation also checks refund amount does not exceed payment applied amount
  - invoice_id and payment_id are immutable after creation (enforced in updating hook)
  - stripe_refund_id has unique constraint for idempotency with Stripe
  - reason field is required (NOT NULL) - business rule for audit trail
  - RefundMethod enum has supportsAutoProcess() for Stripe vs manual bank tracking
---

## 2026-02-04 - US-E008
- What was implemented: Created Subscription model with migration for customer subscriptions
- Files changed:
  - database/migrations/2026_02_04_300006_create_subscriptions_table.php (subscriptions table with all required fields)
  - app/Models/Finance/Subscription.php (full model with relationships, status transitions, and billing helpers)
- **Learnings for future iterations:**
  - Subscription uses HasUuid, Auditable, SoftDeletes traits like other Finance models
  - Subscription belongsTo Customer and hasMany Invoice (via source polymorphic - source_type='subscription')
  - Status transitions (active→suspended→cancelled) are validated in boot() updating hook
  - cancelled_at is auto-set when transitioning to Cancelled status
  - Billing helpers: isDueForBilling(), isOverdueForBilling(), calculateNextBillingDate()
  - BillingCycle enum's months() method is used for date calculations
  - stripe_subscription_id has unique constraint for Stripe integration
  - Plan type (membership/service) determines which invoice type is generated (INV0)
---

## 2026-02-04 - US-E009
- What was implemented: Created StorageBillingPeriod model with migration for storage billing periods
- Files changed:
  - database/migrations/2026_02_04_300007_create_storage_billing_periods_table.php (storage_billing_periods table with all required fields)
  - app/Models/Finance/StorageBillingPeriod.php (full model with relationships, status validation, and helper methods)
- **Learnings for future iterations:**
  - StorageBillingPeriod uses HasUuid, Auditable, SoftDeletes traits like other Finance models
  - StorageBillingPeriod belongsTo Customer, Location (nullable), and Invoice (nullable)
  - bottle_days represents sum(bottles * days_stored) during the period
  - unit_rate uses decimal(10,4) for precision in rate calculations
  - Status transitions (pending→invoiced→paid/blocked) are validated in boot() updating hook
  - Helper methods: getPeriodDays(), getAverageBottlesPerDay(), recalculateAmount()
  - Carbon's diffInDays() returns float, cast to int when needed for return type
  - Location relationship is nullable - can aggregate all locations or be specific
---

## 2026-02-04 - US-E010
- What was implemented: Created StripeWebhook model with migration for logging all received Stripe webhooks
- Files changed:
  - database/migrations/2026_02_04_300008_create_stripe_webhooks_table.php (stripe_webhooks table with all required fields)
  - app/Models/Finance/StripeWebhook.php (full model with immutability enforcement and helper methods)
- **Learnings for future iterations:**
  - StripeWebhook does NOT use HasUuid, Auditable, or SoftDeletes traits - it's an immutable log model
  - Uses standard auto-increment id (not UUID) since it's a log table
  - Sets UPDATED_AT = null to disable updated_at timestamp (logs are immutable)
  - event_id has unique constraint for idempotency when receiving Stripe webhooks
  - Immutability enforced in boot(): deleting throws exception, updating only allows processing status fields
  - Helper methods for payload extraction: getPaymentIntentId(), getChargeId(), getAmount(), getCurrency()
  - Static methods for idempotency: hasEvent(), findByEventId(), createFromStripeEvent()
  - Query scopes: processed(), pending(), failed(), ofType() for filtering
  - Status is inferred from processed boolean + error_message presence (not a separate enum)
---

## 2026-02-04 - US-E011
- What was implemented: Created XeroSyncLog model with migration for logging all Xero synchronization attempts
- Files changed:
  - database/migrations/2026_02_04_300009_create_xero_sync_logs_table.php (xero_sync_logs table with all required fields)
  - app/Models/Finance/XeroSyncLog.php (full model with polymorphic relation, immutability enforcement, and helper methods)
- **Learnings for future iterations:**
  - XeroSyncLog does NOT use HasUuid, Auditable, or SoftDeletes traits - it's an immutable log model
  - Uses standard auto-increment id (not UUID) and sets UPDATED_AT = null (logs are immutable)
  - Polymorphic relation via morphTo() to syncable (Invoice, CreditNote, Payment)
  - Uses XeroSyncType and XeroSyncStatus enums from US-E001
  - Status transitions are validated in boot() updating hook using XeroSyncStatus::canTransitionTo()
  - Helper methods: markSynced(), markFailed(), resetForRetry()
  - Static methods: createForEntity(), getLatestForEntity(), hasSuccessfulSync(), getXeroIdForEntity()
  - Query scopes: pending(), synced(), failed(), ofType(), forSyncable(), retryable()
  - PHPStan: Use `isset($model->attributes['field'])` instead of `$model->field === null` for checking if attribute was set before cast
  - PHPStan: For MorphTo return type use `@return MorphTo<Model, $this>` not specific class names
---

## 2026-02-04 - US-E012
- What was implemented: Created InvoiceService for centralized invoice management
- Files changed:
  - app/Services/Finance/InvoiceService.php (service class with full invoice lifecycle management)
- **Learnings for future iterations:**
  - Finance services go in app/Services/Finance/ directory
  - InvoiceService follows same patterns as VoucherService - methods for lifecycle transitions
  - createDraft() validates source reference requirements based on InvoiceType enum helper methods
  - Idempotency: findBySource() checks for existing invoice before creating duplicate
  - issue() generates sequential invoice_number with format INV-YYYY-NNNNNN
  - applyPayment() creates InvoicePayment and auto-updates invoice status (issued → partially_paid → paid)
  - All methods use DB::transaction() for atomicity
  - Use bcadd(), bcsub(), bccomp() for all decimal calculations
  - Log events to audit trail using model's auditLogs() morphMany relationship
  - Validation throws InvalidArgumentException with descriptive messages
  - TODO comments mark where events should be emitted for downstream modules (Xero sync, InvoicePaid event)
---

## 2026-02-04 - US-E013
- What was implemented: Created InvoiceResource in Filament with list view, filters, search, and status tabs
- Files changed:
  - app/Filament/Resources/Finance/InvoiceResource.php (main resource with table configuration)
  - app/Filament/Resources/Finance/InvoiceResource/Pages/ListInvoices.php (list page with status tabs)
  - app/Filament/Resources/Finance/InvoiceResource/Pages/ViewInvoice.php (basic view page for detail)
- **Learnings for future iterations:**
  - Finance Filament resources go in app/Filament/Resources/Finance/ directory
  - Use Tab::make() with modifyQueryUsing() for list page tabs
  - Badge counts can use closures: badge(fn (): int => Model::where(...)->count())
  - For nullable relationships in CSV export or global search, use explicit null check instead of ?-> with ?? (PHPStan rule)
  - Use ->money(fn ($record) => $record->currency) for dynamic currency formatting
  - Bulk actions for CSV export use response()->streamDownload() with fputcsv()
  - Global search attributes require getGloballySearchableAttributes(), getGlobalSearchResultTitle(), getGlobalSearchResultDetails(), getGlobalSearchResultUrl()
  - Overdue visual indicator uses color() callback on due_date column
---

## 2026-02-04 - US-E014
- What was implemented: Created Invoice Detail view with 5 tabs in Filament
- Files changed:
  - app/Filament/Resources/Finance/InvoiceResource/Pages/ViewInvoice.php (full implementation with tabs)
- **Tabs implemented:**
  - Tab 1 - Lines: Read-only invoice lines with description, qty, unit_price, tax, total
  - Tab 2 - Payments: Applied payments with amount, date, source, reference
  - Tab 3 - Linked ERP Events: Source reference with type and links to source records
  - Tab 4 - Accounting: Xero sync info, statutory invoice number, GL posting, FX rate
  - Tab 5 - Audit: Immutable event timeline using AuditLog model
- **Header section:** invoice_number, type (locked badge), status, customer, currency, totals (subtotal, tax, total, paid, outstanding)
- **Learnings for future iterations:**
  - Use Tabs::make() with persistTabInQueryString() for tabbed ViewRecord pages
  - RepeatableEntry is used for displaying HasMany relations in Infolist
  - For nullable relationships in closures, use explicit null check `$model !== null ? $model->field : 'default'` instead of `$model?->field ?? 'default'` (PHPStan rule)
  - getStateUsing() can be used to compute derived values not stored in the model
  - Use FontWeight::Bold and TextEntry\TextEntrySize::Large for emphasis
  - Badge colors and icons can be dynamically set using closures with model/enum state
  - Section::make() supports ->collapsed() and ->collapsible() for optional sections
---

## 2026-02-04 - US-E015
- What was implemented: Added contextual actions to Invoice Detail view based on invoice status
- Files changed:
  - app/Filament/Resources/Finance/InvoiceResource/Pages/ViewInvoice.php (added getHeaderActions with 4 contextual actions)
- **Actions implemented:**
  - Issue Invoice: visible only when status = draft, calls InvoiceService::issue()
  - Record Bank Payment: visible when status = issued or partially_paid, form with amount/reference/date (placeholder for US-E056)
  - Create Credit Note: visible when status = issued, paid, or partially_paid, form with amount/reason (placeholder for US-E065)
  - Cancel Invoice: visible only when status = draft, calls InvoiceService::cancel()
- **All actions require confirmation via modal**
- **Learnings for future iterations:**
  - Use Action::make() with ->visible(fn () => $condition) for contextual visibility
  - Use ->requiresConfirmation() for dangerous actions that need user confirmation
  - ->modalDescription() supports callable to show dynamic content based on record
  - ->form([]) allows adding input fields to action modals
  - Use separate protected methods (getIssueAction, etc.) to keep getHeaderActions() clean
  - Use app(ServiceClass::class) to resolve services in action callbacks
  - Use Notification::make() for success/error feedback after actions
  - $this->refreshFormData(['field1', 'field2']) refreshes specific fields after action
  - Placeholder actions with warning notifications allow implementing UI patterns before backend services are ready
---

## 2026-02-04 - US-E016
- What was implemented: Verified Invoice issuance flow - all functionality already implemented in prior stories
- Files verified (no changes needed):
  - app/Services/Finance/InvoiceService.php (issue() method with all validations)
  - app/Models/Finance/Invoice.php (immutability enforcement)
  - app/Models/Finance/InvoiceLine.php (post-issuance immutability)
- **Acceptance criteria verification:**
  - ✅ Invoice number generation: INV-YYYY-NNNNNN format in generateInvoiceNumber() method
  - ✅ issued_at = now(): Set in issue() method
  - ✅ Validation: at least one invoice line present: Checked before issuance
  - ✅ Validation: total_amount > 0: Checked with bccomp()
  - ✅ Post-issuance lines immutable: InvoiceLine boot() updating/deleting hooks
  - ✅ Post-issuance Xero sync trigger: TODO placeholder for US-E098
  - ✅ Audit log: logInvoiceEvent() with status change details
- **Learnings for future iterations:**
  - US-E016 validates functionality already built in US-E002, US-E003, US-E012, US-E015
  - When a story's acceptance criteria are already met by prior implementations, verify and document rather than duplicate code
  - Xero sync trigger is a TODO placeholder until US-E098 implements the actual integration
---

## 2026-02-04 - US-E017
- What was implemented: Created comprehensive test suite for Invoice immutability enforcement
- Files changed:
  - tests/Unit/Models/Finance/InvoiceImmutabilityTest.php (new file - 16 test methods)
- **Acceptance criteria verification:**
  - ✅ invoice_type cannot be modified EVER: Already enforced in Invoice model boot() hook (created US-E002)
  - ✅ invoice_lines cannot be modified after status != draft: Already enforced in InvoiceLine model boot() hook (created US-E003)
  - ✅ subtotal, tax_amount, total_amount cannot be modified after issuance: Already enforced in Invoice model boot() hook (created US-E002)
  - ✅ Attempt to modify throws explicit exception: InvalidArgumentException with descriptive messages
  - ✅ UI hides edit fields for issued invoices: ViewInvoice uses read-only Infolist (no Form edit), InvoiceResource has no Edit page
  - ✅ Test that verifies immutability: InvoiceImmutabilityTest.php with 16 test cases
  - ✅ Typecheck passes: phpstan and pint both pass
- **Learnings for future iterations:**
  - Finance immutability tests go in tests/Unit/Models/Finance/ directory
  - Test pattern: Use expectException() before the action that should throw
  - Invoice/InvoiceLine immutability was already implemented in US-E002/US-E003, tests validate that behavior
  - Pre-existing migration issue with SQLite (MODIFY COLUMN syntax) blocks all RefreshDatabase tests - unrelated to Finance module
  - canBeEdited() helper methods on models should be tested to ensure UI helpers work correctly
---

## 2026-02-04 - US-E018
- What was implemented: Created manual invoice creation wizard in Filament
- Files changed:
  - app/Filament/Resources/Finance/InvoiceResource/Pages/CreateInvoice.php (new file - wizard-based create form)
  - app/Filament/Resources/Finance/InvoiceResource.php (registered CreateInvoice page)
- **Acceptance criteria verification:**
  - ✅ Create Invoice form with: customer (select), invoice_type (select), currency, due_date, notes
  - ✅ Step 2: add lines with description, quantity, unit_price, tax_rate
  - ✅ Tax amount calculated automatically based on tax rate
  - ✅ Totals calculated in real-time (subtotal, tax, total displayed dynamically)
  - ✅ Warning: Manual invoices should be exceptional - prominent warning banner in step 1
  - ✅ Save as draft (requires Issue to activate) - creates draft invoice, notification guides user to Issue
  - ✅ Typecheck passes: phpstan and pint both pass
- **Learnings for future iterations:**
  - Wizard-based create pages use CreateRecord\Concerns\HasWizard trait
  - Use Repeater component for dynamic line items with live() validation
  - Real-time totals use Placeholder with Get $get to read repeater state
  - Access parent form state from repeater with $get('../../fieldName')
  - Customer search uses getSearchResultsUsing() for async search
  - After create, manually handle invoice_lines via afterCreate() since repeater data isn't model-bound
  - bcmul/bcadd/bcdiv for all decimal calculations to maintain precision
---

## 2026-02-04 - US-E019
- What was implemented: Invoice PDF generation using barryvdh/laravel-dompdf
- Files changed:
  - app/Services/Finance/InvoicePdfService.php (new service for PDF generation)
  - resources/views/pdf/invoices/invoice.blade.php (new PDF template)
  - app/Filament/Resources/Finance/InvoiceResource/Pages/ViewInvoice.php (added Download PDF action)
  - composer.json/composer.lock (added barryvdh/laravel-dompdf dependency)
- **Acceptance criteria verification:**
  - ✅ Action Download PDF visible for issued/paid invoices: getDownloadPdfAction() with canGeneratePdf() check
  - ✅ PDF includes header, invoice details, lines table, totals, payment info, footer
  - ✅ Template compliant with fiscal requirements: includes VAT numbers, company registration, legal info
  - ✅ Filename: {invoice_number}.pdf: getFilename() method returns sanitized invoice number
  - ✅ Typecheck passes: phpstan and pint both pass
- **Learnings for future iterations:**
  - Use barryvdh/laravel-dompdf for simple PDF generation in Laravel
  - PDF templates go in resources/views/pdf/{entity}/ directory
  - InvoicePdfService provides generate(), download(), stream(), getContent() methods for flexibility
  - canGeneratePdf() helper method controls visibility of Download PDF action
  - Use ALLOWED_STATUSES constant to define which invoice statuses support PDF generation
  - Eager load relationships (customer, invoiceLines) before generating PDF for performance
  - Sanitize invoice numbers for filenames using preg_replace()
---

## 2026-02-04 - US-E020
- What was implemented: Invoice email sending functionality
- Files changed:
  - app/Mail/Finance/InvoiceMail.php (new Mailable class with PDF attachment)
  - app/Services/Finance/InvoiceMailService.php (new service for email sending)
  - resources/views/emails/finance/invoice.blade.php (new email template)
  - app/Filament/Resources/Finance/InvoiceResource/Pages/ViewInvoice.php (added Send to Customer action)
- **Acceptance criteria verification:**
  - ✅ Action Send to Customer visible for issued invoices: getSendToCustomerAction() with canSendEmail() check
  - ✅ Email includes PDF attachment: InvoiceMail::attachments() uses InvoicePdfService
  - ✅ Configurable email template: supports custom_subject and custom_message via form fields
  - ✅ Log sending in audit trail: logEmailSent() creates audit log entry
  - ✅ Typecheck passes: phpstan and pint both pass
- **Learnings for future iterations:**
  - Create Mailable classes in app/Mail/{Module}/ directory
  - InvoiceMail implements ShouldQueue for async email sending
  - Use Attachment::fromData() for dynamically generated content (PDF)
  - Email templates go in resources/views/emails/{module}/ directory
  - Service provides both sendToCustomer() and queueToCustomer() methods for sync/async
  - canSendEmail() checks: status, invoice_number presence, customer email presence
  - Audit logging uses 'email_sent' or 'email_queued' events with recipient info
---

## 2026-02-04 - US-E021
- What was implemented: Overdue invoice detection system
- Files changed:
  - app/Jobs/Finance/IdentifyOverdueInvoicesJob.php (new scheduled job to identify and log overdue invoices)
  - app/Models/Finance/Invoice.php (added is_overdue attribute, getDaysOverdue(), scopeOverdue(), scopeNotOverdue())
  - app/Filament/Resources/Finance/InvoiceResource.php (added Overdue Status ternary filter)
  - routes/console.php (scheduled IdentifyOverdueInvoicesJob to run daily at 8:00 AM)
- **Learnings for future iterations:**
  - Finance jobs go in app/Jobs/Finance/ directory
  - Schedule jobs in routes/console.php using Schedule::job()->dailyAt() for daily jobs
  - Overdue detection already had partial implementation from US-E013 (Overdue tab, due_date color, Flags column)
  - Add query scopes to models for reusable query logic (scopeOverdue(), scopeNotOverdue())
  - PHPStan doesn't auto-recognize Laravel scopes - add @method docblocks or use inline queries
  - TernaryFilter::make() with queries() is useful for boolean-like filtering
  - Log channel 'finance' should be used for financial logging (ensure config/logging.php defines it)
  - Use getIsOverdueAttribute() to create computed properties accessible as $model->is_overdue
---

## 2026-02-04 - US-E022
- What was implemented: Invoice currency handling with FX rate snapshot at issuance
- Files changed:
  - database/migrations/2026_02_04_300010_add_fx_rate_to_invoices_table.php (new migration for fx_rate_at_issuance field)
  - app/Models/Finance/Invoice.php (added fx_rate_at_issuance field, currency helper methods, immutability enforcement)
  - app/Services/Finance/InvoiceService.php (added FX rate capture at issuance, currency validation)
  - app/Filament/Resources/Finance/InvoiceResource.php (updated currency filter to use model's getSupportedCurrencies())
  - app/Filament/Resources/Finance/InvoiceResource/Pages/ViewInvoice.php (updated currency display with symbol, FX rate section)
  - app/Filament/Resources/Finance/InvoiceResource/Pages/CreateInvoice.php (updated currency select to use model's supported currencies)
- **Acceptance criteria verification:**
  - ✅ Currency field required (default EUR): Already enforced in model defaults
  - ✅ Currency not modifiable after issuance: Enforced in Invoice boot() updating hook
  - ✅ All amounts in same currency: Enforced by single currency per invoice, no multi-currency line items
  - ✅ Exchange rate snapshot at issuance: fx_rate_at_issuance captured in InvoiceService::issue()
  - ✅ UI shows currency symbol/code: Added getCurrencySymbol(), formatAmount() methods and updated UI
  - ✅ Typecheck passes: PHPStan and Pint both pass
- **Learnings for future iterations:**
  - Use getSupportedCurrencies() static method on models to centralize currency list
  - FX rate is stub implementation - production should integrate with external FX rate provider
  - Use decimal(10,6) precision for FX rates to handle currencies like JPY
  - Currency immutability is enforced alongside amounts after issuance in boot() hook
  - isBaseCurrency() helper checks if invoice is in EUR (base currency)
  - hasFxRate() and getFxRateDescription() helpers for UI display logic
---

## 2026-02-04 - US-E023
- What was implemented: Invoice due date management - enforced immutability after issuance and added helper methods
- Files changed:
  - app/Models/Finance/Invoice.php (added due_date to immutable fields, added helper methods)
- **Acceptance criteria verification:**
  - ✅ Due date required for non-immediate invoices (INV0, INV3): Already enforced in InvoiceType.requiresDueDate() and InvoiceService.issue()
  - ✅ Due date optional for INV1, INV2, INV4 (immediate payment): Already defined in InvoiceType.requiresDueDate()
  - ✅ Default due date: +30 days from issuance (configurable per type): Already implemented in InvoiceType.defaultDueDateDays() and InvoiceService.issue()
  - ✅ Due date modifiable only in draft: Added due_date to immutableAfterIssuance list in Invoice boot() hook
  - ✅ Typecheck passes: PHPStan and Pint both pass
- **Learnings for future iterations:**
  - Much of due date management was already implemented in prior stories (US-E001, US-E012, US-E018)
  - Due date immutability should be enforced alongside other amounts in the boot() updating hook
  - Helper methods like canModifyDueDate(), requiresDueDate(), expectsImmediatePayment() provide clean API for UI/service use
  - InvoiceType enum contains the business rules; Invoice model delegates to enum for due date requirements
---
