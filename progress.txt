# Ralph Progress Log
Started: Wed Feb  4 10:35:15 CET 2026

## Codebase Patterns
- UUID primary keys: Use `$table->uuid('id')->primary()` in migrations and `HasUuid` trait in models
- FK to users: Use `$table->foreignId()` (integer) NOT `foreignUuid()` since users table uses integer IDs
- Morphic relationships: Use explicit key names `morphTo('product_reference')` with TWO migration columns: `_type` (string) and `_id` (uuid)
- Soft deletes: Always include `$table->softDeletes()` in migrations and `use SoftDeletes;` trait in models
- Audit fields: Include `created_by`, `updated_by` FKs and use `Auditable` trait
- Enums: String-backed PHP 8.1+ enums in `app/Enums/{Module}/` with `label()`, `color()`, `icon()` methods
- Models: Organized by module in `app/Models/{Module}/`
- Invariant enforcement: Use `boot()` method with `static::saving()` callback

---

## 2026-02-04 - US-001
- What was implemented:
  - Migration `2026_02_04_400001_create_procurement_intents_table.php` with all required fields
  - ProcurementIntent model with morphic relationship to SellableSku/LiquidProduct
  - Three enums: ProcurementTriggerType, SourcingModel, ProcurementIntentStatus
  - Quantity > 0 invariant enforced in boot() method
  - Soft deletes enabled
- Files changed:
  - database/migrations/2026_02_04_400001_create_procurement_intents_table.php (new)
  - app/Models/Procurement/ProcurementIntent.php (new)
  - app/Enums/Procurement/ProcurementTriggerType.php (new)
  - app/Enums/Procurement/SourcingModel.php (new)
  - app/Enums/Procurement/ProcurementIntentStatus.php (new)
- **Learnings for future iterations:**
  - BottleSku in PRD maps to SellableSku model in codebase
  - Morphic relationships need `instanceof` checks before accessing type-specific properties (PHPStan requirement)
  - Use `product_reference_type = 'sellable_skus'` or `'liquid_products'` for the morphic type column
---

## 2026-02-04 - US-002
- What was implemented:
  - Six new enums for Procurement module (3 already existed from US-001)
  - PurchaseOrderStatus: draft, sent, confirmed, closed
  - BottlingPreferenceStatus: pending, partial, complete, defaulted
  - BottlingInstructionStatus: draft, active, executed
  - InboundPackaging: cases, loose, mixed
  - OwnershipFlag: owned, in_custody, pending
  - InboundStatus: recorded, routed, completed
  - All enums follow established pattern with label(), color(), icon() methods
  - Status enums include allowedTransitions() and canTransitionTo() helpers
- Files changed:
  - app/Enums/Procurement/PurchaseOrderStatus.php (new)
  - app/Enums/Procurement/BottlingPreferenceStatus.php (new)
  - app/Enums/Procurement/BottlingInstructionStatus.php (new)
  - app/Enums/Procurement/InboundPackaging.php (new)
  - app/Enums/Procurement/OwnershipFlag.php (new)
  - app/Enums/Procurement/InboundStatus.php (new)
- **Learnings for future iterations:**
  - Enums with status transitions should include `allowedTransitions()` and `canTransitionTo()` methods
  - Include domain-specific helper methods (e.g., `OwnershipFlag::isClarified()`, `InboundStatus::allowsHandOff()`)
  - BottlingPreferenceStatus tracks customer preference collection and supports defaulting
---

## 2026-02-04 - US-003
- What was implemented:
  - Migration `2026_02_04_400003_create_purchase_orders_table.php` with all required fields
  - PurchaseOrder model with relationships to ProcurementIntent and Party (supplier)
  - Morphic relationship to product reference (SellableSku or LiquidProduct)
  - FK constraint: `procurement_intent_id` NOT NULL enforced at DB level
  - Invariant check in `boot()` method for early feedback
  - Added `purchaseOrders()` hasMany relationship to ProcurementIntent model
  - Soft deletes enabled
- Files changed:
  - database/migrations/2026_02_04_400003_create_purchase_orders_table.php (new)
  - app/Models/Procurement/PurchaseOrder.php (new)
  - app/Models/Procurement/ProcurementIntent.php (modified - added purchaseOrders relationship)
- **Learnings for future iterations:**
  - Use `foreignUuid()` for FK to other UUID-based tables (parties, procurement_intents)
  - Use `foreignId()` for FK to users (integer IDs)
  - PurchaseOrder requires ProcurementIntent - this invariant is enforced at both DB and model levels
---

## 2026-02-04 - US-004
- What was implemented:
  - Migration `2026_02_04_400004_create_bottling_instructions_table.php` with all required fields
  - BottlingInstruction model with relationships to ProcurementIntent and LiquidProduct
  - All required fields: bottle_equivalents, allowed_formats (JSON), allowed_case_configurations (JSON), default_bottling_rule, bottling_deadline, preference_status, personalised_bottling_required, early_binding_required, delivery_location, status, defaults_applied_at
  - FK constraint: `procurement_intent_id` required (NOT NULL enforced at DB level)
  - FK constraint: `liquid_product_id` required
  - Invariant check in `boot()` method for bottling_deadline required
  - Added `bottlingInstructions()` hasMany relationship to ProcurementIntent model
  - Soft deletes enabled
- Files changed:
  - database/migrations/2026_02_04_400004_create_bottling_instructions_table.php (new)
  - app/Models/Procurement/BottlingInstruction.php (new)
  - app/Models/Procurement/ProcurementIntent.php (modified - added bottlingInstructions relationship)
- **Learnings for future iterations:**
  - JSON fields use `$table->json()` in migration and `'array'` cast in model
  - For required date fields, check raw attributes in boot() to avoid PHPStan issues with Carbon casting
  - BottlingInstruction uses BottlingInstructionStatus for lifecycle and BottlingPreferenceStatus for preference collection tracking
  - Deadline urgency helper methods useful for UI display (getDeadlineUrgency, getDaysUntilDeadline)
---

## 2026-02-04 - US-005
- What was implemented:
  - Migration `2026_02_04_400005_create_inbounds_table.php` with all required fields
  - Inbound model with relationships to ProcurementIntent (optional) and PurchaseOrder (optional)
  - Morphic relationship to product reference (SellableSku or LiquidProduct)
  - All required fields: warehouse, quantity, packaging, ownership_flag, received_date, condition_notes, serialization_required, serialization_location_authorized, serialization_routing_rule, status, handed_to_module_b, handed_to_module_b_at
  - FK constraints: both procurement_intent_id and purchase_order_id are nullable (inbound can exist without intent but is flagged)
  - Ownership flag defaults to 'pending' - explicit that Inbound does NOT imply ownership
  - Added `inbounds()` hasMany relationship to ProcurementIntent and PurchaseOrder models
  - Soft deletes enabled
- Files changed:
  - database/migrations/2026_02_04_400005_create_inbounds_table.php (new)
  - app/Models/Procurement/Inbound.php (new)
  - app/Models/Procurement/ProcurementIntent.php (modified - added inbounds relationship)
  - app/Models/Procurement/PurchaseOrder.php (modified - added inbounds relationship)
- **Learnings for future iterations:**
  - Inbound is a "physical fact" entity - it records that goods arrived, NOT that we own them
  - Use nullable FKs when the relationship is optional but should still be flagged as "unlinked"
  - Helper methods like `isLinked()`, `isUnlinked()`, `hasOwnershipClarity()` are useful for business rule enforcement
  - The `canHandOffToModuleB()` method consolidates multiple preconditions (status, ownership clarity, not already handed off)
---

## 2026-02-04 - US-006
- What was implemented:
  - Migration `2026_02_04_400006_create_producer_supplier_configs_table.php` with all required fields
  - ProducerSupplierConfig model with one-to-one relationship to Party
  - All required fields: party_id (unique FK), default_bottling_deadline_days (int nullable), allowed_formats (JSON nullable), serialization_constraints (JSON nullable), notes (text nullable)
  - Unique constraint on party_id enforces one-to-one relationship
  - Added `supplierConfig()` hasOne relationship to Party model
  - Added `hasSupplierConfig()` helper method to Party model
  - Soft deletes enabled
- Files changed:
  - database/migrations/2026_02_04_400006_create_producer_supplier_configs_table.php (new)
  - app/Models/Procurement/ProducerSupplierConfig.php (new)
  - app/Models/Customer/Party.php (modified - added supplierConfig relationship)
- **Learnings for future iterations:**
  - One-to-one relationships use `$table->foreignUuid()->unique()` in migration
  - Optional one-to-one configs don't need invariants - they're simply created when needed
  - Helper methods for checking constraint satisfaction (isFormatAllowed, isSerializationLocationAuthorized) are useful for service layer
  - JSON fields with specific structures should document expected format in docblock
---
