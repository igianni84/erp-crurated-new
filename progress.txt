# Ralph Progress Log
Started: Wed Feb  4 20:45:58 CET 2026

## Codebase Patterns
- Enums use PHP 8.1+ backed enums with string values
- Each enum includes label(), color(), icon() methods for Filament compatibility
- Status enums include allowedTransitions() and canTransitionTo() for state machine behavior
- Enums are organized in subdirectories by module: app/Enums/{ModuleName}/
- Use match expressions for enum method implementations
- Finance models use HasUuid, Auditable, SoftDeletes traits
- Finance models are in app/Models/Finance/ directory
- Immutability enforcement: use isDirty() in boot() static::updating() hook, throw InvalidArgumentException
- Currency calculations: use bcsub()/bccomp() for precision, cast as 'decimal:2'

---

## 2026-02-04 - US-E001
- What was implemented: Created 15 Finance enums for the ERP financial module
- Files changed:
  - app/Enums/Finance/InvoiceType.php (INV0-INV4 with codes, labels, icons, and source requirements)
  - app/Enums/Finance/InvoiceStatus.php (draft, issued, paid, partially_paid, credited, cancelled)
  - app/Enums/Finance/PaymentSource.php (stripe, bank_transfer)
  - app/Enums/Finance/PaymentStatus.php (pending, confirmed, failed, refunded)
  - app/Enums/Finance/ReconciliationStatus.php (pending, matched, mismatched)
  - app/Enums/Finance/CreditNoteStatus.php (draft, issued, applied)
  - app/Enums/Finance/RefundType.php (full, partial)
  - app/Enums/Finance/RefundMethod.php (stripe, bank_transfer)
  - app/Enums/Finance/RefundStatus.php (pending, processed, failed)
  - app/Enums/Finance/SubscriptionPlanType.php (membership, service)
  - app/Enums/Finance/BillingCycle.php (monthly, quarterly, annual)
  - app/Enums/Finance/SubscriptionStatus.php (active, suspended, cancelled)
  - app/Enums/Finance/StorageBillingStatus.php (pending, invoiced, paid, blocked)
  - app/Enums/Finance/XeroSyncType.php (invoice, credit_note, payment)
  - app/Enums/Finance/XeroSyncStatus.php (pending, synced, failed)
- **Learnings for future iterations:**
  - InvoiceType enum includes helper methods like requiresSourceReference(), requiresDueDate(), defaultDueDateDays() and expectedSourceType() to encapsulate business logic
  - Status enums should include helper methods for checking if certain operations are allowed (e.g., allowsEditing(), allowsPayment())
  - BillingCycle includes months() method for date calculations
  - ReconciliationStatus has allowsBusinessEvents() method - only matched payments trigger downstream events
---

## 2026-02-04 - US-E002
- What was implemented: Created Invoice model with migration and stub models for related entities
- Files changed:
  - database/migrations/2026_02_04_300000_create_invoices_table.php (invoices table with all required fields)
  - app/Models/Finance/Invoice.php (full model with relationships, immutability constraints, and helper methods)
  - app/Models/Finance/InvoiceLine.php (stub for relationship to pass typecheck)
  - app/Models/Finance/InvoicePayment.php (stub for relationship to pass typecheck)
  - app/Models/Finance/CreditNote.php (stub for relationship to pass typecheck)
- **Learnings for future iterations:**
  - Finance models go in app/Models/Finance/ directory
  - Use HasUuid, Auditable, SoftDeletes traits consistently for Finance models
  - Immutability enforcement uses isDirty() checks in boot() static::updating() hook
  - invoice_type is immutable from creation (throws InvalidArgumentException if changed)
  - After issuance (status != draft), amounts and currency become immutable
  - Create stub models for forward-referenced relationships to allow typecheck to pass
  - Use bcsub() and bccomp() for currency calculations to avoid floating point issues
  - The concat_space linter rule requires no spaces around string concatenation dots
---

## 2026-02-04 - US-E003
- What was implemented: Created InvoiceLine model with migration, relationships, and immutability enforcement
- Files changed:
  - database/migrations/2026_02_04_300001_create_invoice_lines_table.php (invoice_lines table with all required fields including FK to sellable_skus)
  - app/Models/Finance/InvoiceLine.php (full model replacing stub, with relationships, calculations, and immutability constraints)
- **Learnings for future iterations:**
  - InvoiceLine uses auto-calculated line_total in saving hook: (quantity * unit_price) + tax_amount
  - Use bcmul()/bcadd()/bcdiv() for all decimal calculations to maintain precision
  - Immutability on child models must check parent's status (invoice.status !== Draft) in updating and deleting hooks
  - InvoiceLine does NOT use HasUuid, Auditable, or SoftDeletes - only simple id
  - PHPStan requires explicit null checks instead of nullsafe operator (?->) when used with null coalescing (??)
  - Helper method recalculateTax() can be used to auto-compute tax_amount from tax_rate
---
