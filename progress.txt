# Ralph Progress Log
Started: Wed Feb  4 10:35:15 CET 2026

## Codebase Patterns
- UUID primary keys: Use `$table->uuid('id')->primary()` in migrations and `HasUuid` trait in models
- FK to users: Use `$table->foreignId()` (integer) NOT `foreignUuid()` since users table uses integer IDs
- Morphic relationships: Use explicit key names `morphTo('product_reference')` with TWO migration columns: `_type` (string) and `_id` (uuid)
- Soft deletes: Always include `$table->softDeletes()` in migrations and `use SoftDeletes;` trait in models
- Audit fields: Include `created_by`, `updated_by` FKs and use `Auditable` trait
- Enums: String-backed PHP 8.1+ enums in `app/Enums/{Module}/` with `label()`, `color()`, `icon()` methods
- Models: Organized by module in `app/Models/{Module}/`
- Invariant enforcement: Use `boot()` method with `static::saving()` callback
- Filament resources: Organized by module in `app/Filament/Resources/{Module}/`, use navigation groups, Pages subdirectory for List/View/Create pages

---

## 2026-02-04 - US-001
- What was implemented:
  - Migration `2026_02_04_400001_create_procurement_intents_table.php` with all required fields
  - ProcurementIntent model with morphic relationship to SellableSku/LiquidProduct
  - Three enums: ProcurementTriggerType, SourcingModel, ProcurementIntentStatus
  - Quantity > 0 invariant enforced in boot() method
  - Soft deletes enabled
- Files changed:
  - database/migrations/2026_02_04_400001_create_procurement_intents_table.php (new)
  - app/Models/Procurement/ProcurementIntent.php (new)
  - app/Enums/Procurement/ProcurementTriggerType.php (new)
  - app/Enums/Procurement/SourcingModel.php (new)
  - app/Enums/Procurement/ProcurementIntentStatus.php (new)
- **Learnings for future iterations:**
  - BottleSku in PRD maps to SellableSku model in codebase
  - Morphic relationships need `instanceof` checks before accessing type-specific properties (PHPStan requirement)
  - Use `product_reference_type = 'sellable_skus'` or `'liquid_products'` for the morphic type column
---

## 2026-02-04 - US-002
- What was implemented:
  - Six new enums for Procurement module (3 already existed from US-001)
  - PurchaseOrderStatus: draft, sent, confirmed, closed
  - BottlingPreferenceStatus: pending, partial, complete, defaulted
  - BottlingInstructionStatus: draft, active, executed
  - InboundPackaging: cases, loose, mixed
  - OwnershipFlag: owned, in_custody, pending
  - InboundStatus: recorded, routed, completed
  - All enums follow established pattern with label(), color(), icon() methods
  - Status enums include allowedTransitions() and canTransitionTo() helpers
- Files changed:
  - app/Enums/Procurement/PurchaseOrderStatus.php (new)
  - app/Enums/Procurement/BottlingPreferenceStatus.php (new)
  - app/Enums/Procurement/BottlingInstructionStatus.php (new)
  - app/Enums/Procurement/InboundPackaging.php (new)
  - app/Enums/Procurement/OwnershipFlag.php (new)
  - app/Enums/Procurement/InboundStatus.php (new)
- **Learnings for future iterations:**
  - Enums with status transitions should include `allowedTransitions()` and `canTransitionTo()` methods
  - Include domain-specific helper methods (e.g., `OwnershipFlag::isClarified()`, `InboundStatus::allowsHandOff()`)
  - BottlingPreferenceStatus tracks customer preference collection and supports defaulting
---

## 2026-02-04 - US-003
- What was implemented:
  - Migration `2026_02_04_400003_create_purchase_orders_table.php` with all required fields
  - PurchaseOrder model with relationships to ProcurementIntent and Party (supplier)
  - Morphic relationship to product reference (SellableSku or LiquidProduct)
  - FK constraint: `procurement_intent_id` NOT NULL enforced at DB level
  - Invariant check in `boot()` method for early feedback
  - Added `purchaseOrders()` hasMany relationship to ProcurementIntent model
  - Soft deletes enabled
- Files changed:
  - database/migrations/2026_02_04_400003_create_purchase_orders_table.php (new)
  - app/Models/Procurement/PurchaseOrder.php (new)
  - app/Models/Procurement/ProcurementIntent.php (modified - added purchaseOrders relationship)
- **Learnings for future iterations:**
  - Use `foreignUuid()` for FK to other UUID-based tables (parties, procurement_intents)
  - Use `foreignId()` for FK to users (integer IDs)
  - PurchaseOrder requires ProcurementIntent - this invariant is enforced at both DB and model levels
---

## 2026-02-04 - US-004
- What was implemented:
  - Migration `2026_02_04_400004_create_bottling_instructions_table.php` with all required fields
  - BottlingInstruction model with relationships to ProcurementIntent and LiquidProduct
  - All required fields: bottle_equivalents, allowed_formats (JSON), allowed_case_configurations (JSON), default_bottling_rule, bottling_deadline, preference_status, personalised_bottling_required, early_binding_required, delivery_location, status, defaults_applied_at
  - FK constraint: `procurement_intent_id` required (NOT NULL enforced at DB level)
  - FK constraint: `liquid_product_id` required
  - Invariant check in `boot()` method for bottling_deadline required
  - Added `bottlingInstructions()` hasMany relationship to ProcurementIntent model
  - Soft deletes enabled
- Files changed:
  - database/migrations/2026_02_04_400004_create_bottling_instructions_table.php (new)
  - app/Models/Procurement/BottlingInstruction.php (new)
  - app/Models/Procurement/ProcurementIntent.php (modified - added bottlingInstructions relationship)
- **Learnings for future iterations:**
  - JSON fields use `$table->json()` in migration and `'array'` cast in model
  - For required date fields, check raw attributes in boot() to avoid PHPStan issues with Carbon casting
  - BottlingInstruction uses BottlingInstructionStatus for lifecycle and BottlingPreferenceStatus for preference collection tracking
  - Deadline urgency helper methods useful for UI display (getDeadlineUrgency, getDaysUntilDeadline)
---

## 2026-02-04 - US-005
- What was implemented:
  - Migration `2026_02_04_400005_create_inbounds_table.php` with all required fields
  - Inbound model with relationships to ProcurementIntent (optional) and PurchaseOrder (optional)
  - Morphic relationship to product reference (SellableSku or LiquidProduct)
  - All required fields: warehouse, quantity, packaging, ownership_flag, received_date, condition_notes, serialization_required, serialization_location_authorized, serialization_routing_rule, status, handed_to_module_b, handed_to_module_b_at
  - FK constraints: both procurement_intent_id and purchase_order_id are nullable (inbound can exist without intent but is flagged)
  - Ownership flag defaults to 'pending' - explicit that Inbound does NOT imply ownership
  - Added `inbounds()` hasMany relationship to ProcurementIntent and PurchaseOrder models
  - Soft deletes enabled
- Files changed:
  - database/migrations/2026_02_04_400005_create_inbounds_table.php (new)
  - app/Models/Procurement/Inbound.php (new)
  - app/Models/Procurement/ProcurementIntent.php (modified - added inbounds relationship)
  - app/Models/Procurement/PurchaseOrder.php (modified - added inbounds relationship)
- **Learnings for future iterations:**
  - Inbound is a "physical fact" entity - it records that goods arrived, NOT that we own them
  - Use nullable FKs when the relationship is optional but should still be flagged as "unlinked"
  - Helper methods like `isLinked()`, `isUnlinked()`, `hasOwnershipClarity()` are useful for business rule enforcement
  - The `canHandOffToModuleB()` method consolidates multiple preconditions (status, ownership clarity, not already handed off)
---

## 2026-02-04 - US-006
- What was implemented:
  - Migration `2026_02_04_400006_create_producer_supplier_configs_table.php` with all required fields
  - ProducerSupplierConfig model with one-to-one relationship to Party
  - All required fields: party_id (unique FK), default_bottling_deadline_days (int nullable), allowed_formats (JSON nullable), serialization_constraints (JSON nullable), notes (text nullable)
  - Unique constraint on party_id enforces one-to-one relationship
  - Added `supplierConfig()` hasOne relationship to Party model
  - Added `hasSupplierConfig()` helper method to Party model
  - Soft deletes enabled
- Files changed:
  - database/migrations/2026_02_04_400006_create_producer_supplier_configs_table.php (new)
  - app/Models/Procurement/ProducerSupplierConfig.php (new)
  - app/Models/Customer/Party.php (modified - added supplierConfig relationship)
- **Learnings for future iterations:**
  - One-to-one relationships use `$table->foreignUuid()->unique()` in migration
  - Optional one-to-one configs don't need invariants - they're simply created when needed
  - Helper methods for checking constraint satisfaction (isFormatAllowed, isSerializationLocationAuthorized) are useful for service layer
  - JSON fields with specific structures should document expected format in docblock
---

## 2026-02-04 - US-007
- What was implemented:
  - ProcurementIntentService class in app/Services/Procurement/
  - createFromVoucherSale(Voucher $voucher): Creates draft intent from voucher with voucher_driven trigger type
  - createFromAllocation(Allocation $allocation, int $quantity): Creates draft intent from allocation with allocation_driven trigger type
  - createManual(array $data): Creates draft intent manually with strategic trigger type
  - approve(ProcurementIntent $intent): Transitions draft → approved with approval timestamp and user
  - markExecuted(ProcurementIntent $intent): Transitions approved → executed
  - close(ProcurementIntent $intent): Transitions executed → closed with linked objects validation
  - canClose(ProcurementIntent $intent): Returns array with can_close flag and list of pending items
  - inferSourcingModelFromAllocation(): Helper to map AllocationSourceType to SourcingModel
  - All methods use explicit exceptions for validation errors
  - Audit logging for creation and status transitions
- Files changed:
  - app/Services/Procurement/ProcurementIntentService.php (new)
- **Learnings for future iterations:**
  - Services follow AllocationService pattern: methods return the modified model, throw InvalidArgumentException for errors
  - Use `getAttribute()` for nullable FK fields to avoid PHPStan type issues
  - AllocationSourceType enum values: producer_allocation, owned_stock, passive_consignment, third_party_custody
  - Match on enum cases directly instead of ->value when PHPStan has full type info
  - canClose() returns a structured array for UI to show pending items before closure attempt
---

## 2026-02-04 - US-008
- What was implemented:
  - InboundService class in app/Services/Procurement/
  - record(array $data): Creates Inbound in status recorded with full validation
  - route(Inbound $inbound, string $location): Transitions recorded → routed, sets serialization_location_authorized
  - complete(Inbound $inbound): Transitions routed → completed, validates ownership clarity
  - handOffToModuleB(Inbound $inbound): Marks handed_to_module_b = true with timestamp, validates preconditions
  - validateOwnershipClarity(Inbound $inbound): Throws if ownership_flag == pending
  - validateSerializationRouting(Inbound $inbound): Validates location is set when serialization_required = true
  - updateOwnershipFlag(Inbound $inbound, OwnershipFlag $newFlag): Helper to update ownership with audit
  - All methods use explicit InvalidArgumentException for validation errors
  - Audit logging for creation, status transitions, hand-off, and ownership updates
- Files changed:
  - app/Services/Procurement/InboundService.php (new)
- **Learnings for future iterations:**
  - InboundService follows same pattern as ProcurementIntentService
  - Hand-off to Module B is a one-way operation - cannot be reversed
  - Ownership clarity is required before completing or handing off
  - Serialization routing validation is a placeholder for future ProducerSupplierConfig.serialization_constraints integration
  - AuditLog::EVENT_FLAG_CHANGE is appropriate for boolean flag changes (handed_to_module_b, ownership_flag)
---

## 2026-02-04 - US-009
- What was implemented:
  - ProcurementIntentResource in Filament under navigation group "Procurement"
  - List columns: intent_id, product (via getProductLabel()), quantity, trigger_type, sourcing_model, preferred_location, status, linked_objects_count (badge), awaiting_action (icon), updated_at
  - Filters: status (with closed hidden by default), trigger_type, sourcing_model, trashed
  - Search: intent_id searchable directly, product searchable via complex multi-table query (sellable_skus, liquid_products, wine_masters)
  - Closed intents hidden by default via status filter defaulting to [draft, approved, executed]
  - Visual indicator (warning icon) for intents without linked objects that need action
  - ListProcurementIntents page with Create action
  - ViewProcurementIntent page (placeholder for US-014 detail tabs)
- Files changed:
  - app/Filament/Resources/Procurement/ProcurementIntentResource.php (new)
  - app/Filament/Resources/Procurement/ProcurementIntentResource/Pages/ListProcurementIntents.php (new)
  - app/Filament/Resources/Procurement/ProcurementIntentResource/Pages/ViewProcurementIntent.php (new)
- **Learnings for future iterations:**
  - Filament resources in this codebase use navigation groups (PIM, Customers, Vouchers, Procurement, etc.)
  - Use `withCount()` in modifyQueryUsing to efficiently count related records for badges
  - Complex morphic search requires raw SQL with `whereExists()` for multiple related tables
  - Status filters with multiple() and default() can hide terminal states by default
  - Visual indicators for "needs attention" use IconColumn with boolean state and custom trueIcon/falseIcon
---

## 2026-02-04 - US-010
- What was implemented:
  - CreateProcurementIntent wizard page with 4 steps (Product, Source & Model, Delivery, Review)
  - Step 1 (Product): Radio selection for product type (Bottle SKU vs Liquid Product)
  - Bottle SKU selection: Wine (searchable autocomplete) + Vintage (dependent select) + Format (dependent select)
  - Liquid Product selection: Wine (searchable autocomplete) + Vintage (dependent select)
  - Product preview showing selected product label
  - Existing allocations count display (queries Allocation table by wine_variant_id + format_id)
  - Informational message about Procurement Intent purpose
  - Warning when no matching SellableSku or LiquidProduct exists (auto-created on save)
  - Steps 2-4 (Source & Model, Delivery, Review) implemented ahead for complete wizard flow
  - mutateFormDataBeforeCreate() handles product reference resolution and auto-creates missing SKUs
- Files changed:
  - app/Filament/Resources/Procurement/ProcurementIntentResource/Pages/CreateProcurementIntent.php (new)
  - app/Filament/Resources/Procurement/ProcurementIntentResource.php (modified - registered create route)
- **Learnings for future iterations:**
  - Filament wizards use `CreateRecord\Concerns\HasWizard` trait
  - Live fields with `afterStateUpdated()` can cascade state resets when parent changes
  - Use `Get $get` for reading form state and `Set $set` for updating it
  - Hidden fields can store intermediate state (sellable_sku_id, liquid_product_id) for use in mutateFormDataBeforeCreate
  - When auto-creating SellableSku, need to provide a default CaseConfiguration
  - HtmlString allows rich HTML content in Placeholder components
---

## 2026-02-04 - US-011
- What was implemented:
  - Step 2 (Source & Model) was already implemented in US-010 iteration
  - Verified all acceptance criteria are met:
    - trigger_type, sourcing_model, quantity fields present
    - Trigger type guidance with dynamic explanations (voucher_driven, allocation_driven, strategic, contractual)
    - Sourcing model guidance with dynamic explanations (purchase, passive_consignment, third_party_custody)
    - Inline explanation updates dynamically based on selection
    - Quantity validation with minValue(1)
  - Typecheck and lint pass for all Procurement module files
- Files changed:
  - No new files (implementation was done ahead in US-010)
  - prd.json (marked US-011 as passes: true)
- **Learnings for future iterations:**
  - When implementing wizards, implementing all steps together provides better UX for testing
  - US-010 implemented ahead to provide complete wizard flow
  - Enum-based selects with Placeholder guidance provide excellent UX for domain-specific options
---

## 2026-02-04 - US-012
- What was implemented:
  - Step 3 (Delivery) was already implemented in US-010 iteration
  - Verified all acceptance criteria are met:
    - preferred_inbound_location (select) with authorized warehouse options
    - rationale (textarea) with "optional but recommended" helper text
    - Location options: main_warehouse, secondary_warehouse, bonded_warehouse, third_party_storage
    - Serialization constraints preview via location_preview placeholder
  - Typecheck and lint pass for all Procurement module files
- Files changed:
  - No new files (implementation was done ahead in US-010)
  - prd.json (marked US-012 as passes: true)
- **Learnings for future iterations:**
  - All 4 wizard steps (Product, Source & Model, Delivery, Review) were implemented together in US-010
  - Location-based serialization constraints are currently hardcoded - future enhancement could pull from ProducerSupplierConfig
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-013
- What was implemented:
  - Step 4 (Review) was already implemented in US-010 iteration
  - Fixed PHPStan type safety issues in CreateProcurementIntent.php:
    - Used `is_scalar()` checks before casting mixed values to string
    - Added PHPDoc type annotations for Eloquent find() results
    - Fixed all `Cannot cast mixed to string` errors
  - Verified all acceptance criteria are met:
    - Read-only summary of all data (Product, Source & Model, Delivery sections)
    - Warning shown when no existing allocations found
    - Intent created in status draft by default
    - Message "Draft intents require approval before execution" displayed
    - "Create as Draft" CTA button present
  - Typecheck and lint pass for all Procurement module files
- Files changed:
  - app/Filament/Resources/Procurement/ProcurementIntentResource/Pages/CreateProcurementIntent.php (modified - type safety fixes)
  - prd.json (marked US-013 as passes: true)
- **Learnings for future iterations:**
  - Use `is_scalar($value)` before `(string) $value` when getAttribute() returns mixed
  - Add PHPDoc `@var Type|null` annotations before Eloquent `find()` calls to help PHPStan
  - Filament wizard form state values from `$get()` are always mixed type - type check before use
---

## 2026-02-04 - US-014
- What was implemented:
  - ViewProcurementIntent page with 4 tabbed infolist sections
  - Tab 1 (Summary): status & identity, product info, demand source with trigger type explanations, sourcing model with explanations, delivery preferences, approval information
  - Tab 2 (Downstream Execution): linked Purchase Orders list with RepeatableEntry, linked Bottling Instructions list, linked Inbound batches list, execution summary with closure readiness indicator
  - Tab 3 (Allocation & Voucher Context): source context explanation based on trigger type, allocation/voucher info extracted from rationale, Module A integration notes
  - Tab 4 (Audit): immutable timeline with filter actions for event type and date range, formatted audit log entries with color-coded badges
  - Header actions: Approve (draft→approved), Mark Executed (approved→executed), Close (executed→closed with validation), Create Linked Object dropdown (Create PO, Create Bottling Instruction, Link Inbound)
  - Used ProcurementIntentService.canClose() for closure validation before showing close action
- Files changed:
  - app/Filament/Resources/Procurement/ProcurementIntentResource/Pages/ViewProcurementIntent.php (completely rewritten with 925 new lines)
  - prd.json (marked US-014 as passes: true)
- **Learnings for future iterations:**
  - Filament Infolist Tabs pattern: use `Tabs::make()->tabs([])` with `Tab::make()` for each tab, extract to helper methods for readability
  - Use `RepeatableEntry::make()` for displaying lists of related records with Grid layouts inside
  - Header actions can have `visible()`, `disabled()`, and `requiresConfirmation()` for conditional behavior
  - Section `headerActions` can include infolist Actions for contextual actions within sections
  - AuditLog created_at is always set (not nullable) so don't use nullsafe operator on Carbon methods
  - For closure validation, use service method that returns structured array with `can_close` and `pending_items`
---

## 2026-02-04 - US-015
- What was implemented:
  - Verified that status transitions are already fully implemented across the codebase
  - ProcurementIntentStatus enum: `allowedTransitions()` returns valid transitions (draft→approved, approved→executed, executed→closed)
  - ProcurementIntentStatus enum: `canTransitionTo()` validates if a transition is allowed
  - ProcurementIntentService::approve(): Validates draft status, sets approved_at and approved_by, creates audit log with user_id
  - ProcurementIntentService::markExecuted(): Validates approved status, creates audit log with user_id
  - ProcurementIntentService::close(): Validates executed status, checks all linked objects completed via canClose(), creates audit log with user_id
  - ProcurementIntentService::canClose(): Returns structured array with `can_close` flag and list of pending items
  - ViewProcurementIntent header actions: Call service methods with try/catch for user-friendly error notifications
  - All validation errors throw InvalidArgumentException with descriptive messages
  - Typecheck and lint pass
- Files changed:
  - prd.json (marked US-015 as passes: true)
  - No code changes needed - implementation was complete in previous iterations (US-007 for service, US-002 for enum)
- **Learnings for future iterations:**
  - Status transitions in this codebase follow a pattern: enum defines valid transitions, service enforces them with audit logging
  - User-friendly errors are thrown as InvalidArgumentException and caught in Filament actions to show notifications
  - Close operations require a two-phase validation: first `canClose()` to check preconditions, then `close()` to execute
  - The ViewProcurementIntent page disables the Close action when canClose() returns false, showing pending items in modal
---

## 2026-02-04 - US-016
- What was implemented:
  - VoucherIssued event class in app/Events/ dispatched after vouchers are issued
  - CreateProcurementIntentOnVoucherIssued listener (queued) in app/Listeners/Procurement/
  - Migration adding source_allocation_id, source_voucher_id, needs_ops_review fields to procurement_intents
  - Updated ProcurementIntent model with new fields, relationships (sourceAllocation, sourceVoucher), and helper methods
  - Event listener registered in AppServiceProvider via Event::listen()
  - VoucherService.issueVouchers() now dispatches VoucherIssued event after successful transaction
  - Listener creates draft intent with voucher_driven trigger type and sourcing_model inferred from allocation source type
  - needs_ops_review flag set to true for auto-created intents
- Files changed:
  - app/Events/VoucherIssued.php (new)
  - app/Listeners/Procurement/CreateProcurementIntentOnVoucherIssued.php (new)
  - database/migrations/2026_02_04_400016_add_source_context_to_procurement_intents.php (new)
  - app/Models/Procurement/ProcurementIntent.php (modified - added source context fields and relationships)
  - app/Providers/AppServiceProvider.php (modified - registered event listener)
  - app/Services/Allocation/VoucherService.php (modified - dispatches VoucherIssued event)
- **Learnings for future iterations:**
  - Laravel 11+ doesn't have EventServiceProvider by default; register events via Event::listen() in AppServiceProvider
  - Dispatch events AFTER DB transaction completes to ensure data consistency
  - Use `implements ShouldQueue` on listeners for async processing to avoid blocking the main request
  - The `SerializesModels` trait on events allows passing Eloquent models to queued listeners
  - ProcurementIntentService::createFromVoucherSale() already exists and infers sourcing_model from allocation source type
  - Use `needs_ops_review` flag pattern for items requiring manual attention rather than complex notification systems
---

## 2026-02-04 - US-017
- What was implemented:
  - Bulk action "Approve Selected" added to Procurement Intent List
  - Only draft intents are processed (non-draft intents are skipped)
  - Confirmation dialog shows count of eligible draft intents
  - Each intent approved individually via ProcurementIntentService::approve()
  - Proper audit log entries created for each approval
  - Success/warning/error notifications with counts
  - deselectRecordsAfterCompletion() for UX
- Files changed:
  - app/Filament/Resources/Procurement/ProcurementIntentResource.php (modified - added bulk approval action)
- **Learnings for future iterations:**
  - Filament bulk actions use `Tables\Actions\BulkAction::make()` with `->action(function (Collection $records): void { ... })`
  - PHPStan requires `/** @var Model $record */` annotations inside foreach loops over Collection
  - Use `->requiresConfirmation()`, `->modalHeading()`, `->modalDescription()` for confirmation dialog
  - modalDescription can be a closure that receives the Collection to show dynamic count
  - `->deselectRecordsAfterCompletion()` provides better UX after bulk operations
  - Use separate Notification::make() calls for success, warnings, and errors
---

## 2026-02-04 - US-018
- What was implemented:
  - Toggle view "Aggregated by Product" accessible via button in Intent List header
  - New AggregatedProcurementIntents page showing intents grouped by product reference
  - Aggregation query using GROUP BY on product_reference_type + product_reference_id
  - Columns: product_label (wine+vintage+format), total_quantity (sum), intents_count, status breakdown (draft/approved/executed/closed counts)
  - Expand row functionality via "View Intents" action opening modal with individual intents
  - Modal shows summary stats (total, quantity, draft/approved counts) and detailed table
  - Each intent in modal links to its detail view in new tab
  - Filters: product type (bottle SKU/liquid), has draft intents, high volume (>100)
  - Enhanced ListProcurementIntents with tabs by status (Active, Draft, Approved, Executed, Closed, All) with badge counts
  - Blade views for aggregated page and intent list modal
- Files changed:
  - app/Filament/Resources/Procurement/ProcurementIntentResource.php (modified - added aggregated route)
  - app/Filament/Resources/Procurement/ProcurementIntentResource/Pages/ListProcurementIntents.php (modified - added toggle button and tabs)
  - app/Filament/Resources/Procurement/ProcurementIntentResource/Pages/AggregatedProcurementIntents.php (new)
  - resources/views/filament/resources/procurement/procurement-intent-resource/pages/aggregated-procurement-intents.blade.php (new)
  - resources/views/filament/resources/procurement/procurement-intent-resource/pages/partials/intent-list-modal.blade.php (new)
- **Learnings for future iterations:**
  - Filament toggle views use separate Page classes with InteractsWithTable trait for custom queries
  - Aggregated queries need explicit JOINs for related data in GROUP BY (can't use Eloquent relations)
  - Use `view()` helper with `modalContent()` for custom modal content in table actions
  - ListRecords supports `getTabs()` for tabbed filtering with badge counts
  - Tab badges use closures for dynamic counts: `->badge(fn () => $this->getCount())`
  - SQL CONCAT with COALESCE handles NULL values in joined columns
---

## 2026-02-04 - US-019
- What was implemented:
  - PurchaseOrderResource in Filament under navigation group "Procurement"
  - List columns: po_id (copyable, limited), supplier (legal_name), product (via getProductLabel()), quantity (badge), unit_cost (money with currency), currency (badge), ownership_transfer (icon badge), delivery_window, is_overdue (icon indicator), status (badge with icon/color), updated_at
  - Filters: status (with closed hidden by default), supplier_party_id (searchable select with preload), ownership_transfer (ternary), delivery_period (date range with indicators), overdue (toggle), trashed
  - Search: po_id searchable directly, supplier name via supplier.legal_name relationship, product searchable via complex multi-table query (sellable_skus, liquid_products, wine_masters)
  - Closed POs hidden by default via status filter defaulting to [draft, sent, confirmed]
  - Visual indicator (exclamation icon) for POs with delivery window passed
  - ListPurchaseOrders page with tabs (Active, Draft, Sent, Confirmed, Overdue, Closed, All) with badge counts
  - ViewPurchaseOrder page (placeholder for US-025 detail tabs)
  - Added purchaseOrdersAsSupplier relationship to Party model for supplier filtering
- Files changed:
  - app/Filament/Resources/Procurement/PurchaseOrderResource.php (new)
  - app/Filament/Resources/Procurement/PurchaseOrderResource/Pages/ListPurchaseOrders.php (new)
  - app/Filament/Resources/Procurement/PurchaseOrderResource/Pages/ViewPurchaseOrder.php (new)
  - app/Models/Customer/Party.php (modified - added purchaseOrdersAsSupplier relationship)
- **Learnings for future iterations:**
  - Party model uses `legal_name` field, not `name` - always use legal_name for display
  - PO List follows same pattern as Intent List: tabs by status, status filter with multiple() and default(), overdue indicator
  - Use `->money()` column with currency parameter from record field for dynamic currency display
  - TernaryFilter provides boolean filtering with "All/Yes/No" options
  - Date range filters use indicateUsing() to show active filter chips
  - Overdue tab useful for quickly identifying POs needing attention
---

## 2026-02-04 - US-020
- What was implemented:
  - CreatePurchaseOrder wizard page with 5 steps following CreateProcurementIntent pattern
  - Step 1 (Intent): Procurement Intent selection with searchable autocomplete
  - Only shows intents in Approved or Executed status
  - Intent preview showing product label, quantity, sourcing model, status
  - Prominent warning message: "A PO cannot exist without a Procurement Intent"
  - Pre-fills quantity and destination_warehouse from intent
  - Pre-fills ownership_transfer based on sourcing model (true for Purchase)
  - Visual warnings for sourcing model implications on ownership transfer
  - Steps 2-5 scaffolded (Supplier, Commercial Terms, Delivery, Review) - will be verified in subsequent stories
  - Registered create route in PurchaseOrderResource
- Files changed:
  - app/Filament/Resources/Procurement/PurchaseOrderResource/Pages/CreatePurchaseOrder.php (new)
  - app/Filament/Resources/Procurement/PurchaseOrderResource.php (modified - registered create route)
- **Learnings for future iterations:**
  - Party model doesn't have `trade_name` or `role` fields - use `roles` relationship instead
  - Party.roles returns HasMany<PartyRole> with `role` attribute - use `pluck('role')` to get role values
  - Use `party_type->label()` for party type display, not a direct role field
  - Follow CreateProcurementIntent pattern: HasWizard trait, getSteps() returning Wizard\Step array
  - Use hidden fields to store preview data for display in review step
  - Pre-fill downstream fields in afterStateUpdated() to provide good UX defaults
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-021
- What was implemented:
  - Fixed Step 2 (Supplier) of Create PO wizard
  - Fixed supplier search to use `whereHas('roles', ...)` with PartyRoleType enum values
  - Removed invalid `trade_name` field reference (doesn't exist on Party)
  - Added proper role filtering (supplier/producer only) via PartyRoleType enum
  - Updated `formatPartyOption()` to display relevant roles (Supplier/Producer) in brackets
  - Fixed type safety issues for PHPStan compliance (is_scalar checks before string casting)
  - Eager-loads roles and supplierConfig for preview data
  - ProducerSupplierConfig shown when available with default constraints
  - "No config" message shown when supplier has no ProducerSupplierConfig
- Files changed:
  - app/Filament/Resources/Procurement/PurchaseOrderResource/Pages/CreatePurchaseOrder.php (modified)
- **Learnings for future iterations:**
  - Party model has `roles` relationship (HasMany<PartyRole>), not a `role` field
  - PartyRole.role is cast to PartyRoleType enum - use helper methods like `isSupplier()`, `isProducer()`
  - Filter suppliers/producers with: `whereHas('roles', fn($q) => $q->whereIn('role', [PartyRoleType::Supplier->value, PartyRoleType::Producer->value]))`
  - Always eager-load relationships needed for display: `with(['roles', 'supplierConfig'])`
  - Use `$role->role->label()` for enum label (role.role is PartyRoleType enum)
---

## 2026-02-04 - US-022
- What was implemented:
  - Verified Step 3 (Commercial Terms) was already implemented in US-020
  - Step 3 has all required fields: quantity, unit_cost, currency, incoterms, ownership_transfer
  - Quantity field: numeric, required, minValue(1), pre-filled from intent
  - Unit cost field: numeric, required, minValue(0.01), with € prefix
  - Currency select: EUR, USD, GBP, CHF options with default EUR
  - Incoterms select: All standard incoterms (EXW, FCA, CPT, CIP, DAP, DPU, DDP, FAS, FOB, CFR, CIF)
  - Ownership transfer toggle with dynamic explanation (ownership vs custody)
  - Warning for quantity exceeding intent quantity (quantity_warning placeholder)
  - Warning for mismatch between Purchase sourcing model and no ownership transfer
  - Verified typecheck and lint pass
- Files changed:
  - prd.json (marked US-022 as passes: true)
  - No code changes needed - implementation was complete in US-020
- **Learnings for future iterations:**
  - Wizard steps are often implemented together for complete flow testing
  - Commercial terms follow pattern: Quantity section + Pricing section + Ownership section
  - Use `minValue()` on TextInput for positive number validation
  - Dynamic content in Placeholders via closures reacts to `live()` field changes
  - Mismatch warnings help operators catch inconsistent data entry
---

## 2026-02-04 - US-023
- What was implemented:
  - Verified Step 4 (Delivery) was already implemented in US-020
  - Step 4 has all required fields: expected_delivery_start, expected_delivery_end, destination_warehouse, serialization_routing_note
  - expected_delivery_start: DatePicker with native(false), live() for validation
  - expected_delivery_end: DatePicker with afterOrEqual('expected_delivery_start') validation
  - destination_warehouse: Select with warehouse options (main_warehouse, secondary_warehouse, bonded_warehouse, third_party_storage)
  - destination_warehouse pre-filled from intent.preferred_inbound_location (done in Step 1 afterStateUpdated)
  - serialization_routing_note: Textarea for special routing instructions (e.g., "France required")
  - Informational note about destination being pre-filled from intent
  - Verified typecheck and lint pass
- Files changed:
  - prd.json (marked US-023 as passes: true)
  - No code changes needed - implementation was complete in US-020
- **Learnings for future iterations:**
  - Filament DatePicker validation uses afterOrEqual() for date range constraints
  - Wizard steps implemented together in US-020 allows for faster iteration on subsequent stories
  - Pre-filling fields across wizard steps is done in afterStateUpdated() of the source step
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-024
- What was implemented:
  - Verified Step 5 (Review) was already implemented in US-020
  - Step 5 has all required sections: Linked Intent, Supplier, Commercial Terms, Delivery
  - Read-only summary of all data entered in previous steps
  - Linked intent shown with ID and product label
  - Total cost calculated (quantity × unit_cost)
  - PO created in status draft via mutateFormDataBeforeCreate()
  - Draft status message: "Draft POs are not sent to suppliers until status changes to Sent"
  - CTA: "Create as Draft" button via getWizardSubmitActions()
  - Success notification shown after creation with guidance about Sent status
  - Verified typecheck and lint pass
- Files changed:
  - prd.json (marked US-024 as passes: true)
  - No code changes needed - implementation was complete in US-020
- **Learnings for future iterations:**
  - All 5 PO wizard steps (Intent, Supplier, Commercial Terms, Delivery, Review) were implemented together in US-020
  - Review step follows pattern: Section per domain area, Placeholder fields for each data point
  - Total calculations in review step provide value-add for operator validation
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-025
- What was implemented:
  - ViewPurchaseOrder page with 5 tabbed infolist sections
  - Tab 1 (Commercial Terms): Status & Identity, Supplier info, Product info, Pricing (unit cost, total cost, currency, incoterms), Ownership transfer
  - Tab 2 (Linked Intent): Source intent ID with link, intent status, quantity coverage vs intent (percentage, status badge), sourcing context
  - Tab 3 (Delivery Expectations): Delivery window with status indicator (overdue, due soon), destination warehouse, serialization routing note
  - Tab 4 (Inbound Matching): Variance summary (PO qty vs received qty, variance badge), linked inbound batches with RepeatableEntry, over/short delivery status
  - Tab 5 (Audit): Immutable timeline with filter actions, formatted audit log entries with color-coded badges
  - Header actions: Mark as Sent (Draft→Sent), Confirm (Sent→Confirmed), Close (Confirmed→Closed with variance notes), Link Inbound
  - All actions create audit log entries with user_id and timestamp
  - Close action includes optional variance_notes textarea
- Files changed:
  - app/Filament/Resources/Procurement/PurchaseOrderResource/Pages/ViewPurchaseOrder.php (completely rewritten with 880 lines)
- **Learnings for future iterations:**
  - PurchaseOrder.procurementIntent relationship is required (NOT NULL FK), use `->` not `?->` for property access
  - Inbound Matching tab badge shows count of linked inbounds using Tab badge property
  - Variance calculations: variance = inbound_qty - po_qty, with >10% threshold for danger color
  - Close action allows variance_notes to be recorded in audit log
  - Link Inbound action passes purchase_order_id as query param to pre-fill create form
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-026
- What was implemented:
  - Added confirmed_at (timestamp) and confirmed_by (FK users) fields to PurchaseOrder
  - Migration 2026_02_04_400026_add_confirmed_at_to_purchase_orders.php
  - Updated PurchaseOrder model with new fields, casts, confirmedByUser relationship
  - Status transitions already implemented in enum (allowedTransitions, canTransitionTo)
  - sent→confirmed: Now sets confirmed_at = now(), confirmed_by = auth()->id()
  - confirmed→closed: Already supports variance_notes via close action form
  - Invalid transitions show user-friendly Notification error
  - All transitions create AuditLog with user_id, timestamp, and changes array
  - Status & Identity section in Commercial Terms tab shows confirmed_at and confirmed_by when present
- Files changed:
  - database/migrations/2026_02_04_400026_add_confirmed_at_to_purchase_orders.php (new)
  - app/Models/Procurement/PurchaseOrder.php (modified - added confirmed_at, confirmed_by, confirmedByUser relationship)
  - app/Filament/Resources/Procurement/PurchaseOrderResource/Pages/ViewPurchaseOrder.php (modified - set confirmed_at/by on confirm, display in UI)
- **Learnings for future iterations:**
  - Use `$table->unsignedBigInteger()` + `$table->foreign()` for FK with after() positioning (foreignId + constrained doesn't support after())
  - Confirmation tracking (timestamp + user) follows same pattern as approval tracking in ProcurementIntent
  - AuditLog changes array should include new field values for complete audit trail
  - Status transition actions use canTransitionTo() for validation before attempting change
---

## 2026-02-04 - US-027
- What was implemented:
  - Added variance helper methods to PurchaseOrder model:
    - getInboundQuantity(): returns total inbound quantity linked to PO
    - getVariance(): returns inbound_quantity - po_quantity
    - getVariancePercentage(): returns variance as percentage of PO quantity
    - getVarianceStatus(): returns 'Exact Match', 'Over Delivery', or 'Short Delivery'
    - hasSignificantVariance(): checks if variance exceeds threshold (default 10%)
    - Helper methods: hasInbounds(), isOverDelivery(), isShortDelivery(), isExactMatch()
  - Added variance column to PO List:
    - Shows variance status with badge (Exact Match, Over Delivery, Short Delivery)
    - Color coding: green (exact), warning (variance <= 10%), danger (variance > 10%)
    - Icon indicator: check (exact), up-arrow (over), down-arrow (short)
    - Sortable by variance amount
    - Tooltip for significant variance warning
  - Added variance filter in PO List: exact_match, over_delivery, short_delivery, significant_variance, no_inbounds
  - Added two new tabs to PO List: "With Variance" and "Variance > 10%" with badge counts
  - Updated close action to show warning when variance > 10% (informative, not blocking)
  - All variance calculations use raw SQL subqueries for efficiency
- Files changed:
  - app/Models/Procurement/PurchaseOrder.php (modified - added variance helper methods)
  - app/Filament/Resources/Procurement/PurchaseOrderResource.php (modified - added variance column and filter)
  - app/Filament/Resources/Procurement/PurchaseOrderResource/Pages/ListPurchaseOrders.php (modified - added variance tabs)
  - app/Filament/Resources/Procurement/PurchaseOrderResource/Pages/ViewPurchaseOrder.php (modified - enhanced close action with variance warning)
- **Learnings for future iterations:**
  - Use raw SQL subqueries for aggregate calculations on related tables to avoid N+1 issues
  - Variance tracking is informative - it does NOT block business operations like closure
  - Use `whereHas('inbounds')` combined with `whereRaw()` for complex variance queries
  - Close action can show warnings via modalDescription closure without blocking the action
  - Tab badges with icon property (e.g., `->icon('heroicon-o-exclamation-triangle')`) draw attention to important states
---

## 2026-02-04 - US-028
- What was implemented:
  - BottlingInstructionResource in Filament under navigation group "Procurement"
  - List columns: instruction_id (copyable, limited), wine+vintage (via getProductLabel()), bottle_equivalents (badge), allowed_formats (badge), bottling_deadline (with urgency coloring and description), deadline_urgent (icon indicator), preference_status (badge with icon/color), preference_pending (icon indicator), status (badge with icon/color), updated_at
  - Filters: status (with executed hidden by default), preference_status, deadline_range (date picker), deadline_urgent (toggle), deadline_passed (toggle), trashed
  - Search: instruction_id searchable directly, wine name searchable via complex join query (liquid_products, wine_variants, wine_masters)
  - Executed instructions hidden by default via status filter defaulting to [draft, active]
  - Visual indicator (exclamation icon) for instructions with deadline < 30 days
  - Visual indicator (bell icon) for instructions with preference_status = pending
  - ListBottlingInstructions page with tabs: Active, Draft, Running (Active status), Deadline < 30 days, Pending Preferences, Executed, All - each with badge counts
  - ViewBottlingInstruction page (placeholder for US-033 detail tabs)
  - Default sort by bottling_deadline ascending (soonest deadlines first)
- Files changed:
  - app/Filament/Resources/Procurement/BottlingInstructionResource.php (new)
  - app/Filament/Resources/Procurement/BottlingInstructionResource/Pages/ListBottlingInstructions.php (new)
  - app/Filament/Resources/Procurement/BottlingInstructionResource/Pages/ViewBottlingInstruction.php (new)
- **Learnings for future iterations:**
  - Bottling Instructions have two status systems: BottlingInstructionStatus (lifecycle) and BottlingPreferenceStatus (preference collection)
  - Default sort by deadline ascending helps operators prioritize urgent items
  - Use column description() for inline contextual info (e.g., "X days remaining")
  - Multiple icon indicators for different attention states (deadline urgent, preference pending) help operators quickly scan
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-029
- What was implemented:
  - CreateBottlingInstruction wizard page with 4 steps
  - Step 1 (Liquid Product): Procurement Intent selection filtered for liquid products only
  - Intent search filters: only Approved/Executed status, only product_reference_type = liquid_products
  - Preview sections: Intent Summary (product, wine, vintage, quantity, sourcing model, status)
  - Auto-fill: liquid_product_id and bottle_equivalents auto-filled from intent
  - Pre-fill: delivery_location pre-filled from intent.preferred_inbound_location
  - Informational message about Bottling Instructions managing post-sale bottling decisions
  - Steps 2-4 implemented ahead (Rules, Personalisation, Review) for complete wizard flow
  - "Create as Draft" and "Create and Activate" submit options
  - Registered create route in BottlingInstructionResource
- Files changed:
  - app/Filament/Resources/Procurement/BottlingInstructionResource/Pages/CreateBottlingInstruction.php (new)
  - app/Filament/Resources/Procurement/BottlingInstructionResource.php (modified - added create route)
- **Learnings for future iterations:**
  - Filter morphic relationships by type: where('product_reference_type', 'liquid_products')
  - Search through nested relationships: whereHas('productReference', fn($q) => $q->whereHas('wineVariant.wineMaster', ...))
  - Bottling Instructions require both procurement_intent_id and liquid_product_id (both enforced in model boot())
  - All 4 wizard steps (Liquid Product, Rules, Personalisation, Review) implemented together for complete flow
  - "Create and Activate" option uses Hidden field with wire:click to set flag before submit
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-030
- What was implemented:
  - Step 2 (Bottling Rules) was already implemented in US-029 iteration
  - Verified all acceptance criteria are met:
    - allowed_formats (multi-select) with common formats (375ml, 750ml, 1500ml, 3000ml, 6000ml)
    - allowed_case_configurations (multi-select) with options (1, 3, 6, 12 bottles/case)
    - default_bottling_rule (textarea) with explanation helper text
    - Format suggestion placeholder with tip about producer constraints
    - Rule preview showing plain-language formula of selected options and default rule
  - Typecheck and lint pass for all Procurement module files
- Files changed:
  - No new files (implementation was done ahead in US-029)
  - prd.json (marked US-030 as passes: true)
- **Learnings for future iterations:**
  - Wizard steps implemented together in US-029 for complete testing flow
  - Rule preview uses live() fields to reactively update the formula display
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-031
- What was implemented:
  - Step 3 (Personalisation) was already implemented in US-029 iteration
  - Verified all acceptance criteria are met:
    - bottling_deadline (date required) with minDate validation
    - delivery_location (select) with warehouse options
    - personalised_bottling_required (toggle) with explanation when enabled
    - early_binding_required (toggle) with explanation: "voucher-bottle binding happens before bottling"
    - Prominent warning: "After deadline, defaults will be applied automatically"
  - Typecheck and lint pass for all Procurement module files
- Files changed:
  - No new files (implementation was done ahead in US-029)
  - prd.json (marked US-031 as passes: true)
- **Learnings for future iterations:**
  - Personalisation toggles use live() with hidden() on explanation placeholders
  - Toggle explanations provide context-specific guidance when options are enabled
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-032
- What was implemented:
  - Step 4 (Review) was already implemented in US-029 iteration
  - Verified all acceptance criteria are met:
    - Read-only summary of all data (Intent, Bottling Rules, Personalisation sections)
    - Visual countdown to deadline with color coding (red < 14 days, amber < 30 days, green otherwise)
    - Warning shown when deadline < 30 days
    - BottlingInstruction created in status draft via mutateFormDataBeforeCreate()
    - CTAs: "Create as Draft" and "Create and Activate" buttons
  - Typecheck and lint pass for all Procurement module files
- Files changed:
  - No new files (implementation was done ahead in US-029)
  - prd.json (marked US-032 as passes: true)
- **Learnings for future iterations:**
  - Review step follows pattern: Section per domain area with read-only Placeholder fields
  - Deadline countdown uses Carbon::diffInDays() with false parameter for signed difference
  - "Create and Activate" sets status to Active instead of Draft in mutateFormDataBeforeCreate
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-033
- What was implemented:
  - ViewBottlingInstruction page with 5 tabbed infolist sections
  - Tab 1 (Bottling Rules): status & identity, product info (liquid product, bottle equivalents), allowed formats and case configurations, default bottling rule with explanation, delivery location comparison
  - Tab 2 (Customer Preferences): deadline countdown with urgency coloring (critical/warning/normal), preference collection progress (voucher count, collected, missing), collection status explanation, customer portal guidance, defaults application info
  - Tab 3 (Allocation & Voucher Linkage): source procurement intent with clickable link, allocation info (read-only from Module A), voucher batch info (read-only), Module A integration explanation
  - Tab 4 (Personalisation Flags): personalised_bottling_required flag with explanation, early_binding_required flag with explanation, binding instruction preview (markdown), process flow description
  - Tab 5 (Audit): immutable timeline with filter actions (event type, date range), formatted audit log entries with color-coded badges, key events section, audit info explanation
  - Header actions: Activate (Draft→Active) with confirmation, Mark Executed (Active→Executed) with preference status warning, View Intent link, Delete/Restore
  - All actions create AuditLog entries with user_id and timestamp
- Files changed:
  - app/Filament/Resources/Procurement/BottlingInstructionResource/Pages/ViewBottlingInstruction.php (completely rewritten with 946 lines)
- **Learnings for future iterations:**
  - BottlingInstruction has two status systems: BottlingInstructionStatus (lifecycle: draft→active→executed) and BottlingPreferenceStatus (preference collection: pending→partial→complete/defaulted)
  - AuditLog uses `event`, `old_values`, `new_values` fields (not `event_type`, `changes`, `notes` as seen in some older code)
  - Markdown content in TextEntry uses `->markdown()` method for proper rendering
  - Tab badge can show "!" with badgeColor for attention indicators
  - Preference collection progress is a placeholder - actual voucher preferences would come from Module A integration
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-034
- What was implemented:
  - Customer Preference Collection tracking widget in Bottling Instruction Detail
  - Visual progress bar showing collected/total vouchers percentage with color-coded status
  - Voucher list with preference status (collected/pending) and customer information
  - Customer portal link section for external preference collection
  - Helper methods added to BottlingInstruction model:
    - getLinkedVouchers(): fetches vouchers via source allocation linkage
    - getPreferenceProgress(): returns {collected, pending, total} counts
    - getPreferenceProgressPercentage(): returns collection percentage as float
    - getVoucherPreferenceList(): returns vouchers with preference status details
    - getCustomerPortalUrl(): returns external portal URL for preference collection
  - Created CustomerPreferenceCollectionWidget Filament widget (app/Filament/Widgets/Procurement/)
  - Created Blade view for widget with Tailwind CSS styling
  - Integrated widget into ViewBottlingInstruction Customer Preferences tab with:
    - Enhanced progress bar with color coding (success/warning/info based on percentage)
    - Stats grid showing collected/pending/total counts as badges
    - Collapsible voucher list section with status icons
    - Customer portal link with CTA button
- Files changed:
  - app/Models/Procurement/BottlingInstruction.php (modified - added preference collection helper methods)
  - app/Filament/Resources/Procurement/BottlingInstructionResource/Pages/ViewBottlingInstruction.php (modified - added widget integration and HTML rendering methods)
  - app/Filament/Widgets/Procurement/CustomerPreferenceCollectionWidget.php (new)
  - resources/views/filament/widgets/procurement/customer-preference-collection-widget.blade.php (new)
- **Learnings for future iterations:**
  - Vouchers are linked via ProcurementIntent.source_allocation_id relationship to Allocation
  - Preference status is simulated from BottlingPreferenceStatus enum - real implementation would query Module A
  - HTML rendering in Filament Infolist TextEntry uses getStateUsing() + ->html() for custom widgets
  - Progress bar color coding: success (100%), warning (>=50%), info (>0%), gray (0%)
  - For complex UI widgets, use helper methods that return HTML strings with Tailwind classes
  - Customer portal URL is configured via config('app.customer_portal_url') with fallback
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-035
- What was implemented:
  - ApplyBottlingDefaultsJob in app/Jobs/Procurement/ that runs daily
  - Finds BottlingInstructions with: status = active, deadline <= today, preference_status in [pending, partial]
  - For each instruction:
    - Sets preference_status = defaulted
    - Sets defaults_applied_at = now()
    - Creates AuditLog with EVENT_DEFAULTS_APPLIED event
    - Sends BottlingDefaultsAppliedNotification to Ops users (Editor role and above)
  - Added daily scheduler in routes/console.php
  - Added EVENT_DEFAULTS_APPLIED constant to AuditLog model with label, icon, and color
  - Created BottlingDefaultsAppliedNotification for database notifications to Ops
- Files changed:
  - app/Jobs/Procurement/ApplyBottlingDefaultsJob.php (new)
  - app/Notifications/Procurement/BottlingDefaultsAppliedNotification.php (new)
  - app/Models/AuditLog.php (modified - added EVENT_DEFAULTS_APPLIED constant)
  - routes/console.php (modified - added daily job schedule)
- **Learnings for future iterations:**
  - Jobs follow pattern: implement ShouldQueue, use Queueable trait, handle() method for execution
  - Schedule jobs in routes/console.php using Schedule::job()->daily() or other timing methods
  - Use AuditLog constants for event types to ensure consistency across the codebase
  - Notification to users uses Notification::send($users, new XxxNotification($model)) facade
  - Query Ops users by role enum values: whereIn('role', [UserRole::Editor->value, ...])
  - System actions (no user) set user_id = null in AuditLog
  - Use AuditLog::EVENT_* constants instead of raw strings for audit event types
---

## 2026-02-04 - US-036
- What was implemented:
  - BottlingInstructionService class in app/Services/Procurement/
  - activate(BottlingInstruction $instruction): Transitions draft → active, creates audit log
  - markExecuted(BottlingInstruction $instruction): Transitions active → executed, includes preference_status context in audit
  - applyDefaults(BottlingInstruction $instruction): Sets preference_status to defaulted, defaults_applied_at to now(), validates status
  - updatePreferenceStatus(BottlingInstruction $instruction, int $collectedCount, ?int $totalCount): Recalculates preference_status based on collected/total
  - getPreferenceProgress(BottlingInstruction $instruction): Returns {collected, pending, total, percentage} array
  - All methods validate state transitions and throw InvalidArgumentException on invalid operations
  - All transitions create AuditLog entries with user_id and relevant context
- Files changed:
  - app/Services/Procurement/BottlingInstructionService.php (new)
- **Learnings for future iterations:**
  - BottlingInstructionService follows same pattern as ProcurementIntentService and InboundService
  - BottlingInstruction has two status systems: BottlingInstructionStatus (lifecycle) and BottlingPreferenceStatus (preference collection)
  - applyDefaults uses AuditLog::EVENT_DEFAULTS_APPLIED (added in US-035)
  - updatePreferenceStatus uses calculatePreferenceStatus helper: 0% = Pending, 1-99% = Partial, 100% = Complete
  - getPreferenceProgress delegates to model's getPreferenceProgress() but adds percentage to the return array
---

## 2026-02-04 - US-037
- What was implemented:
  - InboundResource in Filament under navigation group "Procurement" (sort order 4)
  - List columns: inbound_id (copyable, limited), warehouse (badge), product (via getProductLabel()), quantity (badge), packaging (badge with icon/color), ownership_flag (badge with icon/color), ownership_pending indicator (exclamation icon), received_date, serialization_required (QR code icon), is_unlinked indicator (link-slash icon), status (badge with icon/color), updated_at
  - Filters: status (with completed hidden by default), warehouse, ownership_flag, packaging, ownership_pending (toggle), unlinked (toggle), serialization_required (toggle), handed_to_module_b (toggle), trashed
  - Search: inbound_id searchable directly, product searchable via complex multi-table query (sellable_skus, liquid_products, wine_variants, wine_masters)
  - Completed inbounds hidden by default via status filter defaulting to [recorded, routed]
  - Visual indicator (exclamation icon) for inbounds with ownership_flag = pending
  - Visual indicator (link-slash icon) for unlinked inbounds
  - ListInbounds page with tabs: Active, Recorded, Routed, Pending Ownership (with icon), Unlinked (with icon), Awaiting Hand-off, Completed, All - each with badge counts
  - ViewInbound page placeholder for future US-042 implementation
  - Default sort by received_date descending (most recent first)
- Files changed:
  - app/Filament/Resources/Procurement/InboundResource.php (new)
  - app/Filament/Resources/Procurement/InboundResource/Pages/ListInbounds.php (new)
  - app/Filament/Resources/Procurement/InboundResource/Pages/ViewInbound.php (new)
- **Learnings for future iterations:**
  - InboundResource follows same pattern as BottlingInstructionResource and PurchaseOrderResource
  - Multiple visual indicators (ownership pending, unlinked) help operators quickly identify items needing attention
  - Tabs for operational states: "Pending Ownership" and "Unlinked" with warning icons draw attention to exceptional states
  - Default sort by received_date DESC helps operators see recent arrivals first
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-038
- What was implemented:
  - CreateInbound wizard page with 4 steps following established patterns
  - Step 1 (Physical Receipt): warehouse selection (main_warehouse, secondary_warehouse, bonded_warehouse, third_party_storage)
  - received_date field with date picker (max today, default today)
  - quantity field with numeric validation (minValue 1)
  - packaging select with InboundPackaging enum (cases, loose, mixed) and dynamic explanations
  - condition_notes textarea with tips for documenting damage/issues
  - Prominent warning message: "Inbound records physical arrival - it does NOT imply ownership"
  - Steps 2-4 also implemented (Sourcing Context, Serialization, Review) for complete wizard flow
  - mutateFormDataBeforeCreate sets status to Recorded, defaults ownership_flag to Pending
  - afterCreate shows warnings for pending ownership or unlinked inbounds
  - Registered create route in InboundResource
- Files changed:
  - app/Filament/Resources/Procurement/InboundResource/Pages/CreateInbound.php (new)
  - app/Filament/Resources/Procurement/InboundResource.php (modified - added create route)
- **Learnings for future iterations:**
  - CreateInbound follows same wizard pattern as CreatePurchaseOrder and CreateBottlingInstruction
  - All 4 wizard steps implemented together for complete testable flow
  - Inbound model uses nullable FKs for procurement_intent_id and purchase_order_id (optional linkage)
  - Ownership flag defaults to 'pending' - emphasizes that Inbound does NOT imply ownership
  - Warning messages about unlinked inbounds and pending ownership help operators understand next steps
  - Use empty() instead of === null for mixed type array values to satisfy PHPStan
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-039
- What was implemented:
  - Step 2 (Sourcing Context) was already implemented in US-038 iteration
  - Verified all acceptance criteria are met:
    - procurement_intent_id (select nullable) with searchable autocomplete for Approved/Executed intents
    - purchase_order_id (select nullable) with searchable autocomplete for Sent/Confirmed POs
    - ownership_flag (select required) with OwnershipFlag enum and dynamic explanations
    - Auto-fill intent from PO when PO is selected (sets procurement_intent_id automatically)
    - Ownership warning (amber) when ownership_flag = pending
    - Unlinked inbound warning (yellow) when no procurement_intent_id is linked
  - Typecheck and lint pass for all Procurement module files
- Files changed:
  - No new files (implementation was done ahead in US-038)
  - prd.json (marked US-039 as passes: true)
- **Learnings for future iterations:**
  - Wizard steps implemented together in US-038 for complete testing flow
  - Ownership flag selection includes three states: owned, in_custody, pending
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-040
- What was implemented:
  - Step 3 (Serialization) was already implemented in US-038 iteration
  - Verified all acceptance criteria are met:
    - serialization_required (toggle) defaults to true
    - serialization_location_authorized (select) with expanded location options
    - serialization_routing_rule (textarea) for special routing instructions
    - Dynamic info messages based on serialization_required state
    - Warning when no location is selected but serialization is required
    - Routing tips section with common examples
  - Typecheck and lint pass for all Procurement module files
- Files changed:
  - No new files (implementation was done ahead in US-038)
  - prd.json (marked US-040 as passes: true)
- **Learnings for future iterations:**
  - Serialization step hides location and routing rule sections when serialization_required is false
  - Location options expanded beyond warehouses to include facility-specific options (france_facility, uk_facility, origin_winery)
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-041
- What was implemented:
  - Step 4 (Review) was already implemented in US-038 iteration
  - Verified all acceptance criteria are met:
    - Read-only summary of all data (Physical Receipt, Sourcing Context, Serialization sections)
    - Prominent warning (red) when ownership_flag = pending
    - Warning (yellow) when no procurement_intent_id linked
    - Inbound created in status recorded via mutateFormDataBeforeCreate
    - "Record Inbound" CTA button via getWizardSubmitActions
    - Informational message about next steps (Route, then Complete)
  - Typecheck and lint pass for all Procurement module files
- Files changed:
  - No new files (implementation was done ahead in US-038)
  - prd.json (marked US-041 as passes: true)
- **Learnings for future iterations:**
  - All 4 wizard steps (Physical Receipt, Sourcing Context, Serialization, Review) were implemented together in US-038
  - Review step uses Placeholder components with HTML for colored status indicators
  - afterCreate method shows different notifications based on warnings (ownership pending, unlinked)
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-042
- What was implemented:
  - ViewInbound page with 5 tabbed infolist sections following ViewPurchaseOrder pattern
  - Tab 1 (Physical Receipt): Status & Identity section, Receiving Location, Product & Quantity, Condition Notes
  - Tab 2 (Sourcing Context): Ownership Status with prominent badge and update action, Linked PO section, Linked Intent section, Unlinked warning section
  - Tab 3 (Serialization Routing): Serialization Requirements, Authorized Location with blocker warnings, Routing Rule
  - Tab 4 (Downstream Hand-off): Hand-off status, Prerequisites checklist, Serialization info placeholder
  - Tab 5 (Audit): Immutable timeline with filter actions (event type, date range), Key events summary
  - Header actions: Route (Recorded→Routed), Complete (Routed→Completed), Hand-off to Module B
  - Navigation links: View Intent, View PO (visible when linked)
  - Delete/Restore actions (delete only when not handed off)
  - Uses InboundService for all status transitions with proper error handling
- Files changed:
  - app/Filament/Resources/Procurement/InboundResource/Pages/ViewInbound.php (completely rewritten with 839 lines)
- **Learnings for future iterations:**
  - ViewInbound follows same pattern as ViewPurchaseOrder: Tabs with Tab components, Section for groupings, Grid for layouts
  - AuditLog for Inbound uses 'event' field (not 'event_type') and 'old_values'/'new_values' (not 'changes')
  - Tab badge can show '!' or '✓' to indicate attention needed or success
  - Ownership status section includes an inline Action to update ownership flag
  - Complete action is disabled (not hidden) when ownership is pending - gives visual feedback
  - Hand-off to Module B is one-way operation - shows warning for unlinked inbounds
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-043
- What was implemented:
  - Status transitions were already fully implemented in InboundService (US-008)
  - Verified all acceptance criteria are met:
    - Valid transitions: recorded→routed, routed→completed (InboundStatus enum with allowedTransitions())
    - recorded→routed requires serialization_location - InboundService.route() validates and throws
    - routed→completed requires ownership_flag != pending - InboundService.complete() calls validateOwnershipClarity()
    - Invalid transitions generate user-friendly errors (InvalidArgumentException with explanation)
    - Every transition logs user_id and timestamp via logStatusTransition()
  - ViewInbound header actions call InboundService methods with try/catch for error handling
  - Typecheck and lint pass
- Files changed:
  - No new files (implementation was complete in previous iterations)
  - prd.json (marked US-043 as passes: true)
- **Learnings for future iterations:**
  - Inbound status transitions follow same pattern as other Module D entities
  - InboundService was implemented in US-008 with full transition validation
  - UI actions in ViewInbound call service methods and display Notification on success/error
---

## 2026-02-04 - US-044
- What was implemented:
  - Module B Hand-off was already fully implemented in InboundService (US-008)
  - ViewInbound header action for Hand-off added in US-042
  - Verified all acceptance criteria are met:
    - Action visible only when status = completed (ViewInbound isCompleted() check)
    - Validates ownership clarity - InboundService.handOffToModuleB() calls validateOwnershipClarity()
    - Validates serialization routing - InboundService.handOffToModuleB() calls validateSerializationRouting()
    - Sets handed_to_module_b = true, handed_to_module_b_at = now()
    - Creates AuditLog for Module B event (EVENT_FLAG_CHANGE)
    - Action is non-reversible - service throws error if already handed off, delete action hidden
  - Typecheck and lint pass
- Files changed:
  - No new files (implementation was complete in previous iterations)
  - prd.json (marked US-044 as passes: true)
- **Learnings for future iterations:**
  - Hand-off action in ViewInbound is disabled (not hidden) when canHandOffToModuleB() returns false
  - Modal description shows warning for unlinked inbounds requiring manual validation
  - Delete action is hidden once handed_to_module_b is true
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-045
- What was implemented:
  - Unlinked inbound handling was already implemented across multiple stories
  - Verified all acceptance criteria are met:
    - Inbound can be created without procurement_intent_id (CreateInbound shows warning, doesn't block)
    - Prominent badge in list: is_unlinked IconColumn with heroicon-o-link-slash
    - Prominent warning in detail: ViewInbound has "Unlinked Inbound" section with warning text
    - Filter in list: 'unlinked' toggle filter + "Unlinked" tab in ListInbounds
    - Manual review required before hand-off: ViewInbound hand-off modal shows warning
    - Dashboard widget for unlinked count - deferred to US-050+ dashboard stories
  - Typecheck and lint pass
- Files changed:
  - No new files (implementation was complete in previous iterations)
  - prd.json (marked US-045 as passes: true with note about dashboard)
- **Learnings for future iterations:**
  - Unlinked inbound flagging is a cross-cutting concern implemented in:
    - CreateInbound (warning during creation)
    - InboundResource list (icon column, filter, tab)
    - ViewInbound (dedicated warning section, hand-off modal warning)
  - Doesn't block operations but provides consistent visual warnings
  - Dashboard widget count will be added when implementing dashboard stories
---

## 2026-02-04 - US-046
- What was implemented:
  - New "Supplier Config" tab in ViewParty page (only visible for parties with Supplier/Producer roles)
  - Tab shows ProducerSupplierConfig read-only fields when config exists:
    - Default Bottling Deadline (days) with helper text
    - Allowed Formats (displayed as comma-separated list)
    - Serialization Constraints (parsed JSON with authorized_locations, required_location, notes)
    - Notes (general notes about the supplier)
  - Configuration Metadata section (collapsible) with config ID, created/updated dates
  - "Edit Config" action link to dedicated EditSupplierConfig page when config exists
  - "Create Config" action with modal form when config doesn't exist
  - EditSupplierConfig page with form for editing/creating config:
    - Bottling Defaults section: deadline days, allowed formats
    - Serialization Constraints section (KeyValue input)
    - Notes section
    - Save action creates audit log for creation/update
  - Tab badge shows "!" when no config exists (warning indicator)
- Files changed:
  - app/Filament/Resources/Customer/PartyResource.php (modified - added edit-supplier-config route)
  - app/Filament/Resources/Customer/PartyResource/Pages/ViewParty.php (modified - added Supplier Config tab)
  - app/Filament/Resources/Customer/PartyResource/Pages/EditSupplierConfig.php (new)
  - resources/views/filament/resources/customer/party-resource/pages/edit-supplier-config.blade.php (new)
- **Learnings for future iterations:**
  - Filament Page with form needs InteractsWithForms trait + HasForms interface
  - Use `/** @property Form $form */` docblock for PHPStan compatibility
  - Use `public array $data = []` instead of `$this->form->fill()` for form data initialization
  - Tab visibility controlled with `->visible(fn(): bool => ...)` closure
  - Tab badge with "!" indicator helps draw attention to missing config
  - Party.isSupplier() and Party.isProducer() helper methods useful for role checks
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-047
- What was implemented:
  - EditSupplierConfig page was already implemented in US-046
  - Verified all acceptance criteria are met:
    - Form in separate page (EditSupplierConfig.php)
    - Editable fields: default_bottling_deadline_days, allowed_formats, serialization_constraints, notes
    - Validation: deadline_days > 0 via minValue(1) on TextInput
    - Audit log created for creation (EVENT_CREATED) and update (EVENT_UPDATED)
  - Typecheck and lint pass
- Files changed:
  - No new files (implementation was done ahead in US-046)
  - prd.json (marked US-047 as passes: true)
- **Learnings for future iterations:**
  - When implementing wizard/form pages, implement all related features together
  - US-046 and US-047 overlap significantly - better to merge or implement together
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-048
- What was implemented:
  - SupplierProducerResource in Filament under navigation group "Procurement" (sort order 5)
  - Filtered view of parties where role = supplier OR producer via modifyQueryUsing with whereHas
  - List columns: party name (bold, searchable), roles (badges with icons/colors), has_config indicator (check/x icon), default_deadline (from supplierConfig), status (badge), jurisdiction (hidden by default), last_updated
  - Filters: role (Supplier/Producer), status, has_config (ternary), jurisdiction
  - Tabs: All, Suppliers, Producers, With Config, Without Config - each with badge counts
  - View Party action linking to PartyResource detail view
  - Manage Config action linking to EditSupplierConfig page (dynamic label/icon based on config existence)
  - Lightweight read-focused view: canCreate() returns false, no bulk actions
  - Default sort by legal_name ascending
- Files changed:
  - app/Filament/Resources/Procurement/SupplierProducerResource.php (new)
  - app/Filament/Resources/Procurement/SupplierProducerResource/Pages/ListSupplierProducers.php (new)
- **Learnings for future iterations:**
  - Filtered views of existing resources use modifyQueryUsing in table() for base filtering
  - Use whereHas('roles', ...) with whereIn() to filter parties by multiple roles
  - canCreate() override to false makes resource read-only
  - Action URLs can link to other resources using route() helper with named routes
  - Tab badges with badgeColor() highlight important states (e.g., warning for missing config)
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-049
- What was implemented:
  - ProducerSupplierConfigService class in app/Services/Procurement/
  - getOrCreate(Party $party): Returns existing config or creates new empty one, validates party has Supplier/Producer role
  - update(ProducerSupplierConfig $config, array $data): Updates config with validation and audit logging, only logs changed fields
  - getDefaultsForProduct(Party $party, $product): Returns applicable defaults array with deadline days, deadline date, allowed formats, serialization constraints, authorized locations, required location, has_config flag
  - Additional helper methods: isFormatAllowedForParty(), isSerializationLocationAuthorizedForParty(), getDefaultBottlingDeadlineForParty()
  - Full audit logging for creation (EVENT_CREATED) and update (EVENT_UPDATED) operations
  - Validation for deadline_days (must be positive int or null), allowed_formats (must be array or null), serialization_constraints (must be array or null)
- Files changed:
  - app/Services/Procurement/ProducerSupplierConfigService.php (new)
- **Learnings for future iterations:**
  - ProducerSupplierConfigService follows same pattern as other Procurement services (ProcurementIntentService, InboundService, BottlingInstructionService)
  - getOrCreate pattern useful for one-to-one optional relationships where config should exist when accessed
  - Audit log update method only logs fields that actually changed to avoid noise in audit trail
  - getDefaultsForProduct returns structured array with all relevant defaults for easy consumption by UI/other services
  - Party.isSupplier() and Party.isProducer() helper methods used for role validation
---

## 2026-02-04 - US-050
- What was implemented:
  - ProcurementDashboard page as control tower for Module D (app/Filament/Pages/ProcurementDashboard.php)
  - Blade view for dashboard (resources/views/filament/pages/procurement-dashboard.blade.php)
  - 4 main summary widgets: Active Intents, Pending Approvals, Pending Inbounds, Bottling Deadlines (30d)
  - Status distribution charts for Intents, POs, and Inbounds with progress bars
  - Bottling deadline tracking grid with 30/60/90 day horizons and past deadline alerts
  - Quick Actions section: Create Intent, Record Inbound, View Pending Approvals, contextual actions for exceptions
  - Problem areas sections: Awaiting Approval (intents), Pending Ownership (inbounds), Urgent Deadlines (<14d bottling)
  - Added Procurement navigation group to AdminPanelProvider (with heroicon-o-truck icon)
  - All tiles link to filtered lists for immediate action
  - Color-coded metrics: green (healthy), yellow (attention), red (critical)
- Files changed:
  - app/Filament/Pages/ProcurementDashboard.php (new)
  - resources/views/filament/pages/procurement-dashboard.blade.php (new)
  - app/Providers/Filament/AdminPanelProvider.php (modified - added Procurement navigation group)
- **Learnings for future iterations:**
  - Dashboard pages follow pattern: Page class with data methods + Blade view with Tailwind styling
  - Use `fi-section` classes for Filament-consistent card styling with dark mode support
  - Navigation groups must be registered in AdminPanelProvider.navigationGroups() to appear in sidebar
  - Use navigationSort = 0 to place dashboard first in navigation group (before resources)
  - Summary metrics link to filtered resource lists using Resource::getUrl('index', ['tableFilters' => [...]])
  - Status distribution charts use enum->label(), enum->color(), enum->icon() for consistent display
  - Problem area sections with "All Clear!" empty states provide positive feedback when no issues
  - Browser verification should be done manually as dev-browser skill is not available
---

## 2026-02-04 - US-051
- What was implemented:
  - Widget A: "Demand → Execution Knowability" added to Procurement Dashboard
  - Four metrics tracked with color-coded health status:
    1. Vouchers Awaiting Sourcing: Count of voucher-driven intents in draft/approved status
    2. Allocation-Driven Pending: Count of allocation-driven intents in draft/approved status
    3. Bottling Required Demand: Count of active bottling instructions with pending/partial preference status
    4. Inbound Overdue vs Expected: Ratio showing overdue POs against expected deliveries (30d window)
  - Health status helper method with thresholds: green (healthy), yellow (attention), red (critical)
  - Click navigation: Each metric links to its filtered list in the appropriate resource
  - Visual design: Grid layout with icons, background color coding, hover effects
  - Legend showing color meanings and click hint
- Files changed:
  - app/Filament/Pages/ProcurementDashboard.php (modified - added getDemandExecutionMetrics, getDemandExecutionHealthStatus, and URL helper methods)
  - resources/views/filament/pages/procurement-dashboard.blade.php (modified - added Widget A section)
- **Learnings for future iterations:**
  - Dashboard widgets follow pattern: PHP data method + Blade view with Tailwind styling
  - Health status thresholds should be tuned based on actual business requirements
  - Use match expressions with multiple return values for clean threshold logic
  - Filter URLs use tableFilters array structure that maps to Filament's filter system
  - Color coding: 'success' for healthy (0), 'warning' for attention (low count), 'danger' for critical (high count)
  - Browser verification should be done manually as dev-browser skill is not available
---
