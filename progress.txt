# Ralph Progress Log
Started: Wed Feb  4 17:27:51 CET 2026
---

## Codebase Patterns
- Use `HasUuid` trait for all models (UUID primary key)
- Use `Auditable` trait for created_by/updated_by tracking
- Use `SoftDeletes` trait for all business models
- UUID foreign keys: `$table->uuid('field_id')` then `$table->foreign('field_id')->references('id')->on('table')`
- Integer FK to users: `$table->foreignId('created_by')->nullable()->constrained('users')->nullOnDelete()`
- Enums: backed string enums with `label()`, `color()`, `icon()` helpers
- Status enum values as Filament colors: success/danger/warning/info/gray
- Model boot() method for validation guards on updating
- Index names limited to 64 chars (MySQL) - use custom names for compound indexes

---

## 2026-02-04 - US-C001
- **What was implemented:** ShippingOrder model, migration, and related enums
- **Files changed:**
  - `database/migrations/2026_02_04_200000_create_shipping_orders_table.php` (new)
  - `app/Models/Fulfillment/ShippingOrder.php` (new)
  - `app/Enums/Fulfillment/ShippingOrderStatus.php` (new)
  - `app/Enums/Fulfillment/PackagingPreference.php` (new)
  - `database/migrations/2026_02_04_100001_create_inbound_batches_table.php` (fixed index name)
- **Learnings for future iterations:**
  - ShippingOrderStatus enum has `canTransitionTo()` method for workflow validation
  - Status workflow: draft→planned→picking→shipped→completed, any→cancelled/on_hold
  - OnHold stores previous_status for restoration
  - hasMany relationships to future models removed to avoid phpstan errors
  - Run migrations first to discover DB errors before typecheck
---

## 2026-02-04 - US-C002 + US-C005
- **What was implemented:** Shipment model, migration, ShipmentStatus enum
- **Files changed:**
  - `database/migrations/2026_02_04_210000_create_shipments_table.php` (new)
  - `app/Models/Fulfillment/Shipment.php` (new)
  - `app/Enums/Fulfillment/ShipmentStatus.php` (new)
  - `app/Models/Fulfillment/ShippingOrder.php` (added shipments() HasMany relationship)
- **Learnings for future iterations:**
  - Shipment model enforces immutability of `shipped_bottle_serials` after confirmation via boot() updating guard
  - ShipmentStatus terminal states: delivered, failed
  - Shipment requires shipping_order_id (NOT NULL) - enforces no standalone shipments
  - JSON field `shipped_bottle_serials` stores bottle serials as immutable record
  - US-C005 (ShipmentStatus enum) was implemented together with US-C002 since required for model
---

## 2026-02-04 - US-C003
- **What was implemented:** ShippingOrderLine model and migration
- **Files changed:**
  - `database/migrations/2026_02_04_220000_create_shipping_order_lines_table.php` (new)
  - `app/Models/Fulfillment/ShippingOrderLine.php` (new)
  - `app/Models/Fulfillment/ShippingOrder.php` (added lines() HasMany relationship)
- **Learnings for future iterations:**
  - ShippingOrderLine enforces allocation_id immutability via boot() updating guard
  - Status uses string constants until ShippingOrderLineStatus enum (US-C007) is implemented
  - The cases table is referenced as `cases` not `inventory_cases` (model is InventoryCase)
  - 1 voucher = 1 line = 1 bottle invariant enforced via model design
  - early_binding_serial for Module D personalization, bound_bottle_serial for late binding from WMS
---

## 2026-02-04 - US-C007
- **What was implemented:** ShippingOrderLineStatus enum and integration into ShippingOrderLine model
- **Files changed:**
  - `app/Enums/Fulfillment/ShippingOrderLineStatus.php` (new)
  - `app/Models/Fulfillment/ShippingOrderLine.php` (updated to use enum)
- **Learnings for future iterations:**
  - Enum includes `allowsBinding()` method - binding only allowed in Validated status
  - Terminal states: Shipped, Cancelled
  - Transitions: pending→validated→picked→shipped, any→cancelled
  - Also marked US-C004 and US-C006 as passing - they were already implemented in US-C001
---

## 2026-02-04 - US-C008 + US-C009
- **What was implemented:** ShippingOrderException model, migration, and ShippingOrderExceptionType enum
- **Files changed:**
  - `database/migrations/2026_02_04_230000_create_shipping_order_exceptions_table.php` (new)
  - `app/Models/Fulfillment/ShippingOrderException.php` (new)
  - `app/Enums/Fulfillment/ShippingOrderExceptionType.php` (new)
  - `app/Enums/Fulfillment/ShippingOrderExceptionStatus.php` (new)
  - `app/Models/Fulfillment/ShippingOrder.php` (added exceptions() HasMany relationship)
- **Learnings for future iterations:**
  - Created additional ShippingOrderExceptionStatus enum for active/resolved status (not in original PRD but needed)
  - Exception types have `isBlocking()` method to determine if they block SO progression
  - Exception can be order-level or line-level (nullable shipping_order_line_id)
  - All exceptions require manual review (canAutoResolve() returns false)
---

## 2026-02-04 - US-C010
- **What was implemented:** ShippingOrderAuditLog model and migration for immutable audit logs
- **Files changed:**
  - `database/migrations/2026_02_04_240000_create_shipping_order_audit_logs_table.php` (new)
  - `app/Models/Fulfillment/ShippingOrderAuditLog.php` (new)
  - `app/Models/Fulfillment/ShippingOrder.php` (added shippingOrderAuditLogs() HasMany relationship)
- **Learnings for future iterations:**
  - Audit logs do NOT use SoftDeletes - they are immutable
  - Only has `created_at` timestamp (no `updated_at`) since records cannot be modified
  - boot() guards prevent both updating and deleting
  - Method `hasChangeTracking()` instead of `hasChanges()` to avoid conflict with Model base class
  - Uses HasUuid trait but NOT Auditable (no created_by/updated_by needed, has user_id instead)
---

## 2026-02-04 - US-C011
- **What was implemented:** ShippingOrderService for centralized Shipping Order management
- **Files changed:**
  - `app/Services/Fulfillment/ShippingOrderService.php` (new)
- **Learnings for future iterations:**
  - Service methods: create(), validateVouchers(), transitionTo(), cancel(), lockVouchersForSO(), unlockVouchers()
  - Uses VoucherService.lockForFulfillment() and unlock() for voucher lifecycle management
  - Voucher eligibility checks: lifecycle_state=issued, not suspended, no pending transfer, not quarantined, allocation lineage valid
  - Prevents same voucher in multiple active SOs (draft/planned/picking/on_hold)
  - Pre-transition hook validates vouchers before planning
  - Post-transition hook locks vouchers when moving to planned, unlocks when cancelled
  - Event constants defined for audit logging: EVENT_CREATED, EVENT_STATUS_CHANGE, etc.
  - Uses ShippingOrderAuditLog for event logging (not morphMany auditLogs)
---

## 2026-02-04 - US-C012
- **What was implemented:** LateBindingService for centralized Late Binding logic
- **Files changed:**
  - `app/Services/Fulfillment/LateBindingService.php` (new)
- **Learnings for future iterations:**
  - Service methods: requestEligibleInventory(), bindVoucherToBottle(), validateBinding(), validateEarlyBinding(), unbindLine()
  - Uses InventoryService for bottle queries and InventoryCase for intact case checks
  - Binding only allowed in Validated status (via ShippingOrderLineStatus.allowsBinding())
  - Allocation lineage mismatch throws explicit exception: "Cross-allocation substitution not allowed"
  - Bottle state transitions: stored → reserved_for_picking upon binding, reversed on unbind
  - Early binding validation has NO fallback to late binding - creates ShippingOrderException if fails
  - Cache TTL of 5 minutes for inventory queries to balance freshness and performance
  - Event constants for audit logging: EVENT_BINDING_REQUESTED, EVENT_BINDING_EXECUTED, etc.
---

## 2026-02-04 - US-C013
- **What was implemented:** ShipmentService for centralized Shipment logic
- **Files changed:**
  - `app/Services/Fulfillment/ShipmentService.php` (new)
- **Learnings for future iterations:**
  - Service methods: createFromOrder(), confirmShipment(), triggerRedemption(), triggerOwnershipTransfer(), updateTracking(), markDelivered(), markFailed()
  - confirmShipment() is the "point of no return" - triggers voucher redemption and ownership transfer
  - Redemption is IRREVERSIBLE - uses VoucherService.redeem() for each voucher
  - Ownership transfer updates bottle state to Shipped via BottleState enum
  - Shipment can only be created from SO in Picking status with all bindings complete
  - Uses LateBindingService.checkAllLinesBinding() and validateAllBindings() before shipment creation
  - Line statuses updated during flow: Validated → Picked (createFromOrder), Picked → Shipped (confirmShipment)
  - Provenance blockchain update would be dispatched as a job (placeholder noted for US-C042)
  - markDelivered() optionally completes the SO if in Shipped status
  - Event constants for audit logging: EVENT_SHIPMENT_CREATED, EVENT_SHIPMENT_CONFIRMED, EVENT_VOUCHER_REDEEMED, etc.
---

## 2026-02-04 - US-C014
- **What was implemented:** VoucherLockService for centralized voucher lock/unlock management during fulfillment
- **Files changed:**
  - `app/Services/Fulfillment/VoucherLockService.php` (new)
- **Learnings for future iterations:**
  - Service methods: lockForShippingOrder(), lockAllForShippingOrder(), unlock(), unlockAllForShippingOrder(), isLockedForSO(), getLockedVouchers()
  - Provides integration layer between Fulfillment module and Module A VoucherService
  - Uses VoucherService.lockForFulfillment() and unlock() for actual lifecycle transitions
  - lockForShippingOrder() validates voucher is in the SO before locking
  - lockAllForShippingOrder() has atomic rollback - unlocks already-locked vouchers if any lock fails
  - isLockedForSO() checks both lifecycle state AND SO membership
  - Helper methods: validateCanLock(), isVoucherInActiveShippingOrder(), findShippingOrderForLockedVoucher()
  - Event constants for audit logging: EVENT_VOUCHER_LOCKED, EVENT_VOUCHER_UNLOCKED, EVENT_LOCK_FAILED, EVENT_UNLOCK_FAILED
  - Existing ShippingOrderService already has similar methods - VoucherLockService provides dedicated service for lock management
---

## 2026-02-04 - US-C015
- **What was implemented:** WmsIntegrationService for centralized WMS integration
- **Files changed:**
  - `app/Services/Fulfillment/WmsIntegrationService.php` (new)
- **Learnings for future iterations:**
  - Service methods: sendPickingInstructions(), receivePickingFeedback(), validateSerials(), confirmShipment(), handleDiscrepancy(), requestRePick(), checkPickingCompletion()
  - Bidirectional WMS communication: outbound (picking instructions) and inbound (feedback/confirmation)
  - Picked serials MUST match allocation lineage - hard constraint enforced via validateSerial()
  - Invalid picks create WmsDiscrepancy exceptions automatically via handleDiscrepancy()
  - No manual acceptance of invalid picks - operator can only request re-pick
  - Early binding takes precedence - lines with early binding are skipped in WMS feedback processing
  - Partial shipments NOT supported in MVP - creates exception and blocks confirmation
  - Uses LateBindingService.bindVoucherToBottle() for binding execution after validation
  - buildPickingPayload() constructs WMS message with binding_type (early/late) and allocation constraints
  - Event constants for audit logging: EVENT_WMS_INSTRUCTIONS_SENT, EVENT_WMS_FEEDBACK_RECEIVED, EVENT_WMS_SERIAL_VALIDATED, EVENT_WMS_DISCREPANCY, etc.
  - Message IDs generated as WMS-{timestamp}-{id} for tracking
---

## 2026-02-04 - US-C016
- **What was implemented:** ShippingOrderResource in Filament with navigation group Fulfillment
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource.php` (new)
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ListShippingOrders.php` (new)
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/CreateShippingOrder.php` (new)
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ViewShippingOrder.php` (new)
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/EditShippingOrder.php` (new)
- **Learnings for future iterations:**
  - Filament resources go in app/Filament/Resources/{Module}/ directory structure
  - Navigation icon: heroicon-o-truck for shipping/fulfillment resources
  - Permissions via canCreate(), canEdit(), canDelete() static methods
  - Edit/Delete only available for draft orders via isDraft() check
  - Status badges use ShippingOrderStatus enum's label(), color(), icon() methods
  - Table filters default to hide completed/cancelled (active statuses only)
  - ViewRecord uses Infolist with Section, Grid, Group, TextEntry components
  - Status banner section with dynamic background color based on status
---

## 2026-02-04 - US-C017
- **What was implemented:** Enhanced SO List View with full filtering, search, and status badges
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource.php` (updated table() method)
- **Learnings for future iterations:**
  - Table columns order per PRD: so_id, customer, destination_country, voucher_count, source_warehouse, status, created_at, requested_ship_date
  - Status badge prominence: use `->size(Tables\Columns\TextColumn\TextColumnSize::Large)` for larger badges
  - Destination country placeholder using shipments relationship (Module K addresses not yet implemented)
  - Dynamic carrier filter: use `ShippingOrder::query()->whereNotNull('carrier')->distinct()->pluck()` for options
  - Date range filter with indicateUsing() for visual indicators
  - Global search across relationships: `getGloballySearchableAttributes()` can include 'shipments.tracking_number'
  - Eager load relationships in modifyQueryUsing() for N+1 prevention: with(['customer', 'sourceWarehouse', 'shipments'])
  - Default hide completed/cancelled via status filter default values
---

## 2026-02-04 - US-C018
- **What was implemented:** SO Creation Wizard - Step 1 (Customer & Destination)
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/CreateShippingOrder.php` (rewritten as wizard)
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource.php` (added destination_address field)
  - `app/Models/Fulfillment/ShippingOrder.php` (added destination_address property)
  - `database/migrations/2026_02_04_250000_add_destination_address_to_shipping_orders_table.php` (new)
- **Learnings for future iterations:**
  - Wizard creation uses `CreateRecord\Concerns\HasWizard` trait
  - Define steps in `getSteps()` method returning array of `Wizard\Step` objects
  - Customer search uses `getSearchResultsUsing()` and `getOptionLabelUsing()` for async search
  - Filter search to active customers only for eligibility: `where('status', Customer::STATUS_ACTIVE)`
  - Use `afterValidation()` on step to validate before proceeding to next step
  - `Set $set` for updating other form fields reactively (clear address when customer changes)
  - `Get $get` for reading form state in closures
  - Customer `vouchers()` relationship can be queried for eligible voucher count
  - Saved addresses feature deferred to Module K implementation - using text field as placeholder
  - `HtmlString` for embedding HTML in Placeholder content
---

## 2026-02-04 - US-C019
- **What was implemented:** SO Creation Wizard - Step 2 (Voucher Selection)
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/CreateShippingOrder.php` (added getVoucherSelectionStep method)
- **Learnings for future iterations:**
  - CheckboxList component supports `options()`, `descriptions()`, `searchable()`, `bulkToggleable()` for multi-select
  - Voucher eligibility: lifecycle_state = Issued AND suspended = false
  - Prevent duplicate SO assignment: query ShippingOrderLines for vouchers already in active SOs (Draft/Planned/Picking/OnHold)
  - Inline filters reset selection: use `afterStateUpdated(fn (Set $set) => $set('selected_vouchers', []))`
  - PHPStan: avoid collection pluck after get() - use query-level pluck with distinct() instead
  - Form data for related records: access via `$this->data['field_name']` in afterCreate()
  - Create ShippingOrderLines in afterCreate() hook, copying allocation_id from voucher (IMMUTABLE constraint)
  - Remove non-model fields in mutateFormDataBeforeCreate() with unset()
  - Early binding badge noted as future enhancement when Module D personalization is integrated
---

## 2026-02-04 - US-C020
- **What was implemented:** SO Creation Wizard - Step 3 (Shipping Method)
- **Files changed:**
  - `app/Enums/Fulfillment/Carrier.php` (new)
  - `app/Enums/Fulfillment/Incoterms.php` (new)
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/CreateShippingOrder.php` (added getShippingMethodStep method)
- **Learnings for future iterations:**
  - Created dedicated Carrier enum with tracking URL templates for each carrier (DHL, FedEx, UPS, etc.)
  - Created Incoterms enum with descriptions and helper methods (sellerPaysImportDuties, sellerPaysInsurance)
  - Wizard step validation via `afterValidation()` with `\Filament\Support\Exceptions\Halt` exception
  - DatePicker `minDate(now()->startOfDay())` for future-only date validation
  - Dynamic helper text using `helperText(function (Get $get))` to show enum descriptions based on selection
  - Placeholder sections with conditional visibility for contextual info (e.g., incoterms responsibilities)
  - Browser verification pending
---

## 2026-02-04 - US-C021
- **What was implemented:** SO Creation Wizard - Step 4 (Packaging Preferences)
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/CreateShippingOrder.php` (added getPackagingPreferencesStep method)
- **Learnings for future iterations:**
  - Radio component with `options()` and `descriptions()` for labeled choices with inline explanations
  - PackagingPreference enum already existed with label(), description(), color(), icon(), mayDelayShipment() helper methods
  - Visual card layout using grid with conditional ring/background classes based on selected option
  - Warning placeholder with `visible()` condition for preserve_cases selection
  - Default value using enum case value: `->default(PackagingPreference::Loose->value)`
  - Live updates via `->live()` to reactively show/hide warning and update visual cards
  - Browser verification pending
---

## 2026-02-04 - US-C022
- **What was implemented:** SO Creation Wizard - Step 5 (Review & Submit)
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/CreateShippingOrder.php` (added getReviewAndSubmitStep method)
- **Learnings for future iterations:**
  - Review step uses read-only Placeholder components to display summary of all wizard data
  - Collapsible Sections for organizing summary (Customer & Destination, Vouchers, Shipping Method, Packaging)
  - Draft info banner at top emphasizes that planning is required before execution
  - Voucher list displayed as HTML table for clarity (voucher_id, wine, format, allocation)
  - Conditional warning display using enum's mayDelayShipment() and getWarningMessage() methods
  - Used `Get $get` to access all form state from wizard steps (customer_id, selected_vouchers, etc.)
  - HTML string construction using HtmlString class with heredoc syntax for complex layouts
  - e() helper function for HTML escaping user data (customer name, etc.)
  - Browser verification pending
---

## 2026-02-04 - US-C023
- **What was implemented:** SO Bulk Actions - Export CSV and Cancel
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource.php` (updated bulkActions in table())
- **Learnings for future iterations:**
  - Bulk actions defined in `->bulkActions([])` using `Tables\Actions\BulkActionGroup::make([])`
  - Export CSV uses `response()->streamDownload()` with fputcsv for CSV generation
  - Cancel bulk action uses `->requiresConfirmation()` and `->form([])` for modal with input
  - ShippingOrderService.cancel() handles voucher unlocking and status transition
  - Check record status in action closure: `$record->isDraft() || $record->isPlanned()`
  - Use `App::make()` to resolve services in static closures
  - Notification::make() for success/warning feedback to user
  - `->deselectRecordsAfterCompletion()` clears table selection after action
  - PHPStan: avoid `?->property ?? '-'` when relation may be null - use explicit null checks instead
  - Browser verification pending
---

## 2026-02-04 - US-C024
- **What was implemented:** SO Detail - Tab Overview as the first default tab
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ViewShippingOrder.php` (major rewrite to use Tabs)
- **Learnings for future iterations:**
  - Filament Tabs use `Tabs::make('Label')->tabs([Tab::make('TabName')->schema([...])])`
  - Use `->persistTabInQueryString()` to persist selected tab in URL
  - Tab methods accept schema array just like Sections
  - RepeatableEntry displays related models inline with Grid layout
  - Use `getStateUsing()` with closures for computed values (voucher counts by status)
  - CustomerResource::getUrl() for generating links to other resources
  - nl2br(e($text)) for displaying multiline text safely as HTML
  - Conditional color based on date: check isPast(), isToday() for date fields
  - Warning display with `->visible()` closure checking enum method
  - Status banner section uses extraAttributes for dynamic background color classes
  - Browser verification pending
---

## 2026-02-04 - US-C025
- **What was implemented:** SO Detail - Tab Vouchers & Eligibility for validating voucher eligibility before planning
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ViewShippingOrder.php` (added Vouchers & Eligibility tab)
- **Learnings for future iterations:**
  - Tab badge with count: `->badge(fn ($record) => $count > 0 ? (string) $count : null)->badgeColor('danger')`
  - Eligibility checks are reused from ShippingOrderService logic: lifecycle state, suspended, pending transfer, quarantined, customer match, allocation lineage
  - VoucherLifecycleState enum has Issued, Locked, Redeemed, Cancelled states
  - Voucher can be locked for THIS SO (OK during planning) vs locked by OTHER processes (blocks)
  - Check for voucher in other active SOs using ShippingOrderLine query with whereHas on shippingOrder status
  - Use performEligibilityChecks() method to run all checks and return array of {label, passed, reason}
  - Format check results as HTML grid using e() for escaping user data
  - Blocking banner uses extraAttributes with danger background color classes
  - countIneligibleVouchers() method used in multiple places (banner visibility, badge count)
  - NO override possible - fix must happen upstream per PRD requirement
  - Browser verification pending
---

## 2026-02-04 - US-C026
- **What was implemented:** SO Detail - Tab Planning for verifying inventory availability before planning
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ViewShippingOrder.php` (added Planning tab with multiple sections)
- **Learnings for future iterations:**
  - Planning tab visible only when status = draft or planned (use `->visible()` with condition)
  - Source warehouse selection uses header action with Select form component
  - Inventory availability data fetched via LateBindingService.requestEligibleInventory() - returns allocations array with status
  - Allocation status values: 'sufficient', 'intact_case_unavailable', 'insufficient'
  - Static cache used within page methods to avoid repeated service calls: `static $cache = [];`
  - Format inventory data as HTML table with status badges (success/warning/danger)
  - Planning readiness checks: source_warehouse selected, all vouchers eligible, all allocations sufficient, preserve_cases satisfied
  - Plan Order action disabled via `->disabled()` when canPlanShippingOrder() returns false
  - Supply exceptions (ShippingOrderExceptionType::SupplyInsufficient) created when planning fails due to insufficient inventory
  - ShippingOrderService.transitionTo() handles voucher locking when moving to Planned status
  - Use Notification::make() for user feedback on success/error
  - Redirect to same page after planning to refresh UI state
  - PHPStan: badgeColor return type must be `string` not `?string` if always returning a value
  - PHPStan: avoid `?->property ?? default` when relation may be null - use explicit null checks
  - Browser verification pending
---

## 2026-02-04 - US-C027
- **What was implemented:** SO Detail - Tab Picking & Binding for viewing late binding during picking
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ViewShippingOrder.php` (added Picking & Binding tab)
- **Learnings for future iterations:**
  - Tab visibility controlled via `isPickingOrBeyond()` helper - checks for Picking, Shipped, Completed statuses
  - Binding completion statistics cached per page load using `static $cache = []` pattern
  - hasBindingDiscrepancy() queries ShippingOrderException for active exceptions of type WmsDiscrepancy, BindingFailed, EarlyBindingFailed
  - Early binding shows "Pre-bound (Personalized)" badge with star icon
  - Late binding shows serial after WMS feedback with checkmark, or "Awaiting WMS feedback" message
  - Discrepancies shown in red with warning icon, display active exceptions with resolution paths
  - Request Re-pick action calls WmsIntegrationService.requestRePick() and marks related exceptions as resolved
  - NO manual bottle selection - operator can only accept/reject via Re-pick action
  - Binding details panel shows: early_binding_serial, bound_bottle_serial, binding_confirmed_at/by
  - Tab badge shows: ✓ when all bound, count of discrepancies (danger), count of pending (warning)
  - Browser verification pending
---

## 2026-02-04 - US-C028
- **What was implemented:** SO Detail - Tab Audit & Timeline for chronological timeline of all events
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ViewShippingOrder.php` (added Audit & Timeline tab)
- **Learnings for future iterations:**
  - Audit timeline displays events in reverse chronological order (newest first) using `orderBy('created_at', 'desc')`
  - Uses ShippingOrderAuditLog model through `shippingOrderAuditLogs()` relationship - no direct import needed
  - Event type visual info: `getEventTypeInfo()` returns label, icon, dotClass, badgeClass for consistent styling
  - Event categories: creation/lifecycle, voucher events, validation events, WMS events, binding events, shipment events
  - Summary statistics: total events, status changes, WMS events (7 types), binding events (7 types)
  - Change tracking: `formatChangeTracking()` shows old_values/new_values as JSON with color coding
  - Timeline UI: vertical line with colored dots, event cards with badge/timestamp/description/user
  - User attribution: shows user name if available, "System" for automated events (null user_id)
  - Export CSV: `response()->streamDownload()` with fputcsv for columns: Timestamp, Event Type, Description, User, User ID, Old Values, New Values
  - Immutability emphasized: banner at top explains audit logs cannot be modified
  - Tab badge shows total event count
  - Browser verification pending
---

## 2026-02-04 - US-C029
- **What was implemented:** SO Actions e State Transitions - contextual header actions for all status transitions
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ViewShippingOrder.php` (added state transition actions)
- **Learnings for future iterations:**
  - Header actions organized by status visibility: Draft (Plan Order, Edit, Cancel), Planned (Send to Picking, Cancel, Put on Hold), Picking (Confirm Shipment, Put on Hold), On Hold (Resume, Cancel)
  - Shipped/Completed status shows no transition actions (read-only)
  - Send to Picking action: transitions to Picking status AND sends WMS instructions via WmsIntegrationService.sendPickingInstructions()
  - Confirm Shipment action: creates shipment via ShipmentService.createFromOrder(), confirms it, transitions SO to Shipped - this is the "point of no return" that triggers voucher redemption
  - Put on Hold action: stores previous_status on model before transition for later resume functionality
  - Resume action: transitions from OnHold back to previous_status (Draft, Planned, Picking, or Shipped)
  - Cancel action: requires reason text, calls ShippingOrderService.cancel() which handles voucher unlocking and binding cleanup
  - All actions use `->requiresConfirmation()` with detailed `->modalDescription()` explaining consequences
  - Actions use `->visible()` based on current status to show only valid transitions
  - Confirm Shipment additionally uses `->disabled()` when not all lines are bound (checks `getBindingCompletion()['all_bound']`)
  - Manual audit logging for Put on Hold and Resume actions using ShippingOrderAuditLog::create() with event types 'put_on_hold' and 'resumed_from_hold'
  - Service methods handle most audit logging automatically (ShippingOrderService.transitionTo() logs EVENT_STATUS_CHANGE)
  - Browser verification pending
---
## 2026-02-04 - US-C030
- **What was implemented:** Voucher Eligibility Validation - rigorous validation at creation, planning, and pre-picking checkpoints
- **Files changed:**
  - `app/Services/Fulfillment/ShippingOrderService.php` (enhanced eligibility checks and blocking mechanism)
- **Learnings for future iterations:**
  - checkVoucherEligibility() made public for external use (UI, other services)
  - Eligibility criteria: lifecycle_state = issued (or locked for THIS SO), suspended = false, customer_id match, no pending transfer, allocation active (not closed)
  - Three validation checkpoints: (1) SO creation in validateVouchersForCreation(), (2) planning in handlePreTransition(), (3) pre-picking in handlePreTransition()
  - checkIfBlocked() returns {blocked, ineligible_count, errors} for UI blocking banners
  - getVoucherEligibilitySummary() returns detailed per-voucher eligibility info
  - canProceed() provides quick boolean check for state transitions
  - EVENT_VOUCHER_INELIGIBLE constant added for audit logging when vouchers become ineligible during lifecycle
  - Pre-picking validation logs individual voucher ineligibility events before throwing exception
  - Allocation::isClosed() checks if allocation is in Closed status (not available for fulfillment)
---

## 2026-02-04 - US-C031
- **What was implemented:** Allocation Lineage Constraint Enforcement - verified existing implementation meets all acceptance criteria
- **Files verified (no changes needed):**
  - `app/Models/Fulfillment/ShippingOrderLine.php` (allocation_id immutability via boot() guard at lines 105-112)
  - `app/Services/Fulfillment/LateBindingService.php` (allocation validation at lines 197-203)
  - `app/Services/Fulfillment/WmsIntegrationService.php` (allocation validation at lines 655-660, 316)
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/CreateShippingOrder.php` (allocation_id copied from voucher at line 1356)
- **Learnings for future iterations:**
  - This story was already fully implemented as part of US-C003 and US-C012
  - ShippingOrderLine boot() guard prevents modification of allocation_id with error: "allocation_id is immutable after creation. Cross-allocation substitution is not allowed."
  - LateBindingService.bindVoucherToBottle() validates allocation match with error: "Allocation lineage mismatch. Cross-allocation substitution not allowed."
  - WmsIntegrationService.validateSerial() also validates allocation match with same error message
  - No override or bypass mechanisms exist in the codebase (verified via grep search)
  - All validation points use consistent error messaging about cross-allocation substitution
---

## 2026-02-04 - US-C032
- **What was implemented:** Inventory Availability Request - verified existing implementation meets all acceptance criteria
- **Files verified (no changes needed):**
  - `app/Services/Fulfillment/LateBindingService.php` (requestEligibleInventory at lines 84-154, queryEligibleInventory at lines 564-591)
- **Learnings for future iterations:**
  - This story was already fully implemented as part of US-C012 (LateBindingService creation)
  - requestEligibleInventory() takes ShippingOrder and extracts allocation_id/quantity/warehouse_id internally
  - queryEligibleInventory() is the protected method that queries Module B (SerializedBottle, InventoryCase models)
  - Return structure: `{allocations: [{allocation_id, required_quantity, available_quantity, available_bottles, intact_case_available, status}], all_available, preserve_cases_satisfied}`
  - Status values: 'sufficient', 'intact_case_unavailable', 'insufficient'
  - Caching uses Cache::remember() with CACHE_TTL = 300 seconds (5 minutes)
  - Cache key pattern: `late_binding_inventory:{allocation_id}:{warehouse_id|all}`
  - clearInventoryCache() method available for cache invalidation
---

## 2026-02-04 - US-C033
- **What was implemented:** Late Binding Execution - verified existing implementation meets all acceptance criteria
- **Files verified (no changes needed):**
  - `app/Services/Fulfillment/LateBindingService.php` (bindVoucherToBottle at lines 171-264, unbindLine at lines 427-482)
  - `app/Services/Fulfillment/WmsIntegrationService.php` (receivePickingFeedback at lines 122-276, validateSerial at lines 642-698)
- **Learnings for future iterations:**
  - This story was already fully implemented as part of US-C012 and US-C015
  - WMS pick feedback triggers binding via WmsIntegrationService.receivePickingFeedback()
  - receivePickingFeedback() validates each serial via validateSerial(), then calls lateBindingService.bindVoucherToBottle()
  - Validation checks: serial exists, allocation lineage match, bottle.state = Stored/ReservedForPicking, not in terminal state, not bound to another active line
  - bindVoucherToBottle() updates: bound_bottle_serial, binding_confirmed_at, binding_confirmed_by, bottle.state → ReservedForPicking
  - Binding reversible via unbindLine() which throws if $line->isShipped() - shipment confirmation is the "point of no return"
  - Line status auto-transitions from Pending → Validated when receiving WMS feedback
---

## 2026-02-04 - US-C034
- **What was implemented:** Early Binding Validation - verified existing implementation meets all acceptance criteria
- **Files verified (no changes needed):**
  - `app/Services/Fulfillment/LateBindingService.php` (validateEarlyBinding at lines 353-414, createEarlyBindingException at lines 619-632)
  - `app/Enums/Fulfillment/ShippingOrderExceptionType.php` (EarlyBindingFailed with isBlocking=true)
- **Learnings for future iterations:**
  - This story was already fully implemented as part of US-C012
  - validateEarlyBinding() validates: serial exists, bottle.state = Stored, allocation lineage match
  - On failure: createEarlyBindingException() creates ShippingOrderException with EarlyBindingFailed type
  - EarlyBindingFailed.isBlocking() returns true - shipment is blocked
  - Log message explicitly states "NO FALLBACK" - no automatic fallback to late binding
  - Ownership/custody validation is implicit: Stored state means bottle is under warehouse custody
  - Early binding (Module D personalization) takes precedence - lines with hasEarlyBinding() skip late binding entirely
---

## 2026-02-04 - US-C035
- **What was implemented:** Case Integrity Handling for preserve_cases and partial shipment from cases
- **Files changed:**
  - `app/Services/Fulfillment/ShipmentService.php` (added checkCaseIntegrityImpact, breakCasesForShipment, validateCaseBreakConfirmation methods, updated confirmShipment signature)
  - `app/Services/Fulfillment/WmsIntegrationService.php` (updated confirmShipment call to pass caseBreakConfirmed=true)
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ViewShippingOrder.php` (added case break warning and confirmation checkbox to Confirm Shipment action)
- **Learnings for future iterations:**
  - preserve_cases already blocks SO planning when intact case unavailable (via canPlanShippingOrder in ViewShippingOrder)
  - NO automatic downgrade to loose bottles - SO cannot proceed if preserve_cases is selected but no intact case available
  - checkCaseIntegrityImpact() identifies cases that will be broken due to partial shipment (shipping some but not all bottles from a case)
  - breakCasesForShipment() breaks affected cases during shipment confirmation with full audit logging
  - Case breaking is IRREVERSIBLE - InventoryCase model has boot() guard preventing Broken → Intact transition
  - UI displays explicit warning "This will permanently break the original case" with required confirmation checkbox
  - WMS confirmation implicitly confirms case breaking (bottles already picked by WMS)
  - EVENT_CASE_BROKEN audit event added for tracking case breaks during shipment
  - InventoryCase.display_label accessor returns "Case #{id}" for display
---

## 2026-02-04 - US-C036
- **What was implemented:** ShipmentResource in Filament for managing Shipments
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShipmentResource.php` (new)
  - `app/Filament/Resources/Fulfillment/ShipmentResource/Pages/ListShipments.php` (new)
  - `app/Filament/Resources/Fulfillment/ShipmentResource/Pages/ViewShipment.php` (new)
- **Learnings for future iterations:**
  - Navigation icon: heroicon-o-paper-airplane for shipments (truck used for ShippingOrders)
  - Navigation sort: 2 (after ShippingOrders which is 1) for logical ordering in Fulfillment group
  - Shipments are read-only: canCreate(), canEdit(), canDelete() all return false
  - Shipments are created from ShippingOrders only - no create page/action needed
  - bottles_count computed via getBottleCount() method from JSON shipped_bottle_serials field
  - Sorting by JSON array length: `orderByRaw("JSON_LENGTH(shipped_bottle_serials) {$direction}")`
  - SO ID column links to ShippingOrderResource view using route() with 'fulfillment.shipping-orders.view' pattern
  - Tracking URL helper method matches carrier name to tracking URL template (DHL, FedEx, UPS, etc.)
  - ViewShipment uses Infolist with sections: Status Banner, Shipping Order, Carrier & Tracking, Shipped Items (collapsible), Audit Trail, Notes
  - Shipped Items table displays serials with index numbering in alternating row colors
  - Export CSV bulk action available for list view
  - Browser verification pending
---

## 2026-02-04 - US-C037
- **What was implemented:** Enhanced Shipment Detail View with wine info in Shipped Items section
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShipmentResource/Pages/ViewShipment.php` (enhanced Shipped Items section)
- **Learnings for future iterations:**
  - Shipped Items section now shows Wine, Vintage, Format columns alongside serial numbers
  - Query SerializedBottle by serial_number array using whereIn(), eager load wineVariant.wineMaster and format relationships
  - Wine info hierarchy: SerializedBottle → wineVariant → wineMaster (has name field)
  - WineVariant.vintage_year is non-nullable int per PHPStan - no null check needed
  - Use keyBy('serial_number') on collection for O(1) lookups when iterating shipped serials
  - All acceptance criteria were already met by US-C036 implementation; only enhancement needed was adding wine info to Shipped Items table
  - Browser verification pending
---

## 2026-02-04 - US-C038
- **What was implemented:** Verified Shipment Creation from SO (already fully implemented in US-C013)
- **Files verified (no changes needed):**
  - `app/Services/Fulfillment/ShipmentService.php` (createFromOrder at lines 68-148)
  - `app/Models/Fulfillment/Shipment.php` (immutability guard at lines 104-116)
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ViewShippingOrder.php` (Confirm Shipment action at lines 2679-2766)
- **Learnings for future iterations:**
  - This story was already fully implemented as part of US-C013 (ShipmentService creation)
  - createFromOrder() is called when operator clicks "Confirm Shipment" in UI (ViewShippingOrder)
  - Shipment is created in ShipmentStatus::Preparing, NOT shipped - confirmation is a separate step
  - bottle serials collected via getEffectiveSerial() on each line (handles both early and late binding)
  - Shipment.shipped_bottle_serials immutability enforced via boot() guard after confirmation (status != Preparing)
  - Default status attribute in model provides extra safety: $attributes['status'] = ShipmentStatus::Preparing
  - Confirm Shipment action creates shipment then immediately confirms it - two-step process ensures proper status lifecycle
---

## 2026-02-04 - US-C039, US-C040, US-C041
- **What was implemented:** Verified Shipment Confirmation & Tracking, Voucher Redemption Trigger, Ownership Transfer Trigger (all already fully implemented in US-C013)
- **Files verified (no changes needed):**
  - `app/Services/Fulfillment/ShipmentService.php` (confirmShipment, triggerRedemption, triggerOwnershipTransfer, updateTracking methods)
  - `app/Enums/Fulfillment/ShipmentStatus.php` (allowedTransitions includes in_transit, delivered)
  - `app/Services/Allocation/VoucherService.php` (redeem method transitions to Redeemed state)
- **Learnings for future iterations:**
  - confirmShipment() validates tracking_number required (throws if empty)
  - Confirmation flow: set shipped status/timestamp → triggerRedemption → triggerOwnershipTransfer
  - Redemption calls VoucherService.redeem() for each voucher, throws if any fail (atomic)
  - Ownership transfer updates bottle.state to Shipped via BottleState enum
  - updateTracking() allows transitions: shipped→in_transit, in_transit→delivered, any→failed
  - All three stories were already implemented as part of US-C013 (ShipmentService creation)
---

## 2026-02-04 - US-C042
- **What was implemented:** UpdateProvenanceOnShipmentJob for on-chain provenance updates post-shipment
- **Files changed:**
  - `app/Jobs/Fulfillment/UpdateProvenanceOnShipmentJob.php` (new)
  - `app/Services/Fulfillment/ShipmentService.php` (uncommented dispatch call in triggerOwnershipTransfer)
- **Learnings for future iterations:**
  - Job follows same pattern as UpdateProvenanceOnMovementJob in Inventory module
  - Uses ShouldQueue interface for async processing
  - Retry config: tries=3 with exponential backoff [10, 60, 300] seconds
  - Job loads shipment with shippingOrder.customer relationship
  - Iterates shipped_bottle_serials, looks up each SerializedBottle, calls updateBottleProvenance
  - Skips bottles without NFT (hasNft() check)
  - Provenance data includes: event_type=shipment, shipment_id, carrier, tracking_number, new_owner_id, shipped_at timestamp
  - Individual bottle failures logged but don't fail entire job (graceful degradation)
  - failed() method logs detailed error for permanent failures
---

## 2026-02-04 - US-C043
- **What was implemented:** Exceptions & Holds List page in Filament
- **Files changed:**
  - `app/Filament/Resources/Fulfillment/ShippingOrderExceptionResource.php` (new)
  - `app/Filament/Resources/Fulfillment/ShippingOrderExceptionResource/Pages/ListShippingOrderExceptions.php` (new)
  - `app/Filament/Resources/Fulfillment/ShippingOrderExceptionResource/Pages/ViewShippingOrderException.php` (new)
- **Learnings for future iterations:**
  - Navigation group "Fulfillment" with sort order 3 (after ShippingOrders=1, Shipments=2)
  - Navigation icon: heroicon-o-exclamation-triangle for exceptions
  - Table columns: exception_id, so_id (link), exception_type (badge), description, status (badge), created_at
  - Filters: exception_type (multi-select), status (default=active), date_range
  - Search by exception_id and shipping_order_id
  - Active exceptions highlighted with `recordClasses()` returning 'bg-danger-50' for isActive()
  - Navigation badge with active exception count using getNavigationBadge() and getNavigationBadgeColor()
  - View page shows: status banner, exception details, description, resolution path, resolution details (if resolved), blocking warning (if blocking)
  - "Mark as Resolved" action updates status, resolved_at, resolved_by
  - Export CSV bulk action available
  - Browser verification pending
---

## 2026-02-04 - US-C044, US-C045, US-C046
- **What was implemented:** Verified Supply Exception Handling, WMS Discrepancy Resolution (already implemented), added VoucherIneligible exception creation
- **Files changed:**
  - `app/Services/Fulfillment/ShippingOrderService.php` (added VoucherIneligible exception creation at planning and pre-picking checkpoints)
- **Files verified (no changes needed):**
  - `app/Services/Fulfillment/WmsIntegrationService.php` (handleDiscrepancy creates WmsDiscrepancy exception)
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ViewShippingOrder.php` (Planning tab creates SupplyInsufficient exception)
- **Learnings for future iterations:**
  - US-C044 was already implemented in US-C026 (Planning tab) - SupplyInsufficient exception created with resolution paths
  - US-C045 was already implemented in US-C015 (WmsIntegrationService) - handleDiscrepancy() creates WmsDiscrepancy exception
  - US-C046 required adding ShippingOrderException creation for VoucherIneligible at planning and pre-picking checkpoints
  - Added imports for ShippingOrderException, ShippingOrderExceptionType, ShippingOrderExceptionStatus
  - Exception is linked to specific line when possible via shipping_order_line_id
  - Resolution paths: Remove ineligible voucher from SO, Cancel Shipping Order
  - Banner "One or more vouchers are not eligible" already implemented in Vouchers & Eligibility tab
  - Cross-allocation substitution blocked at: ShippingOrderLine boot() guard, LateBindingService, WmsIntegrationService
---

## 2026-02-04 - US-C047
- **What was implemented:** Shipment Failure Recovery handling
- **Files changed:**
  - `app/Services/Fulfillment/WmsIntegrationService.php` (added handleShipmentConfirmationFailure method and EVENT_WMS_CONFIRMATION_FAILED constant)
- **Learnings for future iterations:**
  - Added ShipmentStatus import for Failed enum value
  - handleShipmentConfirmationFailure() is called when WMS reports shipment but ERP validation fails
  - Flow: markFailed() to set shipment status to Failed, create critical exception with [CRITICAL] prefix, log EVENT_WMS_CONFIRMATION_FAILED
  - Redemption is NOT executed because confirmShipment() throws exception before reaching redemption code
  - Exception marked as CRITICAL in description to highlight urgency for admin review
  - Resolution paths: Retry confirmation, Manual reconciliation, Cancel SO
  - Audit log includes: shipment_id, failure_type, reason, shipment_status=failed, redemption_executed=false, admin_intervention_required=true
  - Two failure scenarios handled: partial_shipment (missing serials), validation_failed (invalid serials)
---

## 2026-02-04 - US-C048 to US-C054
- **What was implemented:** Verified WMS stories and Audit Trail stories (all already implemented)
- **Files verified (no changes needed):**
  - `app/Services/Fulfillment/WmsIntegrationService.php` (sendPickingInstructions, receivePickingFeedback, validateSerial, confirmShipment)
  - `app/Services/Fulfillment/LateBindingService.php` (binding events with voucher_id, bottle_serial, allocation_id)
  - `app/Models/Fulfillment/ShippingOrderAuditLog.php` (immutable via boot() guards)
  - `app/Filament/Resources/Fulfillment/ShippingOrderResource/Pages/ViewShippingOrder.php` (Audit & Timeline tab)
  - `app/Filament/Resources/Fulfillment/ShipmentResource/Pages/ViewShipment.php` (Audit Trail section)
- **Learnings for future iterations:**
  - US-C048 to US-C051 (WMS stories) were already implemented in US-C015 (WmsIntegrationService)
  - sendPickingInstructions() builds payload with early/late binding types
  - receivePickingFeedback() validates serials and executes bindings
  - validateSerial() checks: serial exists, allocation match, bottle state, not terminal, not bound to another
  - confirmShipment() validates all expected serials, creates exception for partial shipment
  - US-C052 (SO Audit Trail) implemented in US-C010 (model) and US-C028 (UI)
  - US-C053 (Shipment Audit Trail) implemented in US-C037 with Audit Trail section
  - US-C054 (Binding Audit) implemented in US-C012 with EVENT_BINDING_EXECUTED logging
  - Query bindings by allocation: ShippingOrderLine.where('allocation_id', $allocationId)->whereNotNull('bound_bottle_serial')
---

## 2026-02-04 - US-C059 to US-C062
- **What was implemented:** Validation stories - verified existing constraints and added unbinding on cancellation
- **Files changed:**
  - `app/Services/Fulfillment/ShippingOrderService.php` (added unbindAllLines() method and LateBindingService dependency)
- **Files verified (no changes needed):**
  - `app/Filament/Resources/Fulfillment/CustomerResource/RelationManagers/ShippingOrdersRelationManager.php` (concurrent SO prevention)
  - `app/Models/Fulfillment/Shipment.php` (shipping_order_id required, no standalone shipments)
  - `app/Services/Fulfillment/ShipmentService.php` (redemption only called from confirmShipment)
- **Learnings for future iterations:**
  - US-C059 (Concurrent SO prevention): Already implemented via canCreateShippingOrder() which checks for active SOs
  - US-C060 (Unbinding on cancellation): Added unbindAllLines() method called from cancel() when SO was in Picking status
  - US-C061 (Shipment without SO prevention): Enforced at DB level - Shipment.shipping_order_id is NOT NULL with FK constraint
  - US-C062 (Redemption timing): Enforced by code flow - triggerRedemption() only called from confirmShipment() which requires Shipped status
  - unbindAllLines() uses best-effort approach - logs errors but continues unbinding remaining lines
  - LateBindingService injected via constructor for unbindLine() calls
  - Binding status tracked via isBound() method which checks bound_bottle_serial presence
---

## 2026-02-04 - US-C055
- **What was implemented:** Fulfillment Dashboard page as landing page for Fulfillment module
- **Files changed:**
  - `app/Filament/Pages/FulfillmentDashboard.php` (new)
  - `resources/views/filament/pages/fulfillment-dashboard.blade.php` (new)
- **Learnings for future iterations:**
  - Dashboard pages use Page class with custom Blade view (not Resource)
  - Navigation group "Fulfillment", navigationSort=0 to make it first item
  - Widget A: SO by Status - status bar chart with links to filtered SO list
  - Widget B: SOs Requiring Attention - two sections: active exceptions and near ship date (3 days)
  - Widget C: Shipments Today/This Week - metrics cards with pending confirmation count
  - Widget D: Exception Summary - grouped by type with count and quick links
  - View pattern: methods return data arrays/collections, Blade template consumes via $this->getMethodName()
  - Quick links use Resource::getUrl('index', ['tableFilters' => [...]])
  - Color classes mapped from enum color() values to Tailwind classes
---
