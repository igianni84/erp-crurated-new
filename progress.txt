# Ralph Progress Log
Started: Tue Feb  3 16:33:41 CET 2026
---

## Codebase Patterns
- PIM models go in `app/Models/Pim/` namespace
- PIM Filament resources go in `app/Filament/Resources/Pim/` namespace
- Use `HasUuid` trait with `$table->uuid('id')->primary()` instead of `$table->id()`
- Use `Auditable` trait with `created_by` and `updated_by` foreign keys
- Use `SoftDeletes` trait with `$table->softDeletes()` for referential integrity
- JSON fields use `'field_name' => 'array'` cast and `KeyValue` form component
- Navigation group for PIM is 'PIM', sort order starts at 1
- For enum match arms, use PHPDoc `@var 'val1'|'val2'|'val3'` annotation to satisfy PHPStan
- For nested resources, create RelationManager in `Resource/RelationManagers/` and register in `getRelations()`
- For enum-cast properties used in traits, add `@property EnumClass $property_name` PHPDoc on the model class
- Use `HasProductLifecycle` trait and `ProductLifecycleStatus` enum for PIM models with approval workflow

---

## 2026-02-03 16:56 CET - US-001
- Implemented Wine Master model with all required fields
- Files changed:
  - `database/migrations/2026_02_03_155637_create_wine_masters_table.php` (new)
  - `app/Models/Pim/WineMaster.php` (new)
  - `app/Filament/Resources/Pim/WineMasterResource.php` (new)
  - `app/Filament/Resources/Pim/WineMasterResource/Pages/ListWineMasters.php` (new)
  - `app/Filament/Resources/Pim/WineMasterResource/Pages/CreateWineMaster.php` (new)
  - `app/Filament/Resources/Pim/WineMasterResource/Pages/EditWineMaster.php` (new)
- **Learnings for future iterations:**
  - Patterns discovered: PIM models/resources have their own Pim subdirectory namespace
  - Use `KeyValue` component for JSON regulatory_attributes field
  - Use `TrashedFilter` for soft-deleted models in table filters
  - Table columns: searchable on name/producer/appellation per requirements
---

## 2026-02-03 17:00 CET - US-002
- Implemented Wine Variant model with FK to Wine Master and all required fields
- Files changed:
  - `database/migrations/2026_02_03_160009_create_wine_variants_table.php` (new)
  - `app/Models/Pim/WineVariant.php` (new)
  - `app/Models/Pim/WineMaster.php` (modified - added hasMany relationship)
  - `app/Filament/Resources/Pim/WineVariantResource.php` (new)
  - `app/Filament/Resources/Pim/WineVariantResource/Pages/ListWineVariants.php` (new)
  - `app/Filament/Resources/Pim/WineVariantResource/Pages/CreateWineVariant.php` (new)
  - `app/Filament/Resources/Pim/WineVariantResource/Pages/EditWineVariant.php` (new)
- **Learnings for future iterations:**
  - Use `foreignUuid()` for foreign keys to UUID primary keys (not `foreignId`)
  - For unique constraint across two columns, use `$table->unique(['col1', 'col2'])`
  - Select component with relationship: use `getOptionLabelFromRecordUsing()` for custom labels
  - Navigation sort increments for each resource (WineMaster=1, WineVariant=2)
  - BelongsTo relationship method name should be camelCase singular (e.g., `wineMaster`)
---

## 2026-02-03 17:05 CET - US-003
- Implemented Format model for bottle formats
- Files changed:
  - `database/migrations/2026_02_03_160313_create_formats_table.php` (new)
  - `app/Models/Pim/Format.php` (new)
  - `app/Filament/Resources/Pim/FormatResource.php` (new)
  - `app/Filament/Resources/Pim/FormatResource/Pages/ListFormats.php` (new)
  - `app/Filament/Resources/Pim/FormatResource/Pages/CreateFormat.php` (new)
  - `app/Filament/Resources/Pim/FormatResource/Pages/EditFormat.php` (new)
  - `database/seeders/FormatSeeder.php` (new)
  - `database/seeders/DatabaseSeeder.php` (modified - added FormatSeeder)
- **Learnings for future iterations:**
  - Use `TernaryFilter` for boolean fields in table filters (better UX than checkbox)
  - Use `Toggle` component with `helperText` for boolean form fields
  - Use `firstOrCreate` in seeders with unique field as first argument to avoid duplicates
  - Format volume display: use `formatStateUsing(fn (int $state): string => number_format($state) . ' ml')`
  - Navigation sort for Format = 3 (after WineMaster=1, WineVariant=2)
---

## 2026-02-03 17:10 CET - US-004
- Implemented Case Configuration model with FK to Format
- Files changed:
  - `database/migrations/2026_02_03_170639_create_case_configurations_table.php` (new)
  - `app/Models/Pim/CaseConfiguration.php` (new)
  - `app/Models/Pim/Format.php` (modified - added hasMany relationship to CaseConfiguration)
  - `app/Filament/Resources/Pim/CaseConfigurationResource.php` (new)
  - `app/Filament/Resources/Pim/CaseConfigurationResource/Pages/ListCaseConfigurations.php` (new)
  - `app/Filament/Resources/Pim/CaseConfigurationResource/Pages/CreateCaseConfiguration.php` (new)
  - `app/Filament/Resources/Pim/CaseConfigurationResource/Pages/EditCaseConfiguration.php` (new)
  - `database/seeders/CaseConfigurationSeeder.php` (new)
  - `database/seeders/DatabaseSeeder.php` (modified - added CaseConfigurationSeeder)
- **Learnings for future iterations:**
  - Use enum migration with `$table->enum('case_type', ['owc', 'oc', 'none'])` for limited options
  - For enum badge display, use `formatStateUsing()` and `color()` with match expressions - add default case for PHPStan
  - Use `SelectFilter` for enum and FK fields in table filters
  - When accessing related model properties via BelongsTo, use PHPDoc `@var` annotation for PHPStan
  - Navigation sort for CaseConfiguration = 4 (after Format=3)
  - Seeders can call other seeders with `$this->call(OtherSeeder::class)` to ensure dependencies exist
---

## 2026-02-03 17:15 CET - US-005
- Implemented Sellable SKU model combining Wine Variant + Format + Case Configuration
- Files changed:
  - `database/migrations/2026_02_03_171046_create_sellable_skus_table.php` (new)
  - `app/Models/Pim/SellableSku.php` (new)
  - `app/Models/Pim/WineVariant.php` (modified - added hasMany relationship to SellableSku)
  - `app/Filament/Resources/Pim/SellableSkuResource.php` (new)
  - `app/Filament/Resources/Pim/SellableSkuResource/Pages/ListSellableSkus.php` (new)
  - `app/Filament/Resources/Pim/SellableSkuResource/Pages/CreateSellableSku.php` (new)
  - `app/Filament/Resources/Pim/SellableSkuResource/Pages/EditSellableSku.php` (new)
  - `app/Filament/Resources/Pim/WineVariantResource/RelationManagers/SellableSkusRelationManager.php` (new)
  - `app/Filament/Resources/Pim/WineVariantResource.php` (modified - added RelationManager)
- **Learnings for future iterations:**
  - For nested resources, use RelationManager classes in `Resource/RelationManagers/` directory
  - Register RelationManagers in the parent Resource's `getRelations()` method
  - Auto-generate SKU codes in model `boot()` method with `static::creating()` callback
  - For match arms on enum DB columns, use PHPDoc annotation `@var 'val1'|'val2'|'val3'` to avoid PHPStan "match.alwaysTrue" errors
  - Filter cascaded selects using `->relationship()` with callback: `fn ($query, $get) => $query->when($get('parent_field'), fn ($q, $val) => $q->where('field', $val))`
  - Navigation sort for SellableSku = 5 (after CaseConfiguration=4)
  - Unique constraint across multiple columns: `$table->unique(['col1', 'col2', 'col3'], 'constraint_name')`
---

## 2026-02-03 16:16 CET - US-006
- Implemented Liquid Product model for pre-bottling wine sales
- Files changed:
  - `database/migrations/2026_02_03_161545_create_liquid_products_table.php` (new)
  - `app/Models/Pim/LiquidProduct.php` (new)
  - `app/Models/Pim/WineVariant.php` (modified - added hasOne relationship to LiquidProduct)
  - `app/Filament/Resources/Pim/LiquidProductResource.php` (new)
  - `app/Filament/Resources/Pim/LiquidProductResource/Pages/ListLiquidProducts.php` (new)
  - `app/Filament/Resources/Pim/LiquidProductResource/Pages/CreateLiquidProduct.php` (new)
  - `app/Filament/Resources/Pim/LiquidProductResource/Pages/EditLiquidProduct.php` (new)
- **Learnings for future iterations:**
  - Liquid Products use HasOne relationship (one per wine variant), not HasMany
  - For 1:1 relationships, add unique constraint on the FK: `$table->unique('wine_variant_id')`
  - Lifecycle status enum can have more states than SKU (draft, in_review, approved, published, archived)
  - Use 'heroicon-o-beaker' icon for liquid/pre-bottling related resources
  - Navigation sort for LiquidProduct = 6 (after SellableSku=5)
---

## 2026-02-03 17:19 CET - US-007
- Implemented lifecycle states for Wine Variant with approval workflow
- Files changed:
  - `app/Enums/ProductLifecycleStatus.php` (new)
  - `app/Traits/HasProductLifecycle.php` (new)
  - `database/migrations/2026_02_03_171920_add_lifecycle_status_to_wine_variants_table.php` (new)
  - `app/Models/Pim/WineVariant.php` (modified - added HasProductLifecycle trait, lifecycle_status field)
  - `app/Filament/Resources/Pim/WineVariantResource.php` (modified - added status column, filter, lifecycle actions)
  - `app/Filament/Resources/Pim/WineVariantResource/Pages/EditWineVariant.php` (modified - added lifecycle actions in header)
- **Learnings for future iterations:**
  - Use `ProductLifecycleStatus` enum for PIM products with review workflow (draft, in_review, approved, published, archived)
  - Use `HasProductLifecycle` trait for models needing approval workflow
  - For enum cast properties that need PHPStan to understand, add `@property EnumClass $property_name` PHPDoc annotation on the model
  - Sensitive fields that auto-trigger review status change are defined in model `SENSITIVE_FIELDS` constant
  - Lifecycle action buttons in Filament: use `ActionGroup` with `->visible()` based on `canTransitionTo()` method
  - Filament Notifications: use `Notification::make()->title('Message')->success()->send()` for action feedback
---
