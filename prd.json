{
  "project": "ERP4 - Module E Accounting, Invoicing & Payments",
  "branchName": "ralph/module-e-finance",
  "description": "Module E - Finance: The authoritative system for financial management in the ERP. Governs Invoices (INV0-INV4), Payments, Credit Notes, Refunds, Subscriptions, Storage Billing, Stripe integration, and Xero sync. Finance is consequence, not cause - financial events are generated by other modules.",
  "userStories": [
    {
      "id": "US-E001",
      "title": "Setup enums for Finance",
      "description": "As a Developer, I want well-defined enums for financial entity types and states.",
      "acceptanceCriteria": [
        "Enum InvoiceType: membership_service (INV0), voucher_sale (INV1), shipping_redemption (INV2), storage_fee (INV3), service_events (INV4)",
        "Enum InvoiceStatus: draft, issued, paid, partially_paid, credited, cancelled",
        "Enum PaymentSource: stripe, bank_transfer",
        "Enum PaymentStatus: pending, confirmed, failed, refunded",
        "Enum ReconciliationStatus: pending, matched, mismatched",
        "Enum CreditNoteStatus: draft, issued, applied",
        "Enum RefundType: full, partial",
        "Enum RefundMethod: stripe, bank_transfer",
        "Enum RefundStatus: pending, processed, failed",
        "Enum SubscriptionPlanType: membership, service",
        "Enum BillingCycle: monthly, quarterly, annual",
        "Enum SubscriptionStatus: active, suspended, cancelled",
        "Enum StorageBillingStatus: pending, invoiced, paid, blocked",
        "Enum XeroSyncType: invoice, credit_note, payment",
        "Enum XeroSyncStatus: pending, synced, failed",
        "Enums in app/Enums/Finance/",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E002",
      "title": "Setup Invoice model",
      "description": "As an Admin, I want to define the base model for ERP invoices.",
      "acceptanceCriteria": [
        "Table invoices with fields: id, uuid, invoice_number (string unique), invoice_type (enum), customer_id (FK), currency (string default 'EUR'), subtotal (decimal 10,2), tax_amount (decimal 10,2), total_amount (decimal 10,2), amount_paid (decimal 10,2 default 0), status (enum), source_type (string nullable), source_id (int nullable), issued_at (timestamp nullable), due_date (date nullable), notes (text nullable), xero_invoice_id (string nullable), xero_synced_at (timestamp nullable)",
        "Soft deletes enabled",
        "Constraint: invoice_number unique and immutable after issuance",
        "Relation: Invoice belongsTo Customer",
        "Relation: Invoice hasMany InvoiceLine",
        "Relation: Invoice hasMany InvoicePayment",
        "Relation: Invoice hasMany CreditNote",
        "invoice_type is IMMUTABLE after creation",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E003",
      "title": "Setup InvoiceLine model",
      "description": "As an Admin, I want to define invoice lines with tax detail.",
      "acceptanceCriteria": [
        "Table invoice_lines with: id, invoice_id (FK), description (string), quantity (decimal 8,2), unit_price (decimal 10,2), tax_rate (decimal 5,2), tax_amount (decimal 10,2), line_total (decimal 10,2), sellable_sku_id (FK nullable), metadata (JSON nullable)",
        "Relation: InvoiceLine belongsTo Invoice",
        "Relation: InvoiceLine belongsTo SellableSku (nullable)",
        "line_total = (quantity * unit_price) + tax_amount",
        "Lines are IMMUTABLE after invoice issuance",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E004",
      "title": "Setup Payment model",
      "description": "As an Admin, I want to define the model for received payments.",
      "acceptanceCriteria": [
        "Table payments with: id, uuid, payment_reference (string unique), source (enum), amount (decimal 10,2), currency (string), status (enum), reconciliation_status (enum), stripe_payment_intent_id (string nullable unique), stripe_charge_id (string nullable), bank_reference (string nullable), received_at (timestamp), customer_id (FK nullable), metadata (JSON nullable)",
        "Soft deletes enabled",
        "Constraint: payment_reference unique",
        "Relation: Payment belongsTo Customer (nullable - for unreconciled payments)",
        "Relation: Payment hasMany InvoicePayment",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E005",
      "title": "Setup InvoicePayment pivot model",
      "description": "As an Admin, I want to track payment application to invoices.",
      "acceptanceCriteria": [
        "Table invoice_payments with: id, invoice_id (FK), payment_id (FK), amount_applied (decimal 10,2), applied_at (timestamp), applied_by (FK users nullable)",
        "Relation: InvoicePayment belongsTo Invoice",
        "Relation: InvoicePayment belongsTo Payment",
        "Constraint: sum(amount_applied) per invoice <= invoice.total_amount",
        "Constraint: sum(amount_applied) per payment <= payment.amount",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E006",
      "title": "Setup CreditNote model",
      "description": "As an Admin, I want to define the model for credit notes.",
      "acceptanceCriteria": [
        "Table credit_notes with: id, uuid, credit_note_number (string unique), invoice_id (FK), customer_id (FK), amount (decimal 10,2), currency (string), reason (text required), status (enum), issued_at (timestamp nullable), applied_at (timestamp nullable), issued_by (FK users nullable), xero_credit_note_id (string nullable), xero_synced_at (timestamp nullable)",
        "Soft deletes enabled",
        "Constraint: reason NOT NULL",
        "Relation: CreditNote belongsTo Invoice",
        "Relation: CreditNote belongsTo Customer",
        "Preserves invoice_type of original invoice",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E007",
      "title": "Setup Refund model",
      "description": "As an Admin, I want to define the model for refunds.",
      "acceptanceCriteria": [
        "Table refunds with: id, uuid, invoice_id (FK), payment_id (FK), credit_note_id (FK nullable), refund_type (enum), method (enum), amount (decimal 10,2), currency (string), status (enum), reason (text required), stripe_refund_id (string nullable unique), bank_reference (string nullable), processed_at (timestamp nullable), processed_by (FK users nullable)",
        "Soft deletes enabled",
        "Relation: Refund belongsTo Invoice",
        "Relation: Refund belongsTo Payment",
        "Relation: Refund belongsTo CreditNote (nullable)",
        "Constraint: invoice and payment must be linked",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E008",
      "title": "Setup Subscription model",
      "description": "As an Admin, I want to define the model for subscriptions.",
      "acceptanceCriteria": [
        "Table subscriptions with: id, uuid, customer_id (FK), plan_type (enum), plan_name (string), billing_cycle (enum), amount (decimal 10,2), currency (string), status (enum), started_at (date), next_billing_date (date), cancelled_at (date nullable), cancellation_reason (text nullable), stripe_subscription_id (string nullable unique), metadata (JSON nullable)",
        "Soft deletes enabled",
        "Relation: Subscription belongsTo Customer",
        "Relation: Subscription hasMany Invoice (via source polymorphic)",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E009",
      "title": "Setup StorageBillingPeriod model",
      "description": "As an Admin, I want to define the model for storage billing periods.",
      "acceptanceCriteria": [
        "Table storage_billing_periods with: id, uuid, customer_id (FK), location_id (FK nullable), period_start (date), period_end (date), bottle_count (int), bottle_days (int), unit_rate (decimal 10,4), calculated_amount (decimal 10,2), currency (string), status (enum), invoice_id (FK nullable), calculated_at (timestamp), metadata (JSON nullable)",
        "Soft deletes enabled",
        "Relation: StorageBillingPeriod belongsTo Customer",
        "Relation: StorageBillingPeriod belongsTo Location (nullable)",
        "Relation: StorageBillingPeriod belongsTo Invoice (nullable)",
        "bottle_days = sum(bottles * days_stored) in period",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E010",
      "title": "Setup StripeWebhook model",
      "description": "As an Admin, I want to log all received Stripe webhooks.",
      "acceptanceCriteria": [
        "Table stripe_webhooks with: id, event_id (string unique), event_type (string), payload (JSON), processed (boolean default false), processed_at (timestamp nullable), error_message (text nullable), created_at",
        "NO soft deletes - logs are immutable",
        "Constraint: event_id unique for idempotency",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E011",
      "title": "Setup XeroSyncLog model",
      "description": "As an Admin, I want to log all Xero synchronizations.",
      "acceptanceCriteria": [
        "Table xero_sync_logs with: id, sync_type (enum), syncable_type (string), syncable_id (int), xero_id (string nullable), status (enum), request_payload (JSON nullable), response_payload (JSON nullable), error_message (text nullable), synced_at (timestamp nullable), retry_count (int default 0)",
        "NO soft deletes - logs are immutable",
        "Relation: XeroSyncLog morphTo syncable (Invoice, CreditNote, Payment)",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E012",
      "title": "InvoiceService for invoice management",
      "description": "As a Developer, I want a service to centralize invoice logic.",
      "acceptanceCriteria": [
        "Service class InvoiceService in app/Services/Finance/",
        "Method createDraft(InvoiceType, Customer, array $lines, ?string $sourceType, ?int $sourceId): creates draft invoice",
        "Method issue(Invoice): transitions draft to issued, generates invoice_number, sets issued_at",
        "Method applyPayment(Invoice, Payment, decimal $amount): creates InvoicePayment, updates status",
        "Method markPaid(Invoice): verifies amount_paid >= total_amount, sets status to paid",
        "Method cancel(Invoice): only draft can be cancelled",
        "Method getOutstandingAmount(Invoice): returns total_amount - amount_paid",
        "Validations with explicit exceptions",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E013",
      "title": "Invoice List in Filament",
      "description": "As a Finance Operator, I want an invoice list as the operational entry point.",
      "acceptanceCriteria": [
        "InvoiceResource in Filament with navigation group Finance",
        "List with columns: invoice_number, type (colored badge), customer, amount, status (badge), issue_date, due_date, xero_ref, flags (overdue, disputed)",
        "Filters: invoice_type, status, customer, date range, currency",
        "Search by: invoice_number, customer name, xero_invoice_id",
        "Tabs for status: All, Draft, Issued, Overdue, Paid",
        "Visual indicator for overdue invoices (red)",
        "Default landing page for Finance",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 13,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E014",
      "title": "Invoice Detail with 5 tabs",
      "description": "As a Finance Operator, I want to see all invoice details organized in tabs.",
      "acceptanceCriteria": [
        "Tab Lines: read-only invoice lines with description, qty, unit_price, tax, total",
        "Tab Payments: applied payments with amount, date, source, reference",
        "Tab Linked ERP Events: source reference with link (membership, voucher batch, shipping order, storage period, event)",
        "Tab Accounting: xero_invoice_id, xero_synced_at, statutory invoice number, GL posting, FX rate",
        "Tab Audit: immutable event timeline (status changes, payments, credits)",
        "Header: invoice_number, type (locked badge), status, customer, currency, totals",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 14,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E015",
      "title": "Invoice contextual actions",
      "description": "As a Finance Operator, I want contextual actions based on invoice status.",
      "acceptanceCriteria": [
        "Action Issue visible only if status = draft",
        "Action Record Bank Payment visible only if status = issued or partially_paid",
        "Action Create Credit Note visible only if status = issued, paid, partially_paid",
        "Action Cancel visible only if status = draft",
        "Each action requires confirmation",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 15,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E016",
      "title": "Invoice issuance flow",
      "description": "As a Finance Operator, I want to issue a draft invoice with validation.",
      "acceptanceCriteria": [
        "Issue action generates sequential invoice_number (format: INV-YYYY-NNNNNN)",
        "issued_at = now()",
        "Validation: at least one invoice line present",
        "Validation: total_amount > 0",
        "Post-issuance: lines become immutable",
        "Post-issuance: trigger Xero sync",
        "Audit log of the event",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E017",
      "title": "Invoice immutability enforcement",
      "description": "As a Developer, I want invoices to be immutable after issuance.",
      "acceptanceCriteria": [
        "invoice_type cannot be modified EVER (not even in draft)",
        "invoice_lines cannot be modified after status != draft",
        "subtotal, tax_amount, total_amount cannot be modified after issuance",
        "Attempt to modify throws explicit exception",
        "UI hides edit fields for issued invoices",
        "Test that verifies immutability",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E018",
      "title": "Create Invoice draft (manual)",
      "description": "As a Finance Operator, I want to manually create a draft invoice for exceptional cases.",
      "acceptanceCriteria": [
        "Create Invoice form with: customer (select), invoice_type (select), currency, due_date, notes",
        "Step 2: add lines with description, quantity, unit_price, tax_rate",
        "Tax amount calculated automatically",
        "Totals calculated in real-time",
        "Warning: Manual invoices should be exceptional. Most invoices are auto-generated from ERP events.",
        "Save as draft (requires Issue to activate)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 18,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E019",
      "title": "Invoice PDF generation",
      "description": "As a Finance Operator, I want to generate invoice PDF.",
      "acceptanceCriteria": [
        "Action Download PDF visible for issued/paid invoices",
        "PDF includes: header with logo, invoice details, lines table, totals, payment info, footer",
        "Template compliant with fiscal requirements",
        "Filename: {invoice_number}.pdf",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E020",
      "title": "Invoice email sending",
      "description": "As a Finance Operator, I want to send invoice via email to customer.",
      "acceptanceCriteria": [
        "Action Send to Customer visible for issued invoices",
        "Email includes PDF attachment",
        "Configurable email template",
        "Log sending in audit trail",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E021",
      "title": "Overdue invoice detection",
      "description": "As a Developer, I want to automatically identify overdue invoices.",
      "acceptanceCriteria": [
        "Scheduled daily job to identify overdue invoices",
        "Invoice is overdue: status = issued, due_date < today",
        "Computed is_overdue field on Invoice",
        "Red visual badge in list",
        "Overdue filter in invoice list",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E022",
      "title": "Invoice currency handling",
      "description": "As a Finance Operator, I want to handle invoices in different currencies.",
      "acceptanceCriteria": [
        "Currency field required (default EUR)",
        "Currency not modifiable after issuance",
        "All amounts in same currency",
        "Exchange rate snapshot at issuance (field fx_rate_at_issuance)",
        "UI shows currency symbol/code",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E023",
      "title": "Invoice due date management",
      "description": "As a Finance Operator, I want to manage invoice due dates.",
      "acceptanceCriteria": [
        "Due date required for non-immediate invoices (INV0, INV3)",
        "Due date optional for INV1, INV2, INV4 (immediate payment)",
        "Default due date: +30 days from issuance (configurable per type)",
        "Due date modifiable only in draft",
        "Typecheck passes"
      ],
      "priority": 23,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E024",
      "title": "Invoice global search",
      "description": "As a Finance Operator, I want to search invoices quickly.",
      "acceptanceCriteria": [
        "Global search in Finance section",
        "Search by: invoice_number, customer name/email, xero_id",
        "Results show: invoice_number, customer, amount, status",
        "Click opens Invoice Detail",
        "Typecheck passes"
      ],
      "priority": 24,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E025",
      "title": "Invoice bulk actions",
      "description": "As a Finance Operator, I want to execute actions on multiple invoices.",
      "acceptanceCriteria": [
        "Checkbox selection in list",
        "Bulk action Export to CSV",
        "Bulk action Retry Xero Sync (for failed syncs)",
        "NO bulk issue or bulk payment (too risky)",
        "Typecheck passes"
      ],
      "priority": 25,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E026",
      "title": "INV0 auto-generation from subscription",
      "description": "As a Developer, I want INV0 to be auto-generated from subscription events.",
      "acceptanceCriteria": [
        "Listener for SubscriptionBillingDue event",
        "Creates Invoice draft with type = INV0",
        "Source reference: subscription_id",
        "Invoice lines from subscription plan details",
        "Auto-issue if configured",
        "Typecheck passes"
      ],
      "priority": 26,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E027",
      "title": "INV0 subscription billing cycle",
      "description": "As a Developer, I want to generate INV0 according to billing cycle.",
      "acceptanceCriteria": [
        "Scheduled job checks subscriptions with next_billing_date = today",
        "For each subscription: generates INV0",
        "Updates next_billing_date according to billing_cycle",
        "Log billing event",
        "Typecheck passes"
      ],
      "priority": 27,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E028",
      "title": "INV0 membership types support",
      "description": "As a Finance Operator, I want to distinguish INV0 by membership type.",
      "acceptanceCriteria": [
        "Invoice lines description includes plan_name",
        "Metadata JSON includes membership tier details",
        "Linked ERP Events tab shows subscription details",
        "Typecheck passes"
      ],
      "priority": 28,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E029",
      "title": "INV0 pro-rata calculation",
      "description": "As a Developer, I want to support pro-rata calculations for mid-cycle membership.",
      "acceptanceCriteria": [
        "Method calculateProRata(Subscription, startDate, endDate) in SubscriptionBillingService",
        "Pro-rata for: new signups, cancellations, upgrades",
        "Invoice line description indicates pro-rata period",
        "Typecheck passes"
      ],
      "priority": 29,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E030",
      "title": "INV0 suspension on non-payment",
      "description": "As a Developer, I want to suspend membership for unpaid INV0.",
      "acceptanceCriteria": [
        "Scheduled job: if INV0 overdue > X days (configurable)",
        "Sets subscription.status = suspended",
        "Emits SubscriptionSuspended event (for Module K eligibility)",
        "Warning visible in customer view",
        "Typecheck passes"
      ],
      "priority": 30,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E031",
      "title": "INV1 auto-generation from sale confirmation",
      "description": "As a Developer, I want INV1 to be auto-generated from Module A sale confirmation.",
      "acceptanceCriteria": [
        "Listener for VoucherSaleConfirmed event (from Module A)",
        "Creates Invoice with type = INV1",
        "Source reference: voucher_batch_id or sale_order_id",
        "Invoice lines from sellable_sku + quantity + price",
        "Status = issued (immediate)",
        "Typecheck passes"
      ],
      "priority": 31,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E032",
      "title": "INV1 pricing from Module S",
      "description": "As a Developer, I want INV1 to use pricing from Module S.",
      "acceptanceCriteria": [
        "Invoice line unit_price = pricing from Module S (price snapshot at sale)",
        "Tax calculation according to customer geography and product type",
        "Metadata includes pricing_snapshot_id",
        "Typecheck passes"
      ],
      "priority": 32,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E033",
      "title": "INV1 payment confirmation trigger",
      "description": "As a Developer, I want INV1 payment confirmation to trigger voucher issuance.",
      "acceptanceCriteria": [
        "When INV1 becomes paid",
        "Emits InvoicePaid event with invoice_type = INV1",
        "Module A listens and creates vouchers",
        "Log correlation between invoice and vouchers",
        "Typecheck passes"
      ],
      "priority": 33,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E034",
      "title": "INV1 multi-item support",
      "description": "As a Developer, I want to support INV1 with multiple sellable SKUs.",
      "acceptanceCriteria": [
        "Multiple invoice lines per INV1",
        "Each line linkable to different sellable_sku",
        "Totals aggregate all lines",
        "Typecheck passes"
      ],
      "priority": 34,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E035",
      "title": "INV1 immediate payment expectation",
      "description": "As a Finance Operator, I want INV1 to have immediate payment expectation.",
      "acceptanceCriteria": [
        "INV1 default: no due_date (immediate payment expected)",
        "Rapid status transitions: issued to paid (via Stripe)",
        "Alert if INV1 issued > 24h without payment",
        "Typecheck passes"
      ],
      "priority": 35,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E036",
      "title": "INV2 auto-generation from shipping execution",
      "description": "As a Developer, I want INV2 to be auto-generated when Module C executes shipment.",
      "acceptanceCriteria": [
        "Listener for ShipmentExecuted event (from Module C)",
        "Creates Invoice with type = INV2",
        "Source reference: shipping_order_id",
        "Invoice lines: shipping fees, handling fees, duties/taxes",
        "Typecheck passes"
      ],
      "priority": 36,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E037",
      "title": "INV2 shipping cost calculation",
      "description": "As a Developer, I want INV2 to include accurate shipping costs.",
      "acceptanceCriteria": [
        "Separate invoice lines for: base shipping, insurance, packaging",
        "Duties and taxes in separate lines",
        "Method calculateShippingCosts(ShippingOrder) in InvoiceService",
        "Typecheck passes"
      ],
      "priority": 37,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E038",
      "title": "INV2 VAT/duty handling",
      "description": "As a Developer, I want to handle VAT and duties on INV2 according to destination.",
      "acceptanceCriteria": [
        "Tax rate determined by shipping destination country",
        "Duties calculated if cross-border",
        "Tax amount breakdown in invoice detail",
        "Typecheck passes"
      ],
      "priority": 38,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E039",
      "title": "INV2 redemption fee support",
      "description": "As a Developer, I want to support redemption fees on INV2.",
      "acceptanceCriteria": [
        "Invoice line for redemption fee (if applicable)",
        "Fee amount from Module S pricing",
        "Distinguish: shipping-only vs redemption+shipping",
        "Typecheck passes"
      ],
      "priority": 39,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E040",
      "title": "INV2 multi-shipment aggregation",
      "description": "As a Developer, I want to support aggregation of multiple shipments in single INV2.",
      "acceptanceCriteria": [
        "Source reference can be multiple shipping_order_ids (JSON)",
        "Separate invoice lines per shipment",
        "Totals aggregate all shipments",
        "Linked ERP Events shows all shipments",
        "Typecheck passes"
      ],
      "priority": 40,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E041",
      "title": "INV3 batch generation from storage billing",
      "description": "As a Developer, I want to generate INV3 batch at end of storage billing period.",
      "acceptanceCriteria": [
        "Scheduled job for end of period (monthly/quarterly)",
        "For each customer with storage usage: generates StorageBillingPeriod",
        "Creates INV3 for each customer with usage > 0",
        "Source reference: storage_billing_period_id",
        "Typecheck passes"
      ],
      "priority": 41,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E042",
      "title": "INV3 usage calculation",
      "description": "As a Developer, I want to calculate storage usage accurately.",
      "acceptanceCriteria": [
        "Method calculateUsage(Customer, periodStart, periodEnd) in StorageBillingService",
        "Calculate bottle-days: sum(bottles_stored * days)",
        "Consider: inbound, outbound, transfers during period",
        "Snapshot inventory at period boundaries",
        "Typecheck passes"
      ],
      "priority": 42,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E043",
      "title": "INV3 rate tiers support",
      "description": "As a Developer, I want to support rate tiers for storage.",
      "acceptanceCriteria": [
        "Rate can vary by: volume tier, customer tier, location",
        "Invoice line description includes applied rate tier",
        "Method getApplicableRate(Customer, Location, bottleCount)",
        "Typecheck passes"
      ],
      "priority": 43,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E044",
      "title": "INV3 location breakdown",
      "description": "As a Finance Operator, I want to see location breakdown on INV3.",
      "acceptanceCriteria": [
        "Separate invoice lines per location (if multiple)",
        "Each line: location name, bottle-days, rate, amount",
        "Summary totals",
        "Typecheck passes"
      ],
      "priority": 44,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E045",
      "title": "INV3 custody block on non-payment",
      "description": "As a Developer, I want to block custody operations for unpaid INV3.",
      "acceptanceCriteria": [
        "If INV3 overdue > X days (configurable)",
        "Sets StorageBillingPeriod.status = blocked",
        "Emits StoragePaymentBlocked event (for Module B/C eligibility)",
        "Warning visible in customer view",
        "Block removable only after payment",
        "Typecheck passes"
      ],
      "priority": 45,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E046",
      "title": "INV3 preview before generation",
      "description": "As a Finance Operator, I want to preview INV3 before generation.",
      "acceptanceCriteria": [
        "Page Storage Billing Preview in Finance",
        "Shows projected invoices for current period",
        "Breakdown per customer and location",
        "Action Generate Invoices for confirmation",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 46,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E047",
      "title": "INV4 auto-generation from event booking",
      "description": "As a Developer, I want INV4 to be auto-generated from event booking.",
      "acceptanceCriteria": [
        "Listener for EventBookingConfirmed event",
        "Creates Invoice with type = INV4",
        "Source reference: event_booking_id",
        "Invoice lines: event fee, service fees",
        "Typecheck passes"
      ],
      "priority": 47,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E048",
      "title": "INV4 service fee types",
      "description": "As a Developer, I want to support different service fee types on INV4.",
      "acceptanceCriteria": [
        "Support for: event attendance, tasting fees, consultation, other services",
        "Invoice line description specifies type",
        "Metadata includes service_type",
        "Typecheck passes"
      ],
      "priority": 48,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E049",
      "title": "INV4 manual creation support",
      "description": "As a Finance Operator, I want to create INV4 manually for ad-hoc services.",
      "acceptanceCriteria": [
        "Create Invoice form allows INV4 without required source reference",
        "Warning: INV4 without event reference is for ad-hoc services only",
        "Reason/description required",
        "Typecheck passes"
      ],
      "priority": 49,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E050",
      "title": "INV4 event cost pass-through",
      "description": "As a Developer, I want INV4 to not include event costs (only pass-through).",
      "acceptanceCriteria": [
        "Invariant: INV4 lines do not include wine/inventory costs",
        "Only: attendance fees, service fees, handling",
        "Validation blocks lines with sellable_sku type = bottle",
        "Typecheck passes"
      ],
      "priority": 50,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E051",
      "title": "Payment List in Filament",
      "description": "As a Finance Operator, I want a payment list for monitoring.",
      "acceptanceCriteria": [
        "PaymentResource in Filament with navigation group Finance",
        "List with columns: payment_reference, source (badge), amount, currency, status, reconciliation_status, customer, received_at",
        "Filters: source, status, reconciliation_status, date range",
        "Search by: payment_reference, stripe_payment_intent_id, customer",
        "Tabs: All, Pending Reconciliation, Confirmed",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 51,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E052",
      "title": "Payment Detail view",
      "description": "As a Finance Operator, I want to see payment details.",
      "acceptanceCriteria": [
        "Header: payment_reference, source, amount, status",
        "Section 1 - Source Details: stripe_payment_intent_id, stripe_charge_id, OR bank_reference",
        "Section 2 - Applied Invoices: list of InvoicePayments with amount_applied",
        "Section 3 - Reconciliation: status, mismatched details (if present)",
        "Section 4 - Metadata: raw metadata JSON",
        "Section 5 - Audit: event timeline",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 52,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E053",
      "title": "Stripe payment auto-reconciliation",
      "description": "As a Developer, I want Stripe payments to reconcile automatically.",
      "acceptanceCriteria": [
        "Webhook payment_intent.succeeded creates Payment with status confirmed",
        "Method autoReconcile(Payment): finds invoice with matching amount and customer",
        "If unique match: applies payment, sets reconciliation_status = matched",
        "If no match or multi-match: sets reconciliation_status = pending",
        "Typecheck passes"
      ],
      "priority": 53,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E054",
      "title": "Bank transfer manual reconciliation",
      "description": "As a Finance Operator, I want to manually reconcile bank payments.",
      "acceptanceCriteria": [
        "Action Apply to Invoice on pending Payment",
        "Form: select invoice (filtered by customer if present), amount to apply",
        "Validation: amount <= outstanding on invoice",
        "Partial application supported",
        "Audit log of application",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 54,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E055",
      "title": "Payment mismatch resolution",
      "description": "As a Finance Operator, I want to resolve payment mismatches.",
      "acceptanceCriteria": [
        "Payments with reconciliation_status = mismatched highlighted",
        "Mismatch reasons: amount difference, customer mismatch, duplicate",
        "Actions: Force Match, Create Exception, Refund",
        "Each resolution requires reason",
        "Audit log of resolution",
        "Typecheck passes"
      ],
      "priority": 55,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E056",
      "title": "Record Bank Payment action",
      "description": "As a Finance Operator, I want to manually record bank payments.",
      "acceptanceCriteria": [
        "Action Record Bank Payment in Invoice Detail",
        "Form: amount, bank_reference, received_date",
        "Creates Payment with source = bank_transfer",
        "Auto-applies to current invoice",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 56,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E057",
      "title": "Payment split across invoices",
      "description": "As a Finance Operator, I want to apply a payment to multiple invoices.",
      "acceptanceCriteria": [
        "Action Apply to Multiple Invoices on Payment",
        "Form: list of invoices with amount input for each",
        "Validation: sum of amounts <= payment.amount",
        "Creates multiple InvoicePayment records",
        "Typecheck passes"
      ],
      "priority": 57,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E058",
      "title": "Overpayment handling",
      "description": "As a Developer, I want to handle overpayments correctly.",
      "acceptanceCriteria": [
        "If payment.amount > invoice.outstanding",
        "Option 1: Apply partial (leave remainder)",
        "Option 2: Apply full and create customer credit",
        "Customer credit visible in customer finance view",
        "Typecheck passes"
      ],
      "priority": 58,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E059",
      "title": "Payment failure handling",
      "description": "As a Developer, I want to handle Stripe payment failures.",
      "acceptanceCriteria": [
        "Webhook payment_intent.payment_failed creates/updates Payment with status = failed",
        "Log failure reason (metadata)",
        "Invoice remains issued (not paid)",
        "Internal notification for follow-up",
        "Typecheck passes"
      ],
      "priority": 59,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E060",
      "title": "Duplicate payment detection",
      "description": "As a Developer, I want to prevent duplicate payments.",
      "acceptanceCriteria": [
        "Stripe: stripe_payment_intent_id unique constraint",
        "Bank: warning if same amount + same customer + same day",
        "UI shows potential duplicates",
        "Operator can confirm or reject",
        "Typecheck passes"
      ],
      "priority": 60,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E061",
      "title": "PaymentService for payment management",
      "description": "As a Developer, I want a service to centralize payment logic.",
      "acceptanceCriteria": [
        "Service class PaymentService in app/Services/Finance/",
        "Method createFromStripe(PaymentIntent): creates Payment from Stripe webhook",
        "Method createBankPayment(amount, reference, customer): creates manual Payment",
        "Method applyToInvoice(Payment, Invoice, amount): creates InvoicePayment",
        "Method autoReconcile(Payment): attempts automatic match",
        "Method markReconciled(Payment, status): updates reconciliation",
        "Typecheck passes"
      ],
      "priority": 61,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E062",
      "title": "Payment audit trail",
      "description": "As a Compliance Officer, I want complete audit trail for payments.",
      "acceptanceCriteria": [
        "Auditable trait on Payment, InvoicePayment",
        "Events logged: creation, application, reconciliation, status_change",
        "Audit visible in Payment Detail",
        "Immutable logs",
        "Typecheck passes"
      ],
      "priority": 62,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E063",
      "title": "Credit Note List in Filament",
      "description": "As a Finance Operator, I want a credit notes list.",
      "acceptanceCriteria": [
        "CreditNoteResource in Filament with navigation group Finance",
        "List: credit_note_number, invoice_number, customer, amount, status, issued_at, reason (truncated)",
        "Filters: status, date range, customer",
        "Search by: credit_note_number, invoice_number",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 63,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-E064",
      "title": "Credit Note Detail view",
      "description": "As a Finance Operator, I want to see credit note details.",
      "acceptanceCriteria": [
        "Header: credit_note_number, amount, status",
        "Section 1 - Original Invoice: link to invoice, type, amount",
        "Section 2 - Reason: full reason text",
        "Section 3 - Application: applied_at, related refund (if any)",
        "Section 4 - Accounting: xero_credit_note_id, sync status",
        "Section 5 - Audit: timeline",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 64,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E065",
      "title": "Create Credit Note from Invoice",
      "description": "As a Finance Operator, I want to create credit note from an invoice.",
      "acceptanceCriteria": [
        "Action Create Credit Note in Invoice Detail",
        "Form: amount (max = invoice total), reason (required textarea)",
        "Validation: amount > 0 and <= outstanding",
        "Credit note created in draft status",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 65,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E066",
      "title": "Credit Note issuance",
      "description": "As a Finance Operator, I want to issue a credit note.",
      "acceptanceCriteria": [
        "Action Issue on credit note draft",
        "Generates sequential credit_note_number (format: CN-YYYY-NNNNNN)",
        "Sets issued_at = now()",
        "Triggers Xero sync",
        "Updates invoice status if fully credited",
        "Typecheck passes"
      ],
      "priority": 66,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E067",
      "title": "Credit Note preserves invoice type",
      "description": "As a Developer, I want credit note to preserve original invoice type.",
      "acceptanceCriteria": [
        "Credit note metadata includes original_invoice_type",
        "Reporting can filter by original invoice type",
        "Invariant: credit note cannot change invoice type",
        "Typecheck passes"
      ],
      "priority": 67,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E068",
      "title": "Refund List in Filament",
      "description": "As a Finance Operator, I want a refunds list.",
      "acceptanceCriteria": [
        "RefundResource in Filament with navigation group Finance",
        "List: refund_id, invoice_number, amount, method, status, processed_at",
        "Filters: method, status, date range",
        "Search by: invoice_number, stripe_refund_id",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 68,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E069",
      "title": "Refund Detail view",
      "description": "As a Finance Operator, I want to see refund details.",
      "acceptanceCriteria": [
        "Header: refund_id, amount, method, status",
        "Section 1 - Linked Invoice: link to invoice",
        "Section 2 - Linked Payment: link to payment",
        "Section 3 - Linked Credit Note: link if present",
        "Section 4 - Processing: stripe_refund_id or bank_reference, processed_at",
        "Section 5 - Reason: full reason text",
        "Section 6 - Audit: timeline",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 69,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E070",
      "title": "Create Refund from Invoice",
      "description": "As a Finance Operator, I want to create refund from a paid invoice.",
      "acceptanceCriteria": [
        "Action Refund in Invoice Detail (only if paid)",
        "Form: refund_type (full/partial), amount (if partial), payment to refund (select), method, reason (required)",
        "Validation: payment linked to invoice",
        "Validation: amount <= payment applied amount",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 70,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E071",
      "title": "Stripe refund processing",
      "description": "As a Developer, I want to process refunds via Stripe.",
      "acceptanceCriteria": [
        "If method = stripe and payment has stripe_charge_id",
        "Calls Stripe Refund API",
        "Saves stripe_refund_id",
        "Updates status = processed after confirmation",
        "Error handling with retry",
        "Typecheck passes"
      ],
      "priority": 71,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E072",
      "title": "Bank refund tracking",
      "description": "As a Finance Operator, I want to track bank transfer refunds.",
      "acceptanceCriteria": [
        "If method = bank_transfer",
        "Form requires bank_reference (post-processing)",
        "Status flow: pending to processed (after reference input)",
        "Action Mark Processed with bank_reference input",
        "Typecheck passes"
      ],
      "priority": 72,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E073",
      "title": "Refund operational warning",
      "description": "As a Developer, I want to show warning that refund does not revoke operations.",
      "acceptanceCriteria": [
        "Prominent warning in Create Refund form",
        "Text: Refunding does not automatically reverse operational effects (e.g., voucher cancellation). Coordinate with Operations if needed.",
        "Checkbox confirmation: I understand this is a financial transaction only",
        "Typecheck passes"
      ],
      "priority": 73,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E074",
      "title": "CreditNoteService for credit note management",
      "description": "As a Developer, I want a service to manage credit notes.",
      "acceptanceCriteria": [
        "Service class CreditNoteService in app/Services/Finance/",
        "Method createDraft(Invoice, amount, reason): creates credit note draft",
        "Method issue(CreditNote): issues credit note",
        "Method apply(CreditNote): applies to invoice",
        "Typecheck passes"
      ],
      "priority": 74,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E075",
      "title": "RefundService for refund management",
      "description": "As a Developer, I want a service to manage refunds.",
      "acceptanceCriteria": [
        "Service class RefundService in app/Services/Finance/",
        "Method create(Invoice, Payment, type, amount, method, reason): creates refund",
        "Method processStripeRefund(Refund): calls Stripe API",
        "Method markProcessed(Refund, reference): for bank refunds",
        "Typecheck passes"
      ],
      "priority": 75,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E076",
      "title": "Customer Financial Dashboard",
      "description": "As a Finance Operator, I want a complete financial view per customer.",
      "acceptanceCriteria": [
        "Page Customer Finance in Finance section",
        "Select customer (autocomplete)",
        "Shows: balance summary, open invoices, payment history, credits",
        "Link to Customer Resource (Module K)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 76,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E077",
      "title": "Customer Open Invoices tab",
      "description": "As a Finance Operator, I want to see customer open invoices.",
      "acceptanceCriteria": [
        "Tab Open Invoices in Customer Finance View",
        "List: invoice_number, type, amount, outstanding, due_date, status",
        "Sorted by due_date (oldest first)",
        "Total outstanding prominent",
        "Link to Invoice Detail",
        "Typecheck passes"
      ],
      "priority": 77,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E078",
      "title": "Customer Payment History tab",
      "description": "As a Finance Operator, I want to see customer payment history.",
      "acceptanceCriteria": [
        "Tab Payment History in Customer Finance View",
        "List: payment_reference, amount, date, applied_to (invoices)",
        "Sorted by date (newest first)",
        "Filter by date range",
        "Typecheck passes"
      ],
      "priority": 78,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E079",
      "title": "Customer Credits & Refunds tab",
      "description": "As a Finance Operator, I want to see customer credit notes and refunds.",
      "acceptanceCriteria": [
        "Tab Credits & Refunds in Customer Finance View",
        "Section 1: Credit Notes list",
        "Section 2: Refunds list",
        "Total credits summary",
        "Typecheck passes"
      ],
      "priority": 79,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E080",
      "title": "Customer Exposure & Limits tab",
      "description": "As a Finance Operator, I want to see customer financial exposure.",
      "acceptanceCriteria": [
        "Tab Exposure & Limits in Customer Finance View",
        "Metrics: total outstanding, overdue amount, credit limit (if defined), available credit",
        "Chart: exposure trend over time",
        "Typecheck passes"
      ],
      "priority": 80,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E081",
      "title": "Customer Eligibility Signals tab",
      "description": "As a Finance Operator, I want to understand why a customer is blocked.",
      "acceptanceCriteria": [
        "Tab Eligibility Signals in Customer Finance View",
        "List active blocks: payment_blocked (INV0 overdue), custody_blocked (INV3 overdue)",
        "For each block: reason, invoice reference, how to resolve",
        "Message: This view shows FINANCIAL eligibility only. See Module K for full eligibility.",
        "Typecheck passes"
      ],
      "priority": 81,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E082",
      "title": "CustomerFinanceService for customer view",
      "description": "As a Developer, I want a service to aggregate customer financial data.",
      "acceptanceCriteria": [
        "Service class CustomerFinanceService in app/Services/Finance/",
        "Method getOpenInvoices(Customer): returns unpaid invoices",
        "Method getTotalOutstanding(Customer): sum of outstanding",
        "Method getOverdueAmount(Customer): sum of overdue",
        "Method getPaymentHistory(Customer, dateRange): list of payments",
        "Method getEligibilitySignals(Customer): list of active blocks",
        "Typecheck passes"
      ],
      "priority": 82,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E083",
      "title": "Subscription List in Filament",
      "description": "As a Finance Operator, I want to manage subscriptions.",
      "acceptanceCriteria": [
        "SubscriptionResource in Filament with navigation group Finance",
        "List: subscription_id, customer, plan_name, billing_cycle, amount, status, next_billing_date",
        "Filters: plan_type, status, billing_cycle",
        "Search by: customer name",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 83,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E084",
      "title": "Subscription Detail view",
      "description": "As a Finance Operator, I want to see subscription details.",
      "acceptanceCriteria": [
        "Header: subscription_id, customer, plan_name, status",
        "Section 1 - Plan Details: type, billing_cycle, amount, started_at",
        "Section 2 - Billing: next_billing_date, payment_method (Stripe)",
        "Section 3 - Invoices: list of INV0 generated from this subscription",
        "Section 4 - Actions: Suspend, Resume, Cancel",
        "Section 5 - Audit: timeline",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 84,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E085",
      "title": "Subscription status transitions",
      "description": "As a Developer, I want to manage subscription status transitions.",
      "acceptanceCriteria": [
        "Valid transitions: active to suspended, suspended to active, active to cancelled, suspended to cancelled",
        "Suspended: no billing, customer blocked",
        "Cancelled: terminal, no further billing",
        "Each transition logs user_id, timestamp, reason",
        "Typecheck passes"
      ],
      "priority": 85,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E086",
      "title": "SubscriptionBillingService",
      "description": "As a Developer, I want a service for subscription billing.",
      "acceptanceCriteria": [
        "Service class SubscriptionBillingService in app/Services/Finance/",
        "Method getSubscriptionsDue(): returns subscriptions with next_billing_date = today",
        "Method generateInvoice(Subscription): creates INV0",
        "Method calculateProRata(Subscription, start, end): calculates pro-rata amount",
        "Method advanceNextBillingDate(Subscription): updates next_billing_date",
        "Typecheck passes"
      ],
      "priority": 86,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E087",
      "title": "Storage Billing List in Filament",
      "description": "As a Finance Operator, I want to see storage billing periods.",
      "acceptanceCriteria": [
        "StorageBillingResource in Filament with navigation group Finance",
        "List: period, customer, bottle_count, bottle_days, amount, status, invoice (link)",
        "Filters: period, status, customer",
        "Tabs: Current Period, Past Periods",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 87,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E088",
      "title": "Storage Billing Detail view",
      "description": "As a Finance Operator, I want to see storage billing period details.",
      "acceptanceCriteria": [
        "Header: period (start-end), customer, status",
        "Section 1 - Usage: bottle_count, bottle_days, rate, calculated_amount",
        "Section 2 - Location Breakdown: if multiple locations",
        "Section 3 - Invoice: link if generated",
        "Section 4 - Calculation Details: methodology, snapshots",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 88,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E089",
      "title": "StorageBillingService",
      "description": "As a Developer, I want a service for storage billing.",
      "acceptanceCriteria": [
        "Service class StorageBillingService in app/Services/Finance/",
        "Method calculatePeriod(Customer, start, end): calculates usage and amount",
        "Method getBottleDays(Customer, start, end): calculates bottle-days",
        "Method getApplicableRate(Customer, Location, volume): returns rate",
        "Method generatePeriods(periodStart, periodEnd): generates StorageBillingPeriod for all customers",
        "Method generateInvoices(): creates INV3 for pending periods",
        "Typecheck passes"
      ],
      "priority": 89,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E090",
      "title": "Storage billing period configuration",
      "description": "As an Admin, I want to configure storage billing periods.",
      "acceptanceCriteria": [
        "Config for billing_cycle: monthly, quarterly",
        "Config for rate_tiers (volume-based)",
        "Config for minimum_charge",
        "Stored in config file or database settings",
        "Typecheck passes"
      ],
      "priority": 90,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E091",
      "title": "Storage billing run job",
      "description": "As a Developer, I want a scheduled job for storage billing.",
      "acceptanceCriteria": [
        "Job GenerateStorageBillingJob",
        "Triggered: first day of new period",
        "Creates StorageBillingPeriod for all customers with storage",
        "Optionally auto-generates INV3",
        "Log job execution",
        "Typecheck passes"
      ],
      "priority": 91,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E092",
      "title": "Storage billing manual trigger",
      "description": "As a Finance Operator, I want to manually trigger storage billing.",
      "acceptanceCriteria": [
        "Action Generate Billing in Storage Billing section",
        "Select period (start, end)",
        "Preview affected customers and amounts",
        "Confirm to generate",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 92,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E093",
      "title": "Stripe webhook handler",
      "description": "As a Developer, I want to process Stripe webhooks with idempotency.",
      "acceptanceCriteria": [
        "Endpoint POST /api/webhooks/stripe",
        "Verifies Stripe signature",
        "Creates StripeWebhook record",
        "Idempotency: skip if event_id already processed",
        "Dispatch job for async processing",
        "Return 200 immediately",
        "Typecheck passes"
      ],
      "priority": 93,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E094",
      "title": "Stripe webhook event processing",
      "description": "As a Developer, I want to process different Stripe event types.",
      "acceptanceCriteria": [
        "Handler for: payment_intent.succeeded, payment_intent.payment_failed, charge.refunded, charge.dispute.created",
        "payment_intent.succeeded: creates/updates Payment, auto-reconcile",
        "payment_intent.payment_failed: log failure",
        "charge.refunded: creates Refund record",
        "charge.dispute.created: flags invoice as disputed",
        "Typecheck passes"
      ],
      "priority": 94,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E095",
      "title": "Stripe integration health monitoring",
      "description": "As a Finance Operator, I want to monitor Stripe integration health.",
      "acceptanceCriteria": [
        "Page Integrations Health in Finance",
        "Section Stripe: last webhook received, failed events count, pending reconciliations",
        "Alert if no webhooks in last hour",
        "List recent failed events with retry action",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 95,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E096",
      "title": "Stripe failed webhook retry",
      "description": "As a Finance Operator, I want to retry failed Stripe webhooks.",
      "acceptanceCriteria": [
        "List failed webhooks (processed = false, error_message not null)",
        "Action Retry for single webhook",
        "Action Retry All Failed for bulk",
        "Log retry attempts",
        "Typecheck passes"
      ],
      "priority": 96,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E097",
      "title": "StripeIntegrationService",
      "description": "As a Developer, I want a service for Stripe integration.",
      "acceptanceCriteria": [
        "Service class StripeIntegrationService in app/Services/Finance/",
        "Method processWebhook(StripeWebhook): dispatches appropriate handler",
        "Method handlePaymentSucceeded(PaymentIntent): creates Payment",
        "Method handlePaymentFailed(PaymentIntent): logs failure",
        "Method processRefund(StripeRefund): creates Refund record",
        "Method getIntegrationHealth(): returns health metrics",
        "Typecheck passes"
      ],
      "priority": 97,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E098",
      "title": "Xero invoice sync",
      "description": "As a Developer, I want to sync issued invoices with Xero.",
      "acceptanceCriteria": [
        "When invoice.status = issued",
        "Creates XeroSyncLog with sync_type = invoice",
        "Calls Xero API to create invoice",
        "Saves xero_invoice_id on Invoice",
        "Error handling with retry",
        "Typecheck passes"
      ],
      "priority": 98,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E099",
      "title": "Xero credit note sync",
      "description": "As a Developer, I want to sync credit notes with Xero.",
      "acceptanceCriteria": [
        "When credit_note.status = issued",
        "Creates XeroSyncLog with sync_type = credit_note",
        "Calls Xero API to create credit note",
        "Saves xero_credit_note_id",
        "Error handling with retry",
        "Typecheck passes"
      ],
      "priority": 99,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E100",
      "title": "Xero integration health monitoring",
      "description": "As a Finance Operator, I want to monitor Xero integration health.",
      "acceptanceCriteria": [
        "Section Xero in Integrations Health page",
        "Metrics: last sync, pending syncs count, failed syncs count",
        "Alert if failed syncs > threshold",
        "List failed syncs with retry action",
        "Typecheck passes"
      ],
      "priority": 100,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E101",
      "title": "Xero failed sync retry",
      "description": "As a Finance Operator, I want to retry failed Xero syncs.",
      "acceptanceCriteria": [
        "List failed XeroSyncLogs",
        "Action Retry for single sync",
        "Action Retry All Failed for bulk",
        "Increment retry_count",
        "Max retries configurable",
        "Typecheck passes"
      ],
      "priority": 101,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E102",
      "title": "XeroIntegrationService",
      "description": "As a Developer, I want a service for Xero integration.",
      "acceptanceCriteria": [
        "Service class XeroIntegrationService in app/Services/Finance/",
        "Method syncInvoice(Invoice): creates invoice in Xero",
        "Method syncCreditNote(CreditNote): creates credit note in Xero",
        "Method syncPayment(Payment): optional, syncs payment",
        "Method retryFailed(XeroSyncLog): retries single sync",
        "Method getIntegrationHealth(): returns health metrics",
        "Typecheck passes"
      ],
      "priority": 102,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E103",
      "title": "Integration configuration page",
      "description": "As an Admin, I want to configure Stripe and Xero integrations.",
      "acceptanceCriteria": [
        "Settings page for: Stripe API keys, Xero OAuth, sync settings",
        "Test connection buttons",
        "Masked display of sensitive values",
        "Stored securely (env or encrypted db)",
        "Typecheck passes"
      ],
      "priority": 103,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E104",
      "title": "Xero sync mandatory for issued invoices",
      "description": "As a Developer, I want Xero sync to be mandatory for issued invoices.",
      "acceptanceCriteria": [
        "Invariant: every issued invoice must have XeroSyncLog",
        "If sync fails: invoice remains issued but flagged sync_pending",
        "Alert for invoices issued without xero_invoice_id",
        "Dashboard widget for pending syncs",
        "Typecheck passes"
      ],
      "priority": 104,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E105",
      "title": "Integration webhook logging",
      "description": "As a Developer, I want complete logging for integration debugging.",
      "acceptanceCriteria": [
        "StripeWebhook: complete payload stored",
        "XeroSyncLog: request and response payload stored",
        "Logs retention: 90 days (configurable)",
        "Log sanitization: no sensitive data in plain text",
        "Typecheck passes"
      ],
      "priority": 105,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E106",
      "title": "Invoice Aging Report",
      "description": "As a Finance Operator, I want an invoice aging report.",
      "acceptanceCriteria": [
        "Page Reports in Finance with sub-page Invoice Aging",
        "Buckets: Current, 1-30 days, 31-60 days, 61-90 days, 90+ days",
        "Breakdown per customer",
        "Totals per bucket",
        "Export to CSV",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 106,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E107",
      "title": "Revenue by Invoice Type Report",
      "description": "As a Finance Operator, I want a revenue by invoice type report.",
      "acceptanceCriteria": [
        "Sub-page Revenue by Type in Reports",
        "Period selector (monthly, quarterly, yearly)",
        "Breakdown: INV0, INV1, INV2, INV3, INV4",
        "Amounts: issued, paid, outstanding",
        "Chart visualization",
        "Export to CSV",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 107,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E108",
      "title": "Outstanding Exposure Report",
      "description": "As a Finance Operator, I want an outstanding exposure report.",
      "acceptanceCriteria": [
        "Sub-page Outstanding Exposure in Reports",
        "Total outstanding by customer",
        "Total outstanding by invoice type",
        "Trend over time (chart)",
        "Export to CSV",
        "Typecheck passes"
      ],
      "priority": 108,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E109",
      "title": "FX Impact Summary Report",
      "description": "As a Finance Operator, I want an FX impact report.",
      "acceptanceCriteria": [
        "Sub-page FX Impact in Reports",
        "Invoices grouped by currency",
        "Payments grouped by currency",
        "FX gain/loss calculation (if applicable)",
        "Period selector",
        "Typecheck passes"
      ],
      "priority": 109,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E110",
      "title": "Audit Export for compliance",
      "description": "As a Compliance Officer, I want to export audit logs.",
      "acceptanceCriteria": [
        "Page Audit Export in Finance",
        "Filters: entity type, date range, user",
        "Export formats: CSV, JSON",
        "Include: entity_id, event_type, user, timestamp, changes",
        "Download file",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 110,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E111",
      "title": "Event-to-Invoice traceability report",
      "description": "As an Auditor, I want to trace ERP events to invoices.",
      "acceptanceCriteria": [
        "Report showing: ERP Event to Invoice to Payment",
        "Filter by: event type (sale, shipment, storage), date range",
        "Shows unmatched events (events without invoices)",
        "Export to CSV",
        "Typecheck passes"
      ],
      "priority": 111,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E112",
      "title": "Reconciliation Status Report",
      "description": "As a Finance Operator, I want a reconciliation status report.",
      "acceptanceCriteria": [
        "Sub-page Reconciliation Status in Reports",
        "Payments by reconciliation_status",
        "List pending reconciliations",
        "List mismatches with resolution status",
        "Typecheck passes"
      ],
      "priority": 112,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E113",
      "title": "Monthly Financial Summary",
      "description": "As a Finance Manager, I want a monthly summary.",
      "acceptanceCriteria": [
        "Dashboard widget Monthly Summary",
        "Metrics: invoices issued, payments received, credit notes, refunds",
        "Comparison vs previous month",
        "By invoice type breakdown",
        "Typecheck passes"
      ],
      "priority": 113,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E114",
      "title": "Audit trail immutability enforcement",
      "description": "As a Developer, I want audit logs to be immutable.",
      "acceptanceCriteria": [
        "Audit logs table: no update, no delete operations",
        "Model observer prevents modifications",
        "Soft deletes disabled on audit tables",
        "Test that verifies immutability",
        "Typecheck passes"
      ],
      "priority": 114,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E115",
      "title": "Audit log retention policy",
      "description": "As a Developer, I want a retention policy for audit logs.",
      "acceptanceCriteria": [
        "Audit logs: retained indefinitely (statutory requirement)",
        "Integration logs (Stripe, Xero): 90 days retention",
        "Job for cleanup of expired logs",
        "Config for retention periods",
        "Typecheck passes"
      ],
      "priority": 115,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E116",
      "title": "Finance Overview Dashboard",
      "description": "As a Finance Manager, I want a dashboard overview as landing page.",
      "acceptanceCriteria": [
        "Page Finance Overview as default landing",
        "Widget: Total Outstanding",
        "Widget: Overdue Amount",
        "Widget: Payments This Month",
        "Widget: Pending Reconciliations",
        "Widget: Integration Health (Stripe, Xero status)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 116,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E117",
      "title": "Dashboard quick actions",
      "description": "As a Finance Operator, I want quick actions from dashboard.",
      "acceptanceCriteria": [
        "Quick action: View Overdue Invoices",
        "Quick action: Pending Reconciliations",
        "Quick action: Failed Syncs",
        "Quick action: Generate Storage Billing",
        "Links to respective sections",
        "Typecheck passes"
      ],
      "priority": 117,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E118",
      "title": "Dashboard recent activity feed",
      "description": "As a Finance Operator, I want to see recent activity.",
      "acceptanceCriteria": [
        "Widget Recent Activity",
        "Shows: invoices issued, payments received, credit notes, refunds",
        "Last 24 hours",
        "Click to navigate to detail",
        "Typecheck passes"
      ],
      "priority": 118,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E119",
      "title": "Dashboard alerts and warnings",
      "description": "As a Finance Operator, I want visible alerts in dashboard.",
      "acceptanceCriteria": [
        "Alert: X invoices overdue",
        "Alert: X payments pending reconciliation",
        "Alert: Xero sync failures",
        "Alert: Stripe webhook issues",
        "Dismissible alerts with persistence",
        "Typecheck passes"
      ],
      "priority": 119,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E120",
      "title": "Dashboard period comparison",
      "description": "As a Finance Manager, I want to compare periods.",
      "acceptanceCriteria": [
        "Widget: This Month vs Last Month",
        "Metrics: invoices issued, amount collected, credit notes",
        "Percentage change indicators",
        "Color coding: green (improvement), red (decline)",
        "Typecheck passes"
      ],
      "priority": 120,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E121",
      "title": "Dashboard customer top outstanding",
      "description": "As a Finance Manager, I want to see top customers by outstanding.",
      "acceptanceCriteria": [
        "Widget: Top 10 Outstanding",
        "List customers with: name, outstanding amount",
        "Click to open Customer Finance View",
        "Typecheck passes"
      ],
      "priority": 121,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E122",
      "title": "Finance navigation structure",
      "description": "As a Developer, I want a clear Finance navigation structure.",
      "acceptanceCriteria": [
        "Navigation group Finance with icon",
        "Sub-items: Overview, Invoices, Payments, Credit Notes, Refunds, Customers, Subscriptions, Storage Billing, Integrations, Reports",
        "Active state highlighting",
        "Role-based visibility",
        "Typecheck passes"
      ],
      "priority": 122,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E123",
      "title": "Invoice type immutability enforcement",
      "description": "As a Developer, I want strict enforcement of invoice type immutability.",
      "acceptanceCriteria": [
        "invoice_type field immutable at model level (no update ever)",
        "Attempt to change throws exception",
        "UI does not show edit for invoice_type",
        "Test that verifies immutability",
        "Typecheck passes"
      ],
      "priority": 123,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E124",
      "title": "No invoice merge/split policy",
      "description": "As a Developer, I want to enforce no merge/split invoice policy.",
      "acceptanceCriteria": [
        "No merge invoices actions in UI",
        "No split invoice actions in UI",
        "Documentation: Each invoice is atomic. For corrections, use credit notes.",
        "Typecheck passes"
      ],
      "priority": 124,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E125",
      "title": "No VAT override post-issuance",
      "description": "As a Developer, I want to block VAT changes after issuance.",
      "acceptanceCriteria": [
        "tax_rate, tax_amount not modifiable on issued invoices",
        "tax_amount on invoice_lines not modifiable after issuance",
        "UI disables edit for tax fields",
        "For corrections: credit note + new invoice",
        "Typecheck passes"
      ],
      "priority": 125,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E126",
      "title": "Amounts immutability post-issuance",
      "description": "As a Developer, I want to enforce amounts immutability.",
      "acceptanceCriteria": [
        "subtotal, tax_amount, total_amount not modifiable after issuance",
        "invoice_lines (all fields) not modifiable after issuance",
        "Model observer blocks update attempts",
        "Explicit exception: Invoice amounts are immutable after issuance. Use credit notes for corrections.",
        "Typecheck passes"
      ],
      "priority": 126,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E127",
      "title": "Payment evidence not authority principle",
      "description": "As a Developer, I want payments to not create operational rights.",
      "acceptanceCriteria": [
        "INV1 payment emits event but does not create vouchers directly",
        "INV2 payment does not trigger shipment",
        "Documentation: Payments are evidence, not authority. Operational modules react to payment events but Finance does not control operations.",
        "Typecheck passes"
      ],
      "priority": 127,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E128",
      "title": "Refund requires invoice+payment link",
      "description": "As a Developer, I want to enforce invoice+payment link for refunds.",
      "acceptanceCriteria": [
        "Refund creation requires: invoice_id + payment_id",
        "Validation: payment must have InvoicePayment for the invoice",
        "Cannot refund payment not applied to invoice",
        "Typecheck passes"
      ],
      "priority": 128,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E129",
      "title": "Reconciliation before business logic",
      "description": "As a Developer, I want reconciliation to precede business logic.",
      "acceptanceCriteria": [
        "Payment with reconciliation_status = pending does not trigger downstream events",
        "Only payments with reconciliation_status = matched emit InvoicePaid event",
        "Documentation: Payment must be reconciled before triggering business events.",
        "Typecheck passes"
      ],
      "priority": 129,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E130",
      "title": "No invoice without trigger event (INV1-4)",
      "description": "As a Developer, I want INV1-INV4 to require source reference.",
      "acceptanceCriteria": [
        "INV1: requires source_type = voucher_sale, source_id required",
        "INV2: requires source_type = shipping_order, source_id required",
        "INV3: requires source_type = storage_billing_period, source_id required",
        "INV4: source optional (for ad-hoc services), but warning if missing",
        "INV0: source = subscription",
        "Validation blocks creation without source (except INV0 manual and INV4 ad-hoc)",
        "Typecheck passes"
      ],
      "priority": 130,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E131",
      "title": "Finance as consequence principle",
      "description": "As a Developer, I want to enforce Finance is consequence principle.",
      "acceptanceCriteria": [
        "Finance does not trigger operational events directly",
        "Finance emits events (InvoicePaid, PaymentReceived) that other modules listen to",
        "Finance does not create vouchers, shipments, or inventory movements",
        "Documentation clear in module intro",
        "Typecheck passes"
      ],
      "priority": 131,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-E132",
      "title": "Duplicate invoice prevention",
      "description": "As a Developer, I want to prevent duplicate invoices for same event.",
      "acceptanceCriteria": [
        "Unique constraint: (source_type, source_id) for non-null values",
        "Validation in InvoiceService.createDraft",
        "If duplicate: return existing invoice instead of creating",
        "Log warning for attempted duplicate",
        "Typecheck passes"
      ],
      "priority": 132,
      "passes": false,
      "notes": ""
    }
  ]
}
