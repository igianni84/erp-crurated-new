{
  "project": "ERP4 - Module S Commercial",
  "branchName": "ralph/module-s-commercial",
  "description": "Module S - Sales & Commercial Management: The commercial brain of the ERP that governs Channels, Price Books, Pricing Policies, Offers, Discounts, Bundles, and pricing simulation",
  "userStories": [
    {
      "id": "US-001",
      "title": "Setup modello Channel",
      "description": "As an Admin, I want to define commercial channels as stable contexts for sales.",
      "acceptanceCriteria": [
        "Tabella `channels` con campi: id, uuid, name, channel_type (enum), default_currency (string), allowed_commercial_models (JSON array), status (enum)",
        "Enum `ChannelType`: b2c, b2b, private_club in app/Enums/Commercial/",
        "Enum `ChannelStatus`: active, inactive in app/Enums/Commercial/",
        "Soft deletes abilitati",
        "allowed_commercial_models può contenere: voucher_based, sell_through",
        "Typecheck e lint passano"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Setup enums base per Commercial",
      "description": "As a Developer, I want well-defined enums for types and statuses of commercial entities.",
      "acceptanceCriteria": [
        "Enum `PriceBookStatus`: draft, active, expired, archived",
        "Enum `PricingPolicyStatus`: draft, active, paused, archived",
        "Enum `PricingPolicyType`: cost_plus_margin, reference_price_book, index_based, fixed_adjustment, rounding",
        "Enum `PricingPolicyInputSource`: cost, emp, price_book, external_index",
        "Enum `OfferStatus`: draft, active, paused, expired, cancelled",
        "Enum `OfferType`: standard, promotion, bundle",
        "Enum `OfferVisibility`: public, restricted",
        "Enum `ExecutionCadence`: manual, scheduled, event_triggered",
        "All enums in `app/Enums/Commercial/`",
        "Typecheck e lint passano"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Setup modello EstimatedMarketPrice (EMP)",
      "description": "As an Admin, I want to store estimated market prices as reference for pricing decisions.",
      "acceptanceCriteria": [
        "Tabella `estimated_market_prices` con: id, sellable_sku_id (FK), market (string), emp_value (decimal 12,2), source (enum), confidence_level (enum), fetched_at (timestamp)",
        "Enum `EmpSource`: livex, internal, composite in app/Enums/Commercial/",
        "Enum `EmpConfidenceLevel`: high, medium, low in app/Enums/Commercial/",
        "Relazione: EstimatedMarketPrice belongsTo SellableSku",
        "Vincolo: combinazione sellable_sku_id + market unica",
        "EMP è read-only in Module S (importato da processo esterno)",
        "Typecheck e lint passano"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Channel List in Filament",
      "description": "As an Operator, I want a list of commercial channels as an overview of the sales context.",
      "acceptanceCriteria": [
        "ChannelResource in Filament con navigation group 'Commercial'",
        "Lista con colonne: name, channel_type, default_currency, status, allowed_models (badges), updated_at",
        "Filtri: channel_type, status",
        "Ricerca per: name",
        "Channels sono raramente modificati (sistema stabile)",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Channel Detail view",
      "description": "As an Operator, I want to see the details of a commercial channel.",
      "acceptanceCriteria": [
        "Tab Overview: name, type, currency, allowed_commercial_models",
        "Tab Price Books: lista Price Books applicabili a questo canale",
        "Tab Offers: lista Offers attivi su questo canale",
        "Tab Audit: timeline eventi",
        "Read-heavy view (canali sono configurazione stabile)",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Pricing Intelligence List view",
      "description": "As an Operator, I want to view EMP for all Sellable SKUs as market reference.",
      "acceptanceCriteria": [
        "Pagina Pricing Intelligence in Filament sotto Commercial",
        "Lista con una riga per Sellable SKU + market",
        "Colonne: sellable_sku (wine + vintage + format + packaging), market, emp_value, confidence, active_price_book_price (nullable), active_offer_price (nullable), delta_vs_emp (percentage), freshness_indicator",
        "Filtri: market, confidence_level, deviation_range (e.g. >10%, >20%)",
        "Ricerca per: SKU name, wine name",
        "Evidenziazione per SKU con deviazione significativa (>15% da EMP)",
        "Vista read-only (nessuna azione di modifica)",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Pricing Intelligence Detail view",
      "description": "As an Operator, I want to see detailed EMP analysis for a Sellable SKU.",
      "acceptanceCriteria": [
        "Tab EMP Overview: valore corrente, source breakdown, last update, trend storico (chart)",
        "Tab Comparisons: EMP vs Price Book prices (per channel), EMP vs active Offer prices",
        "Tab Market Coverage: mercati con EMP, warning per dati mancanti/stale",
        "Tab Signals & Alerts: outlier detection, deviazioni significative",
        "Tab Audit: history aggiornamenti EMP",
        "Nessuna azione di modifica (EMP è importato)",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "EMP Alerts in Commercial Overview",
      "description": "As an Operator, I want to see alerts when prices deviate significantly from EMP.",
      "acceptanceCriteria": [
        "Widget in Commercial Overview che mostra count di SKU con prezzo >15% diverso da EMP",
        "Link a Pricing Intelligence filtrato per deviazione",
        "Alert severity basato su percentuale deviazione",
        "Configurazione threshold in settings (default 15%)",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Setup modello PriceBook",
      "description": "As an Admin, I want to define Price Books as authoritative pricing decisions.",
      "acceptanceCriteria": [
        "Tabella `price_books` con: id, uuid, name, market (string), channel_id (FK nullable), currency (string), valid_from (date), valid_to (date nullable), status (enum), approved_at (timestamp nullable), approved_by (FK users nullable)",
        "Soft deletes abilitati",
        "Relazione: PriceBook belongsTo Channel (optional)",
        "Status transitions: draft → active (requires approval), active → expired (automatic o manual), expired → archived",
        "Solo un PriceBook active per combinazione market+channel+currency alla volta",
        "Typecheck e lint passano"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Setup modello PriceBookEntry",
      "description": "As an Admin, I want to store prices for individual Sellable SKUs in a Price Book.",
      "acceptanceCriteria": [
        "Tabella `price_book_entries` con: id, price_book_id (FK), sellable_sku_id (FK), base_price (decimal 12,2), source (enum: manual, policy_generated), policy_id (FK nullable)",
        "Enum `PriceSource`: manual, policy_generated in app/Enums/Commercial/",
        "Relazione: PriceBookEntry belongsTo PriceBook, belongsTo SellableSku, belongsTo PricingPolicy (optional)",
        "Vincolo: combinazione price_book_id + sellable_sku_id unica",
        "base_price deve essere > 0",
        "Typecheck e lint passano"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "PriceBook List in Filament",
      "description": "As an Operator, I want a list of Price Books as entry point for pricing.",
      "acceptanceCriteria": [
        "PriceBookResource in Filament con navigation group 'Commercial'",
        "Lista con colonne: name, market, channel, currency, valid_from, valid_to, status, entries_count, last_updated",
        "Filtri: status, channel, market, currency",
        "Ricerca per: name",
        "Indicatore visivo per Price Books in scadenza (< 30 giorni)",
        "Indicatore visivo per Price Books con missing prices (SKU allocati senza entry)",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Create PriceBook wizard - Step 1 (Metadata)",
      "description": "As an Operator, I want to define the base metadata of a Price Book.",
      "acceptanceCriteria": [
        "Step 1: name, market (select da lista mercati), channel_id (select nullable), currency",
        "Validazione: name required, currency required",
        "Messaggio: 'Price Books store base prices for all commercially available SKUs'",
        "Preview mercati disponibili basato su allocations attive",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Create PriceBook wizard - Step 2 (Validity)",
      "description": "As an Operator, I want to define the validity period of a Price Book.",
      "acceptanceCriteria": [
        "Step 2: valid_from (date), valid_to (date nullable)",
        "Validazione: valid_to >= valid_from (se presente)",
        "Warning se overlap con Price Book esistente per stessa combinazione market+channel",
        "Spiegazione inline: 'Leave valid_to empty for indefinite validity'",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Create PriceBook wizard - Step 3 (Initial Prices)",
      "description": "As an Operator, I want to optionally import initial prices during creation.",
      "acceptanceCriteria": [
        "Step 3 opzionale: scelta import method",
        "Opzioni: Empty (add prices later), Clone from existing Price Book, Import from CSV",
        "Clone: select source Price Book, preview entries count",
        "CSV: template download, upload, validation preview",
        "Messaggio: 'You can add or modify prices after creation'",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Create PriceBook wizard - Step 4 (Review & Create)",
      "description": "As an Operator, I want to see a summary before creating the Price Book.",
      "acceptanceCriteria": [
        "Step 4: summary di tutti i dati inseriti",
        "Price Book creato in status 'draft'",
        "Messaggio: 'Draft Price Books are not used for pricing until activated'",
        "CTA: 'Create as Draft'",
        "Redirect a Price Book Detail dopo creazione",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "PriceBook Detail con 5 tabs",
      "description": "As an Operator, I want to see all details of a Price Book organized in tabs.",
      "acceptanceCriteria": [
        "Tab Overview: summary, status, validity, coverage stats, linked policies, linked offers",
        "Tab Prices: grid editabile di Sellable SKU + price + source + EMP reference",
        "Tab Scope & Applicability: market, channel, currency, priority rules",
        "Tab Lifecycle: activation history, approval info, expiration",
        "Tab Audit: timeline completa modifiche",
        "Azioni contestuali: Activate (draft→active, richiede approvazione), Archive (active→archived)",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "PriceBook Prices grid editing",
      "description": "As an Operator, I want to edit prices directly in the Price Book grid.",
      "acceptanceCriteria": [
        "Grid paginata con search e filtri",
        "Colonne: sellable_sku, base_price (editable), source (badge), emp_value, delta_vs_emp",
        "Inline edit per base_price",
        "Bulk edit: select multiple rows, set price o percentage adjustment",
        "Source diventa 'manual' quando prezzo è editato manualmente",
        "Filtro: 'Missing prices' (SKU allocati senza entry)",
        "Filtro: 'Policy-generated' vs 'Manual'",
        "Editing permesso solo se Price Book è Draft",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "PriceBook activation workflow",
      "description": "As an Admin, I want Price Book activation to require explicit approval.",
      "acceptanceCriteria": [
        "Transizione draft → active richiede ruolo approver",
        "Approvazione registra approved_at e approved_by",
        "Attivazione verifica: almeno 1 price entry presente",
        "Attivazione verifica: no overlap con altro PriceBook active per stessa combinazione",
        "Se overlap, richiede conferma per expire il precedente",
        "Prices diventano read-only dopo attivazione (create new version per modifiche)",
        "Typecheck e lint passano"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "PriceBookService per gestione Price Books",
      "description": "As a Developer, I want a service to centralize Price Book logic.",
      "acceptanceCriteria": [
        "Service class `PriceBookService` in `app/Services/Commercial/`",
        "Metodo `activate(PriceBook)`: draft → active con validazioni",
        "Metodo `archive(PriceBook)`: active → archived",
        "Metodo `cloneToNew(PriceBook, newMetadata)`: crea nuovo draft da esistente",
        "Metodo `getActiveForContext(channel, market, currency)`: trova Price Book applicabile",
        "Metodo `getPriceForSku(PriceBook, SellableSku)`: restituisce PriceBookEntry o null",
        "Validazioni con eccezioni esplicite",
        "Typecheck e lint passano"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-020",
      "title": "Setup modello PricingPolicy",
      "description": "As an Admin, I want to define Pricing Policies to automate price generation.",
      "acceptanceCriteria": [
        "Tabella `pricing_policies` con: id, uuid, name, policy_type (enum), input_source (enum), target_price_book_id (FK nullable), logic_definition (JSON), execution_cadence (enum), status (enum), last_executed_at (timestamp nullable)",
        "Soft deletes abilitati",
        "Relazione: PricingPolicy belongsTo PriceBook (target)",
        "logic_definition contiene: margin_percentage, markup_value, rounding_rule, tiered_logic (optional)",
        "Policies generano draft prices, mai attivano direttamente",
        "Typecheck e lint passano"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Setup modello PricingPolicyScope",
      "description": "As an Admin, I want to define the application scope of a Pricing Policy.",
      "acceptanceCriteria": [
        "Tabella `pricing_policy_scopes` con: id, pricing_policy_id (FK), scope_type (enum: all, category, product, sku), scope_reference (string nullable), markets (JSON array nullable), channels (JSON array nullable)",
        "Enum `PolicyScopeType`: all, category, product, sku in app/Enums/Commercial/",
        "Relazione: PricingPolicy hasOne PricingPolicyScope",
        "Scope risolve sempre a Sellable SKUs sottostanti",
        "Policies applicano solo a SKU commercialmente disponibili (allocation-derived)",
        "Typecheck e lint passano"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Setup modello PricingPolicyExecution",
      "description": "As an Admin, I want to track Pricing Policy executions.",
      "acceptanceCriteria": [
        "Tabella `pricing_policy_executions` con: id, pricing_policy_id (FK), executed_at, execution_type (enum: manual, scheduled, dry_run), skus_processed (int), prices_generated (int), errors_count (int), status (enum: success, partial, failed), log_summary (text nullable)",
        "Enum `ExecutionType`: manual, scheduled, dry_run in app/Enums/Commercial/",
        "Enum `ExecutionStatus`: success, partial, failed in app/Enums/Commercial/",
        "Relazione: PricingPolicy hasMany PricingPolicyExecution",
        "Execution log immutabile",
        "Typecheck e lint passano"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "PricingPolicy List in Filament",
      "description": "As an Operator, I want a list of Pricing Policies to manage price automation.",
      "acceptanceCriteria": [
        "PricingPolicyResource in Filament con navigation group 'Commercial'",
        "Lista con colonne: name, policy_type, input_source, target_price_book, status, last_executed, next_scheduled (se scheduled)",
        "Filtri: status, policy_type, target_price_book",
        "Ricerca per: name",
        "Indicatore visivo per policies con esecuzioni fallite",
        "CTA: Create Pricing Policy",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Create PricingPolicy wizard - Step 1 (Type)",
      "description": "As an Operator, I want to select the type of Pricing Policy.",
      "acceptanceCriteria": [
        "Step 1: name, policy_type selection",
        "Opzioni type: Cost + Margin, Reference Price Book, External Index (EMP/FX), Fixed Adjustment, Rounding/Normalization",
        "Descrizione inline per ogni tipo",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Create PricingPolicy wizard - Step 2 (Inputs)",
      "description": "As an Operator, I want to define the inputs of the Pricing Policy.",
      "acceptanceCriteria": [
        "Step 2 campi dinamici basati su policy_type",
        "Cost + Margin: cost_source selection",
        "Reference Price Book: source_price_book_id selection",
        "External Index: index_type (emp, fx_rate), currency conversion rules",
        "Fixed Adjustment: adjustment_type (percentage, fixed_amount), value",
        "Rounding: rounding_rule (.90, .95, .99, nearest_5)",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-026",
      "title": "Create PricingPolicy wizard - Step 3 (Logic)",
      "description": "As an Operator, I want to define the calculation logic of the Pricing Policy.",
      "acceptanceCriteria": [
        "Step 3: pricing logic builder",
        "Margin/Markup: percentage o fixed amount",
        "Tiered logic: different margins per category/SKU (optional)",
        "Rounding rules: floor, ceil, nearest, specific pattern",
        "Preview: formula plain-language ('Cost + 25% margin, rounded to .99')",
        "Validazione: logic coerente con policy_type",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 26,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "Create PricingPolicy wizard - Step 4 (Scope & Target)",
      "description": "As an Operator, I want to define scope and target of the Pricing Policy.",
      "acceptanceCriteria": [
        "Step 4: target_price_book_id (required), scope definition",
        "Scope options: All commercially available SKUs, Specific categories, Specific products, Specific SKUs",
        "Market/Channel filters (optional)",
        "Preview: count of SKUs che saranno affected",
        "Warning se scope include SKU senza allocation attiva",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 27,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-028",
      "title": "Create PricingPolicy wizard - Step 5 (Execution)",
      "description": "As an Operator, I want to define the execution cadence of the Pricing Policy.",
      "acceptanceCriteria": [
        "Step 5: execution_cadence selection",
        "Manual: solo esecuzione on-demand",
        "Scheduled: frequency (daily, weekly), time of day",
        "Event-triggered: triggers (cost_change, emp_update, fx_change)",
        "Spiegazione: 'Policies generate draft prices, never activate them directly'",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 28,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-029",
      "title": "Create PricingPolicy wizard - Step 6 (Review & Create)",
      "description": "As an Operator, I want to see a summary before creating the Pricing Policy.",
      "acceptanceCriteria": [
        "Step 6: summary completo di tutti i dati",
        "Preview: formula plain-language",
        "Preview: scope resolved (count SKUs)",
        "Policy creata in status 'draft'",
        "CTA: 'Create as Draft', 'Create and Activate'",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 29,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-030",
      "title": "PricingPolicy Detail con 7 tabs",
      "description": "As an Operator, I want to see all details of a Pricing Policy.",
      "acceptanceCriteria": [
        "Tab Overview: summary, status, last execution result",
        "Tab Logic: inputs, calculations, rounding, formula preview",
        "Tab Scope: resolved SKUs, markets, channels",
        "Tab Execution: manual run button, scheduling info, dry run button",
        "Tab Impact Preview: old price vs new price, EMP delta, warnings",
        "Tab Lifecycle: status transitions, activation history",
        "Tab Audit: immutable log changes and executions",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 30,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-031",
      "title": "PricingPolicy execution (manual & dry-run)",
      "description": "As an Operator, I want to execute a Pricing Policy manually or in dry-run.",
      "acceptanceCriteria": [
        "Button 'Execute Now' in Policy Detail (solo se status = active)",
        "Button 'Dry Run' disponibile sempre per preview",
        "Dry Run: genera preview senza scrivere su Price Book",
        "Execute: scrive prices su target Price Book come policy_generated",
        "Confirmation dialog con impatto (N SKUs, M prices changed)",
        "Execution log creato con risultati",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 31,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-032",
      "title": "PricingPolicyService per gestione policies",
      "description": "As a Developer, I want a service to centralize Pricing Policy logic.",
      "acceptanceCriteria": [
        "Service class `PricingPolicyService` in `app/Services/Commercial/`",
        "Metodo `activate(PricingPolicy)`: draft → active",
        "Metodo `pause(PricingPolicy)`: active → paused",
        "Metodo `archive(PricingPolicy)`: active/paused → archived",
        "Metodo `execute(PricingPolicy, isDryRun = false)`: esegue logica e genera prices",
        "Metodo `resolveScope(PricingPolicy)`: restituisce collection di SellableSku",
        "Metodo `calculatePrice(PricingPolicy, SellableSku)`: calcola singolo prezzo",
        "Job per scheduled execution",
        "Typecheck e lint passano"
      ],
      "priority": 32,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-033",
      "title": "Setup modello Offer",
      "description": "As an Admin, I want to define Offers as the activation of sellability for Sellable SKUs.",
      "acceptanceCriteria": [
        "Tabella `offers` con: id, uuid, name, sellable_sku_id (FK), channel_id (FK), price_book_id (FK), offer_type (enum), visibility (enum), valid_from (datetime), valid_to (datetime nullable), status (enum), campaign_tag (string nullable)",
        "Soft deletes abilitati",
        "Relazione: Offer belongsTo SellableSku, Channel, PriceBook",
        "Invariante: 1 Offer = 1 Sellable SKU (bundles sono composite SKUs)",
        "Offer non porta price direttamente, risolve via PriceBook",
        "Typecheck e lint passano"
      ],
      "priority": 33,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-034",
      "title": "Setup modello OfferEligibility",
      "description": "As an Admin, I want to define eligibility conditions for an Offer.",
      "acceptanceCriteria": [
        "Tabella `offer_eligibilities` con: id, offer_id (FK), allowed_markets (JSON array), allowed_customer_types (JSON array), allowed_membership_tiers (JSON array nullable), allocation_constraint_id (FK nullable)",
        "Relazione: Offer hasOne OfferEligibility",
        "Eligibility non può override constraints di Module A",
        "allocation_constraint_id referenzia vincolo autoritativo da allocation",
        "Typecheck e lint passano"
      ],
      "priority": 34,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-035",
      "title": "Setup modello OfferBenefit",
      "description": "As an Admin, I want to define benefits applied by an Offer.",
      "acceptanceCriteria": [
        "Tabella `offer_benefits` con: id, offer_id (FK), benefit_type (enum), benefit_value (decimal nullable), discount_rule_id (FK nullable)",
        "Enum `BenefitType`: none, percentage_discount, fixed_discount, fixed_price in app/Enums/Commercial/",
        "Relazione: Offer hasOne OfferBenefit",
        "benefit_type = none significa prezzo da Price Book senza modifiche",
        "discount_rule_id per referenziare regole riutilizzabili",
        "Typecheck e lint passano"
      ],
      "priority": 35,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-036",
      "title": "Offer List in Filament",
      "description": "As an Operator, I want a list of Offers as entry point for sellability management.",
      "acceptanceCriteria": [
        "OfferResource in Filament con navigation group 'Commercial'",
        "Lista con colonne: name, sellable_sku, offer_type, channel, status, valid_from, valid_to, visibility",
        "Filtri: status, offer_type, channel, visibility, validity_period",
        "Ricerca per: name, SKU name, wine name",
        "Indicatore visivo per Offers in scadenza (< 7 giorni)",
        "Bulk actions: Create offers for selected SKUs, Pause, Archive",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 36,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-037",
      "title": "Create Offer wizard - Step 1 (Product)",
      "description": "As an Operator, I want to select the Sellable SKU for a new Offer.",
      "acceptanceCriteria": [
        "Step 1: sellable_sku_id selection con autocomplete",
        "Mostra solo SKU con allocation attiva per almeno un channel",
        "Preview: allocation info, available channels, EMP (se presente)",
        "Warning se SKU non ha EMP",
        "Messaggio: '1 Offer = 1 Sellable SKU'",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 37,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-038",
      "title": "Create Offer wizard - Step 2 (Channel & Eligibility)",
      "description": "As an Operator, I want to define channel and eligibility for the Offer.",
      "acceptanceCriteria": [
        "Step 2: channel_id selection, eligibility fields",
        "Channel: solo channels permessi dall'allocation constraint",
        "Eligibility: allowed_markets (multi-select, constrained by allocation), allowed_customer_types (multi-select)",
        "Warning prominente: 'Eligibility cannot override Allocation constraints'",
        "Preview: allocation constraints applicabili",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 38,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-039",
      "title": "Create Offer wizard - Step 3 (Pricing)",
      "description": "As an Operator, I want to define the pricing of the Offer.",
      "acceptanceCriteria": [
        "Step 3: price_book_id selection, benefit configuration",
        "Price Book: mostra solo PriceBooks active per channel/market selezionato",
        "Preview: base_price da Price Book, EMP comparison",
        "Benefit type: None (use Price Book price), Percentage Discount, Fixed Discount, Fixed Override Price",
        "Se benefit, input value corrispondente",
        "Preview: final price dopo benefit",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 39,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-040",
      "title": "Create Offer wizard - Step 4 (Validity & Visibility)",
      "description": "As an Operator, I want to define validity period and visibility of the Offer.",
      "acceptanceCriteria": [
        "Step 4: name, offer_type, visibility, valid_from, valid_to, campaign_tag",
        "offer_type: standard, promotion (implica discount), bundle",
        "visibility: public, restricted",
        "Validazione: valid_to > valid_from (se presente)",
        "campaign_tag per raggruppamento (optional)",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 40,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-041",
      "title": "Create Offer wizard - Step 5 (Review & Create)",
      "description": "As an Operator, I want to see a summary before creating the Offer.",
      "acceptanceCriteria": [
        "Step 5: summary completo",
        "Preview: SKU, channel, eligibility, pricing, validity",
        "Warning per conflitti con Offers esistenti (stesso SKU, channel, overlapping validity)",
        "Offer creato in status 'draft'",
        "CTA: 'Create as Draft', 'Create and Activate'",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 41,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-042",
      "title": "Offer Detail con 7 tabs",
      "description": "As an Operator, I want to see all details of an Offer.",
      "acceptanceCriteria": [
        "Tab Overview: summary, status, final price computed",
        "Tab Eligibility: markets, customer types, allocation constraints",
        "Tab Benefit: discount/fixed price config, resolved final price",
        "Tab Products: Sellable SKU info, allocation lineage",
        "Tab Priority & Conflicts: conflicting offers, resolution rules",
        "Tab Simulation: price testing per questo Offer",
        "Tab Audit: full traceability",
        "Azioni: Activate, Pause, Cancel",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 42,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-043",
      "title": "Offer status transitions",
      "description": "As an Admin, I want Offer status transitions to follow precise rules.",
      "acceptanceCriteria": [
        "Transizioni valide: draft→active, active→paused, paused→active, active→expired (automatico), any→cancelled",
        "Attivazione verifica: eligibility non viola allocation constraints",
        "Attivazione verifica: Price Book referenced è active",
        "expired settato automaticamente quando now > valid_to",
        "cancelled è terminale (no reactivation)",
        "Ogni transizione logga user_id, timestamp",
        "Typecheck e lint passano"
      ],
      "priority": 43,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-044",
      "title": "Bulk Offer creation",
      "description": "As an Operator, I want to create Offers in bulk for multiple Sellable SKUs.",
      "acceptanceCriteria": [
        "Entry point: Offer List (select SKUs), Allocation detail, Price Book detail",
        "Wizard bulk: select target channel, Price Book, shared eligibility, shared benefit, shared validity",
        "Preview: lista Offers che saranno creati",
        "Ogni SKU genera 1 Offer indipendente",
        "Validation: tutti gli SKU devono avere allocation per channel selezionato",
        "Progress indicator durante creazione",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 44,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-045",
      "title": "OfferService per gestione Offers",
      "description": "As a Developer, I want a service to centralize Offer logic.",
      "acceptanceCriteria": [
        "Service class `OfferService` in `app/Services/Commercial/`",
        "Metodo `activate(Offer)`: draft → active con validazioni",
        "Metodo `pause(Offer)`: active → paused",
        "Metodo `cancel(Offer)`: any → cancelled",
        "Metodo `getActiveForContext(SellableSku, Channel, Customer)`: trova Offer applicabile",
        "Metodo `resolvePrice(Offer)`: calcola final price (base + benefit)",
        "Metodo `validateEligibility(Offer, Customer)`: verifica customer eligibility",
        "Job per auto-expire Offers scaduti",
        "Typecheck e lint passano"
      ],
      "priority": 45,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-046",
      "title": "Setup modello DiscountRule",
      "description": "As an Admin, I want to define reusable discount rules.",
      "acceptanceCriteria": [
        "Tabella `discount_rules` con: id, uuid, name, rule_type (enum), logic_definition (JSON), status (enum: active, inactive)",
        "Enum `DiscountRuleType`: percentage, fixed_amount, tiered, volume_based in app/Enums/Commercial/",
        "Enum `DiscountRuleStatus`: active, inactive in app/Enums/Commercial/",
        "logic_definition contiene: value, tiers (per tiered), thresholds (per volume)",
        "DiscountRules sono definitions, non si applicano da sole",
        "Typecheck e lint passano"
      ],
      "priority": 46,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-047",
      "title": "DiscountRule List in Filament",
      "description": "As an Operator, I want a list of reusable discount rules.",
      "acceptanceCriteria": [
        "DiscountRuleResource in Filament sotto Commercial > Discounts & Rules",
        "Lista con colonne: name, rule_type, summary (plain-language), status, offers_using_count",
        "Filtri: rule_type, status",
        "Ricerca per: name",
        "Lightweight UI (advanced users)",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 47,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-048",
      "title": "DiscountRule CRUD",
      "description": "As an Operator, I want to create and modify discount rules.",
      "acceptanceCriteria": [
        "Create: name, rule_type, logic builder",
        "Logic builder dinamico per tipo: percentage (value), fixed_amount (value), tiered (tiers array), volume_based (thresholds)",
        "Preview: plain-language explanation ('15% off', '€10 off when qty >= 6')",
        "Edit: solo se nessun Offer active la sta usando",
        "Delete: solo se non referenziata da alcun Offer",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 48,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-049",
      "title": "Setup modello Bundle",
      "description": "As an Admin, I want to define Bundles as commercial groupings of Sellable SKUs.",
      "acceptanceCriteria": [
        "Tabella `bundles` con: id, uuid, name, bundle_sku (string unique), pricing_logic (enum), fixed_price (decimal nullable), status (enum: draft, active, inactive)",
        "Enum `BundlePricingLogic`: sum_components, fixed_price, percentage_off_sum in app/Enums/Commercial/",
        "Enum `BundleStatus`: draft, active, inactive in app/Enums/Commercial/",
        "Bundle genera un Sellable SKU composito in PIM (reference)",
        "Typecheck e lint passano"
      ],
      "priority": 49,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-050",
      "title": "Setup modello BundleComponent",
      "description": "As an Admin, I want to define the components of a Bundle.",
      "acceptanceCriteria": [
        "Tabella `bundle_components` con: id, bundle_id (FK), sellable_sku_id (FK), quantity (int default 1)",
        "Relazione: Bundle hasMany BundleComponent, BundleComponent belongsTo SellableSku",
        "Validazione: quantity > 0",
        "Componenti sono Sellable SKUs (non Bottle SKUs)",
        "Typecheck e lint passano"
      ],
      "priority": 50,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-051",
      "title": "Bundle List in Filament",
      "description": "As an Operator, I want a list of commercial Bundles.",
      "acceptanceCriteria": [
        "BundleResource in Filament sotto Commercial > Bundles",
        "Lista con colonne: name, bundle_sku, pricing_logic, components_count, status, computed_price",
        "Filtri: status, pricing_logic",
        "Ricerca per: name, bundle_sku",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 51,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-052",
      "title": "Bundle CRUD con component management",
      "description": "As an Operator, I want to create and modify Bundles with their components.",
      "acceptanceCriteria": [
        "Create wizard: name, bundle_sku (auto-generated o manual), pricing_logic",
        "Component selection: add Sellable SKUs con quantity",
        "Pricing: sum_components (auto), fixed_price (input), percentage_off_sum (input %)",
        "Preview: computed price, component list",
        "Edit: components editabili solo se status = draft",
        "Activation: genera/aggiorna Sellable SKU composito in PIM",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 52,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-053",
      "title": "BundleService per gestione Bundles",
      "description": "As a Developer, I want a service to centralize Bundle logic.",
      "acceptanceCriteria": [
        "Service class `BundleService` in `app/Services/Commercial/`",
        "Metodo `activate(Bundle)`: draft → active, sincronizza con PIM",
        "Metodo `calculatePrice(Bundle, PriceBook)`: calcola prezzo basato su logic",
        "Metodo `validateComponents(Bundle)`: verifica tutti i componenti hanno allocation",
        "Metodo `getComponentsPrice(Bundle, PriceBook)`: somma prezzi componenti",
        "Typecheck e lint passano"
      ],
      "priority": 53,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-054",
      "title": "Price Simulation page",
      "description": "As an Operator, I want to simulate end-to-end price resolution for debugging.",
      "acceptanceCriteria": [
        "Pagina Simulation in Filament sotto Commercial",
        "Inputs: sellable_sku_id, customer_id (optional), channel_id, date, quantity",
        "Auto-suggest per tutti i campi",
        "CTA: 'Simulate'",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 54,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-055",
      "title": "Simulation results display",
      "description": "As an Operator, I want to see simulation results with full breakdown.",
      "acceptanceCriteria": [
        "Output section con breakdown steps:",
        "1. Allocation Check: allocation lineage, constraints, availability",
        "2. EMP Reference: EMP value (se disponibile)",
        "3. Price Book Resolution: quale Price Book applicato, base_price",
        "4. Offer Resolution: quale Offer applicato, benefit applied",
        "5. Final Price: prezzo finale con explanation",
        "Se blocco (no allocation, no offer), mostra errore specifico",
        "Highlight per ogni step: source, rationale",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 55,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-056",
      "title": "SimulationService per calcoli",
      "description": "As a Developer, I want a service to perform pricing simulation.",
      "acceptanceCriteria": [
        "Service class `SimulationService` in `app/Services/Commercial/`",
        "Metodo `simulate(SellableSku, ?Customer, Channel, date, quantity)`: restituisce SimulationResult",
        "SimulationResult contiene: allocation_check, emp_reference, price_book_resolution, offer_resolution, final_price, errors",
        "Integrazione con AllocationService per check disponibilità",
        "Integrazione con OfferService per risoluzione offer",
        "Typecheck e lint passano"
      ],
      "priority": 56,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-057",
      "title": "Commercial Overview dashboard",
      "description": "As an Operator, I want a dashboard as control panel for all commercial activities.",
      "acceptanceCriteria": [
        "Pagina Overview come landing page di Commercial",
        "Widget: Active Price Books count by status",
        "Widget: Active Offers count by status",
        "Widget: Pricing Policies with last execution status",
        "Widget: EMP Coverage (% SKU con EMP)",
        "Widget: Alerts (expiring offers, price deviations, policy failures)",
        "Links rapidi: Create Price Book, Create Offer, Create Policy",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 57,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-058",
      "title": "Commercial Calendar view",
      "description": "As an Operator, I want a calendar view of commercial activities.",
      "acceptanceCriteria": [
        "Calendar component in Commercial Overview",
        "Eventi: Price Book validity periods (colored bars), Offer validity periods, Pricing Policy scheduled executions",
        "Filtri: tipo evento, channel",
        "Click su evento apre detail",
        "Vista: mese, settimana",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 58,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-059",
      "title": "Upcoming expirations widget",
      "description": "As an Operator, I want to see commercial elements about to expire.",
      "acceptanceCriteria": [
        "Widget in Overview: Upcoming Expirations",
        "Lista: Offers expiring in 7 days, Price Books expiring in 30 days",
        "Ordinato per data scadenza",
        "Link a detail per ogni item",
        "Badge urgenza per < 3 giorni",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 59,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-060",
      "title": "Audit log per entita Commercial",
      "description": "As a Compliance Officer, I want an immutable log for all changes to commercial entities.",
      "acceptanceCriteria": [
        "Trait Auditable applicato a: Channel, PriceBook, PriceBookEntry, PricingPolicy, Offer, OfferEligibility, OfferBenefit, DiscountRule, Bundle",
        "Eventi loggati: creation, update, status_change, activation, expiration",
        "Ogni entità ha Tab Audit in detail view",
        "Audit logs immutabili",
        "Typecheck e lint passano"
      ],
      "priority": 60,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-061",
      "title": "Global Commercial Audit page",
      "description": "As a Compliance Officer, I want a global view of all commercial audit events.",
      "acceptanceCriteria": [
        "Pagina Audit in Filament sotto Commercial",
        "Lista unificata tutti gli audit events di Commercial",
        "Filtri: entity_type, event_type, date_range, user",
        "Ricerca per: entity_id, user_name",
        "Export CSV per compliance",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 61,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-062",
      "title": "Pricing Policy execution history",
      "description": "As an Operator, I want to see complete execution history for Pricing Policies.",
      "acceptanceCriteria": [
        "Tab Execution History in Pricing Policy Detail",
        "Lista esecuzioni: date, type (manual/scheduled/dry_run), skus_processed, prices_generated, errors, status",
        "Expand per vedere log_summary",
        "Link a Price Book target per vedere prices generated",
        "Typecheck e lint passano",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 62,
      "passes": false,
      "notes": ""
    }
  ]
}
