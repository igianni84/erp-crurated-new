{
  "project": "Crurated ERP",
  "branchName": "ralph/ai-assistant",
  "description": "AI Assistant — Natural Language ERP Intelligence with tool-calling architecture, 25 tools across 8 modules, streaming chat UI",
  "userStories": [
    {
      "id": "US-001",
      "title": "Install Laravel AI SDK and verify contracts",
      "description": "As a Developer, I want the Laravel AI SDK installed and configured so that the application can communicate with the Anthropic API.",
      "acceptanceCriteria": [
        "Update composer.json PHP requirement from ^8.2 to ^8.4",
        "Install laravel/ai:0.1.5 via Composer with exact version pin",
        "Publish SDK config: php artisan vendor:publish --provider=\"Laravel\\Ai\\AiServiceProvider\"",
        "Run SDK migrations: php artisan migrate",
        "Add ANTHROPIC_API_KEY to .env.example with placeholder value",
        "Configure config/ai.php with Anthropic as default provider, model claude-sonnet-4-5-20250929",
        "Create tests/Feature/AI/SdkSmokeTest.php that verifies all SDK contracts exist: Laravel\\Ai\\Contracts\\{Agent, Conversational, HasTools, Tool}, Laravel\\Ai\\Attributes\\{MaxSteps, Model, Provider, Temperature}, Laravel\\Ai\\Enums\\Lab, Laravel\\Ai\\Concerns\\RemembersConversations, Laravel\\Ai\\Promptable, Laravel\\Ai\\Tools\\Request, Illuminate\\Contracts\\JsonSchema\\JsonSchema",
        "Smoke test also verifies JsonSchema type builders support .enum() and .default() methods",
        "Smoke test verifies Tool::description() and Tool::handle() return Stringable|string",
        "Smoke test verifies AgentResponse->usage structure (input_tokens, output_tokens field names)",
        "Record exact SDK migration table names in a comment in the test file for reference",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "PRD ref: US-AI001. This is the foundation — all subsequent stories depend on it. If any SDK contract namespace differs, update all subsequent user stories before proceeding. If .enum()/.default() don't exist, all 25 tool schemas need redesign."
    },
    {
      "id": "US-002",
      "title": "Create AI Assistant configuration file",
      "description": "As a Developer, I want a dedicated configuration file for the AI Assistant to centralize all tunable parameters.",
      "acceptanceCriteria": [
        "Create config/ai-assistant.php with: model (claude-sonnet-4-5-20250929), max_steps (10), temperature (0.3), max_input_length (2000), max_context_messages (30)",
        "Add rate_limit section: requests_per_hour (60), requests_per_day (500)",
        "Add cost_tracking section: input_token_price (0.003 USD per 1K tokens from env), output_token_price (0.015 USD per 1K tokens from env)",
        "Config comments document unit as 'USD per 1K tokens' and the cost formula",
        "All values sourced from env() with sensible defaults",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "PRD ref: US-AI002. Verify current Anthropic pricing at implementation time."
    },
    {
      "id": "US-003",
      "title": "Create AI Audit Log migration and model",
      "description": "As a Developer, I want an immutable audit log model for tracking all AI interactions for compliance and cost analysis.",
      "acceptanceCriteria": [
        "Create migration 2026_02_15_500001_create_ai_audit_logs_table.php with columns: id (UUID PK), user_id (FK to users), conversation_id (nullable, string type), message_text (text), tools_invoked (JSON), tokens_input (unsigned int nullable), tokens_output (unsigned int nullable), estimated_cost_eur (decimal 8,6 nullable), duration_ms (unsigned int nullable), error (text nullable), metadata (JSON nullable), created_at (timestamp)",
        "NO updated_at, NO deleted_at — immutable records",
        "Add index on (user_id, created_at) for rate limiting",
        "Create model App\\Models\\AI\\AiAuditLog with HasUuid trait",
        "Model boot guard prevents update and delete (same pattern as existing AuditLog model)",
        "$timestamps = false with manual created_at setting",
        "Migration runs successfully: php artisan migrate",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "PRD ref: US-AI006. Module AI uses migration numbering 500000+. Check existing AuditLog model for boot guard pattern."
    },
    {
      "id": "US-004",
      "title": "Create ToolAccessLevel enum and BaseTool abstract class",
      "description": "As a Developer, I want an abstract base class for all AI Tools that handles authorization, error handling, and response formatting.",
      "acceptanceCriteria": [
        "Create App\\Enums\\AI\\ToolAccessLevel enum with cases: Overview (10), Basic (20), Standard (40), Full (60)",
        "ToolAccessLevel has label(), color(), icon() methods following project enum convention",
        "ToolAccessLevel has static forRole(UserRole $role): self mapping: Viewer→Overview, Editor→Basic, Manager→Standard, Admin/SuperAdmin→Full",
        "Create abstract class App\\AI\\Tools\\BaseTool with abstract requiredAccessLevel(): ToolAccessLevel",
        "BaseTool has authorizeForUser(User $user): bool checking ToolAccessLevel::forRole($user->role) >= requiredAccessLevel()",
        "BaseTool has formatCurrency(string $amount, string $currency = 'EUR'): string using bcmath",
        "BaseTool has formatDate(Carbon $date): string for consistent formatting",
        "BaseTool has parsePeriod(string $period): array returning [Carbon $from, Carbon $to] for: this_month, last_month, this_week, this_quarter, this_year, today, last_7_days, last_30_days",
        "BaseTool has safeHandle(Request $request): string wrapping handle() in try/catch, with ModelNotFoundException and generic Throwable handling",
        "BaseTool has disambiguateResults(Collection $results, string $searchTerm, string $displayField): ?string — returns null on 1 match, list on >1, 'not found' on 0",
        "BaseTool has scopeQuery(Illuminate\\Database\\Eloquent\\Builder $query, User $user): Builder — default returns $query unchanged (v2 hook)",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "PRD ref: US-AI010, US-AI121. ToolAccessLevel numeric values (10/20/40/60) are intentionally different from UserRole::level() values (20/40/60/80/100). Check existing UserRole enum for the level() method."
    },
    {
      "id": "US-005",
      "title": "Create system prompt file",
      "description": "As a Developer, I want a comprehensive system prompt that gives the AI model context about the Crurated ERP domain.",
      "acceptanceCriteria": [
        "Create file app/AI/Prompts/erp-system-prompt.md",
        "Contains role definition: read-only analytics tool for fine wine trading platform",
        "Contains module overview: brief description of PIM, Customers, Commercial, Allocations, Procurement, Inventory, Fulfillment, Finance",
        "Contains key domain concepts: voucher (1=1 bottle), allocation, shipping order vs shipment, all 5 invoice types (INV0-INV4) with labels",
        "Contains response guidelines: tables for tabular data, EUR symbol, bottle counts by default",
        "Contains tool usage hints: which tool for which question type",
        "Contains language instruction: respond in same language as user (Italian or English)",
        "Prompt is under 4000 tokens",
        "No hallucination-prone statements",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "PRD ref: US-AI004. Keep concise — this is sent with every request."
    },
    {
      "id": "US-006",
      "title": "Create ErpAssistantAgent class",
      "description": "As a Developer, I want the main Agent class that orchestrates the AI Assistant, loading the system prompt and registering all available tools.",
      "acceptanceCriteria": [
        "Create App\\AI\\Agents\\ErpAssistantAgent implementing Agent, Conversational, HasTools",
        "Uses Promptable and RemembersConversations traits from SDK",
        "Has attributes: #[Provider(Lab::Anthropic)], #[Model('claude-sonnet-4-5-20250929')], #[MaxSteps(10)], #[Temperature(0.3)]",
        "instructions() method loads system prompt from app/AI/Prompts/erp-system-prompt.md",
        "tools() method returns all registered Tool instances (empty array for now — tools added in subsequent stories)",
        "Agent is instantiated with authenticated User for role-based filtering in tools()",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "PRD ref: US-AI003. Tools will be registered incrementally as they are built."
    },
    {
      "id": "US-007",
      "title": "Implement rate limiting service",
      "description": "As an Admin, I want rate limiting on AI queries to control costs and prevent abuse.",
      "acceptanceCriteria": [
        "Rate limiting checked before each agent prompt execution",
        "Limits read from config/ai-assistant.php: requests_per_hour (60), requests_per_day (500)",
        "Primary: Cache::increment('ai_rate:{userId}:hour:{hourKey}') with TTL 3600s for hourly, Cache::increment('ai_rate:{userId}:day:{dayKey}') with TTL 86400s for daily",
        "Fallback: if cache unavailable, COUNT on ai_audit_logs with index (user_id, created_at)",
        "If limit exceeded: return message with remaining queries and time window",
        "super_admin role exempt from rate limiting",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "PRD ref: US-AI005. Cache-first approach for O(1) performance on hot path."
    },
    {
      "id": "US-008",
      "title": "Tool — Top Customers by Revenue",
      "description": "As a Manager, I want to see the top customers ranked by revenue for a given period.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Customer\\TopCustomersByRevenueTool implements Tool",
        "Schema: period (string, enum of period values, default this_month), limit (integer, default 10, min 1, max 50)",
        "Query: Invoice WHERE status in [Issued, PartiallyPaid, Paid] within period, SUM total_amount GROUP BY customer_id, ORDER BY total DESC, LIMIT",
        "Returns: customer_name (via $customer->getName()), email, total_revenue (formatted EUR), invoice_count, membership_tier",
        "Uses bcadd() for summing amounts",
        "Requires ToolAccessLevel::Standard",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "PRD ref: US-AI011. Use enum instances in whereIn, not raw strings. Customer name via getName() method."
    },
    {
      "id": "US-009",
      "title": "Tool — Customer Search",
      "description": "As an Operator, I want to search for a customer by name or email.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Customer\\CustomerSearchTool implements Tool",
        "Schema: query (string, required, min 2)",
        "Search on Customer with party relationship, across Customer.name AND Party.legal_name AND email via LIKE",
        "Eager load activeMembership, withCount vouchers and shippingOrders",
        "Returns max 10: customer_name (via getName()), email, status label, customer_type label, membership_tier, voucher_count, shipping_order_count",
        "Requires ToolAccessLevel::Basic",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "PRD ref: US-AI012."
    },
    {
      "id": "US-010",
      "title": "Tool — Customer Status Summary",
      "description": "As a Manager, I want a summary of customers by status and type.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Customer\\CustomerStatusSummaryTool implements Tool",
        "No required parameters",
        "Query: Customer COUNT GROUP BY status (CustomerStatus enum) and GROUP BY customer_type (CustomerType enum)",
        "Returns: total_customers, by_status, by_type, with_active_blocks count",
        "Requires ToolAccessLevel::Overview",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "PRD ref: US-AI013."
    },
    {
      "id": "US-011",
      "title": "Tool — Customer Voucher Count",
      "description": "As an Operator, I want to know how many vouchers a specific customer has, grouped by lifecycle state.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Customer\\CustomerVoucherCountTool implements Tool",
        "Schema: customer_id (string UUID optional), customer_name (string optional — fuzzy search)",
        "If customer_id: direct lookup. If customer_name: LIKE search on Customer.name AND Party.legal_name",
        "Name disambiguation: >1 match uses BaseTool::disambiguateResults(), 0 matches returns not found, 1 match proceeds",
        "Returns: customer_name (via getName()), total_vouchers, by_state (issued, locked, redeemed, cancelled) from VoucherLifecycleState enum",
        "Requires ToolAccessLevel::Basic",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "PRD ref: US-AI014."
    },
    {
      "id": "US-012",
      "title": "Tool — Revenue Summary",
      "description": "As a Manager, I want a revenue summary for a given period, optionally grouped by invoice type.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Finance\\RevenueSummaryTool implements Tool",
        "Schema: period (string default this_month), group_by (string optional: invoice_type, currency, none, default invoice_type)",
        "Query: Invoice WHERE status in [Issued, PartiallyPaid, Paid] AND issued_at within period, SUM total_amount, SUM tax_amount, SUM amount_paid",
        "If grouped by invoice_type: breakdown by INV0-INV4 using InvoiceType enum labels",
        "Returns: period_label, gross_revenue, tax_total, net_revenue, amount_collected, outstanding, breakdown",
        "All amounts formatted with bcmath and EUR symbol",
        "Requires ToolAccessLevel::Standard",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "PRD ref: US-AI020."
    },
    {
      "id": "US-013",
      "title": "Tool — Outstanding Invoices",
      "description": "As a Manager, I want to see all invoices with outstanding balances.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Finance\\OutstandingInvoicesTool implements Tool",
        "Schema: min_amount (numeric optional), invoice_type (string optional, enum of InvoiceType values), limit (integer default 20)",
        "Query: Invoice WHERE status in [Issued, PartiallyPaid] with customer, ordered by outstanding amount DESC",
        "Returns: total_outstanding_amount, invoice_count, invoices list with invoice_number, customer_name, invoice_type label, total_amount, amount_paid, outstanding, issued_at, due_date, is_overdue",
        "Requires ToolAccessLevel::Standard",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "PRD ref: US-AI021."
    },
    {
      "id": "US-014",
      "title": "Tool — Overdue Invoices",
      "description": "As a Manager, I want to identify overdue invoices to prioritize collection.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Finance\\OverdueInvoicesTool implements Tool",
        "Schema: days_overdue_min (integer optional default 0), limit (integer default 20)",
        "Query: Invoice WHERE status = Issued AND due_date < today, with customer, ORDER BY days overdue DESC",
        "Returns: total_overdue_count, total_overdue_amount, invoices list with days_overdue",
        "Requires ToolAccessLevel::Standard",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "PRD ref: US-AI022."
    },
    {
      "id": "US-015",
      "title": "Tool — Payment Reconciliation Status",
      "description": "As a Finance Admin, I want to see payment reconciliation status.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Finance\\PaymentReconciliationStatusTool implements Tool",
        "Schema: status (string optional, values from ReconciliationStatus enum)",
        "Query: Payment COUNT GROUP BY reconciliation_status, for mismatched include detail with customer",
        "Returns: total_payments, by_reconciliation_status, mismatched_details if filtered",
        "Requires ToolAccessLevel::Full",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "PRD ref: US-AI023."
    },
    {
      "id": "US-016",
      "title": "Tool — Credit Note Summary",
      "description": "As a Finance Admin, I want a summary of credit notes.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Finance\\CreditNoteSummaryTool implements Tool",
        "Schema: period (string default this_month), status (string optional from CreditNoteStatus enum)",
        "Query: CreditNote within period, COUNT and SUM amount GROUP BY status",
        "Returns: total_credit_notes, total_amount, by_status with count and amount",
        "Requires ToolAccessLevel::Full",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": "PRD ref: US-AI024."
    },
    {
      "id": "US-017",
      "title": "Tool — Allocation Status Overview",
      "description": "As a Manager, I want an overview of allocations by status.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Allocation\\AllocationStatusOverviewTool implements Tool",
        "No required parameters",
        "Query: Allocation COUNT GROUP BY status (AllocationStatus enum: draft, active, exhausted, closed). For active: SUM total_quantity, SUM sold_quantity, compute remaining",
        "Returns: total_allocations, by_status, active_summary with utilization_percentage",
        "Requires ToolAccessLevel::Basic",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": "PRD ref: US-AI030."
    },
    {
      "id": "US-018",
      "title": "Tool — Voucher Counts by State",
      "description": "As a Manager, I want voucher distribution across lifecycle states.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Allocation\\VoucherCountsByStateTool implements Tool",
        "Schema: customer_id (string UUID optional)",
        "Query: Voucher COUNT GROUP BY lifecycle_state (VoucherLifecycleState enum)",
        "Returns: total_vouchers, by_state (issued, locked, redeemed, cancelled), active_vouchers (issued+locked)",
        "Requires ToolAccessLevel::Basic",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": true,
      "notes": "PRD ref: US-AI031."
    },
    {
      "id": "US-019",
      "title": "Tool — Bottles Sold by Producer",
      "description": "As a Manager, I want to know how many bottles of a specific producer have been sold.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Allocation\\BottlesSoldByProducerTool implements Tool",
        "Schema: producer_name (string optional), period (string default this_year), limit (integer default 10)",
        "Join chain: Voucher.allocation_id → Allocation.wine_variant_id → WineVariant.wine_master_id → WineMaster.producer_id → Producer.name",
        "Eager load: allocation.wineVariant.wineMaster.producerRelation",
        "If producer_name: LIKE search on Producer.name with disambiguation via BaseTool::disambiguateResults()",
        "If producer_name matched: also show breakdown by wine name (WineMaster.name)",
        "Returns: producers list with producer_name, bottles_sold, top_wines",
        "Requires ToolAccessLevel::Standard",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": true,
      "notes": "PRD ref: US-AI032. Verify exact relationship names on WineMaster model (producerRelation, not producer)."
    },
    {
      "id": "US-020",
      "title": "Tool — Stock Levels by Location",
      "description": "As a Manager, I want current stock levels per warehouse location.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Inventory\\StockLevelsByLocationTool implements Tool",
        "Schema: location_id (string UUID optional), state (string optional from BottleState enum, default stored)",
        "Query: SerializedBottle COUNT GROUP BY current_location_id, with currentLocation, filtered by state",
        "Returns: total_bottles, by_location list with location_name, location_type label, country, bottle_count",
        "Requires ToolAccessLevel::Basic",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": true,
      "notes": "PRD ref: US-AI040."
    },
    {
      "id": "US-021",
      "title": "Tool — Total Bottles Count",
      "description": "As an Operator, I want a quick count of total bottles in inventory with breakdown by state.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Inventory\\TotalBottlesCountTool implements Tool",
        "No required parameters",
        "Query: SerializedBottle COUNT total, COUNT GROUP BY state (BottleState enum — all 7 values), COUNT GROUP BY ownership_type (OwnershipType enum — note: enum case is CururatedOwned with typo, string value is crurated_owned)",
        "Returns: total_bottles, by_state, by_ownership",
        "Requires ToolAccessLevel::Overview",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": true,
      "notes": "PRD ref: US-AI041. Note the OwnershipType::CururatedOwned typo — use the enum case, not the string."
    },
    {
      "id": "US-022",
      "title": "Tool — Case Integrity Status",
      "description": "As a Manager, I want case integrity status (intact vs broken).",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Inventory\\CaseIntegrityStatusTool implements Tool",
        "No required parameters",
        "Query: InventoryCase (table 'cases') COUNT GROUP BY integrity_status (CaseIntegrityStatus enum: intact, broken)",
        "Returns: total_cases, intact_count, broken_count, intact_percentage",
        "Requires ToolAccessLevel::Basic",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": true,
      "notes": "PRD ref: US-AI042."
    },
    {
      "id": "US-023",
      "title": "Tool — Pending Shipping Orders",
      "description": "As a Manager, I want active shipping orders to monitor fulfillment.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Fulfillment\\PendingShippingOrdersTool implements Tool",
        "Schema: status (string optional, non-terminal ShippingOrderStatus values), limit (integer default 20)",
        "Query: ShippingOrder WHERE status is non-terminal (exclude completed and cancelled), with customer, COUNT lines per SO",
        "Returns: total_pending, by_status, orders list with customer_name, status label, line_count, created_at, requested_ship_date",
        "Requires ToolAccessLevel::Basic",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 23,
      "passes": true,
      "notes": "PRD ref: US-AI050. Use ShippingOrderStatus::isTerminal() to identify terminal states."
    },
    {
      "id": "US-024",
      "title": "Tool — Shipment Status",
      "description": "As an Operator, I want to check shipment status by tracking number or see overview.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Fulfillment\\ShipmentStatusTool implements Tool",
        "Schema: tracking_number (string optional), status (string optional from ShipmentStatus enum), period (string default last_7_days)",
        "If tracking_number: direct lookup. Otherwise: query Shipment filtered by status/period with shippingOrder->customer",
        "Returns: single detail or list with tracking_number, status label, carrier, customer_name, shipped_at, delivered_at, shipping_order_reference",
        "Requires ToolAccessLevel::Basic",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 24,
      "passes": true,
      "notes": "PRD ref: US-AI051."
    },
    {
      "id": "US-025",
      "title": "Tool — Shipments In Transit",
      "description": "As a Manager, I want to know how many shipments are currently in transit.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Fulfillment\\ShipmentsInTransitTool implements Tool",
        "No required parameters",
        "Query: Shipment WHERE status in [Preparing, Shipped, InTransit] — the 3 non-terminal states, with shippingOrder->customer",
        "Returns: count_in_transit, shipments list with tracking_number, customer_name, carrier, shipped_at, days_since_dispatch",
        "Requires ToolAccessLevel::Overview",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 25,
      "passes": true,
      "notes": "PRD ref: US-AI052. Use ShipmentStatus::isTerminal() to identify non-terminal states."
    },
    {
      "id": "US-026",
      "title": "Tool — Pending Purchase Orders",
      "description": "As a Manager, I want the list of open purchase orders for procurement monitoring.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Procurement\\PendingPurchaseOrdersTool implements Tool",
        "Schema: status (string optional: draft, sent, confirmed), limit (integer default 20)",
        "Query: PurchaseOrder WHERE status is non-terminal (terminal = Closed), with procurementIntent and supplier, ORDER BY created_at DESC",
        "Returns: total_pending, orders list with id (UUID — no dedicated reference field), status label, supplier_name, quantity, unit_cost, currency, expected_delivery_start",
        "Requires ToolAccessLevel::Standard",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 26,
      "passes": true,
      "notes": "PRD ref: US-AI060. PurchaseOrder has no reference field — use UUID id."
    },
    {
      "id": "US-027",
      "title": "Tool — Inbound Schedule",
      "description": "As a Manager, I want to see expected inbound deliveries for logistics planning.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Procurement\\InboundScheduleTool implements Tool",
        "Schema: days_ahead (integer default 30, max 90), include_draft (boolean default false)",
        "Query: PurchaseOrder WHERE status in [sent, confirmed] (+ draft if include_draft), AND expected_delivery_start between now and now+days_ahead, with inbounds, supplier, procurementIntent, ORDER BY expected_delivery_start ASC",
        "Returns: total_expected, purchase_orders list with expected dates, supplier_name, quantity, unit_cost, currency, status label, inbound_count",
        "Tool description clearly states: 'Check expected inbound deliveries and incoming stock schedule'",
        "Requires ToolAccessLevel::Standard",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 27,
      "passes": true,
      "notes": "PRD ref: US-AI061 (absorbs US-AI043). Expected delivery dates live on PurchaseOrder, not Inbound."
    },
    {
      "id": "US-028",
      "title": "Tool — Procurement Intents Status",
      "description": "As a Manager, I want procurement intents distribution by status.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Procurement\\ProcurementIntentsStatusTool implements Tool",
        "No required parameters",
        "Query: ProcurementIntent COUNT GROUP BY status (ProcurementIntentStatus enum)",
        "Also count intents without associated PurchaseOrder (orphaned demand)",
        "Returns: total_intents, by_status, without_purchase_order count",
        "Requires ToolAccessLevel::Standard",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 28,
      "passes": true,
      "notes": "PRD ref: US-AI062."
    },
    {
      "id": "US-029",
      "title": "Tool — Active Offers",
      "description": "As a Manager, I want the list of currently active offers.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Commercial\\ActiveOffersTool implements Tool",
        "Schema: channel_id (string UUID optional), limit (integer default 20)",
        "Query: Offer WHERE status = active, with sellableSku->wineVariant->wineMaster, channel, priceBook",
        "Returns: total_active, offers list with name (field is 'name', not 'offer_name'), wine_name, channel_name, offer_type label, valid_from, valid_to, visibility label",
        "Requires ToolAccessLevel::Basic",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 29,
      "passes": true,
      "notes": "PRD ref: US-AI070. Offer model uses 'name' field, not 'offer_name'."
    },
    {
      "id": "US-030",
      "title": "Tool — Price Book Coverage",
      "description": "As a Manager, I want to know price book coverage vs total active SKUs.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Commercial\\PriceBookCoverageTool implements Tool",
        "Schema: price_book_id (string UUID optional)",
        "Query: PriceBookEntry COUNT per price_book_id, compared to total active SellableSku count",
        "Returns: price_books list with name, status label, total_entries, total_active_skus, coverage_percentage, missing_count",
        "Requires ToolAccessLevel::Standard",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 30,
      "passes": true,
      "notes": "PRD ref: US-AI071."
    },
    {
      "id": "US-031",
      "title": "Tool — EMP Alerts",
      "description": "As a Manager, I want to identify products priced significantly above or below market price.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Commercial\\EmpAlertsTool implements Tool",
        "Schema: threshold_percent (float default 20.0, min 5.0, max 100.0)",
        "Query: EstimatedMarketPrice JOIN PriceBookEntry via shared sellable_sku_id (no direct FK), calculate deviation using $emp->emp_value (NOT market_price)",
        "Returns: alerts list with wine_name, our_price, market_price (from emp_value), deviation_percent, direction (above/below), confidence_level label, price_book_name",
        "Requires ToolAccessLevel::Standard",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 31,
      "passes": true,
      "notes": "PRD ref: US-AI072. EMP field is emp_value, not market_price. No direct FK between EMP and PriceBookEntry — join through sellable_sku_id."
    },
    {
      "id": "US-032",
      "title": "Tool — Product Catalog Search",
      "description": "As an Operator, I want to search the product catalog by name, producer, or appellation.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Pim\\ProductCatalogSearchTool implements Tool",
        "Schema: query (string required min 2), type (string optional: wine_master, sellable_sku, all, default all)",
        "LIKE search on WineMaster (name, producer, appellation) or SellableSku (sku_code) with variant info",
        "Returns max 20 results: name, producer, appellation, vintage, format, sku_code, lifecycle_status",
        "Requires ToolAccessLevel::Overview",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 32,
      "passes": true,
      "notes": "PRD ref: US-AI080."
    },
    {
      "id": "US-033",
      "title": "Tool — PIM Data Quality Issues",
      "description": "As an Admin, I want to identify data quality issues in the PIM.",
      "acceptanceCriteria": [
        "Create App\\AI\\Tools\\Pim\\DataQualityIssuesTool implements Tool",
        "No required parameters",
        "Queries: WineMaster without WineVariants, WineVariant without SellableSku, SellableSku without CaseConfiguration, WineMaster with null producer_id/country_id/region_id",
        "Returns: issues list with type, severity (high/medium/low), count, sample_names (first 10)",
        "Requires ToolAccessLevel::Standard",
        "Register tool in ErpAssistantAgent::tools()",
        "Typecheck passes"
      ],
      "priority": 33,
      "passes": true,
      "notes": "PRD ref: US-AI081."
    },
    {
      "id": "US-034",
      "title": "Create Filament AI Assistant page",
      "description": "As an Operator, I want to access the AI Assistant through a dedicated page in the Filament panel.",
      "acceptanceCriteria": [
        "Create App\\Filament\\Pages\\AiAssistant extends Filament\\Pages\\Page",
        "Set protected ?string $maxContentWidth = 'full' (string type, not enum)",
        "Navigation: icon heroicon-o-chat-bubble-left-right, group System, sort 99",
        "View: protected static string $view = 'filament.pages.ai-assistant'",
        "Create resources/views/filament/pages/ai-assistant.blade.php with basic placeholder layout",
        "Page auto-discovered by discoverPages() in AdminPanelProvider",
        "Page visible only to authenticated users",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 34,
      "passes": true,
      "notes": "PRD ref: US-AI100. This creates the page shell — chat interface comes next."
    },
    {
      "id": "US-035",
      "title": "Build chat interface with input and messages",
      "description": "As an Operator, I want a chat interface with a message area and input field.",
      "acceptanceCriteria": [
        "Update ai-assistant.blade.php with two-column layout: left sidebar (280px) + main chat area",
        "Chat area has header, scrollable message area, fixed input at bottom",
        "User messages right-aligned bg-primary-50, AI messages left-aligned bg-white",
        "Auto-expanding textarea with placeholder 'Ask anything about Crurated ERP...'",
        "Submit with Enter (Shift+Enter for newline), send button with heroicon-o-paper-airplane",
        "Send button disabled during send",
        "Design consistent with ERP density: p-4, gap-3, fi-section rounded-xl",
        "Dark mode support: dark:bg-gray-900 dark:ring-white/10",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 35,
      "passes": true,
      "notes": "PRD ref: US-AI101. Built as Alpine.js component, NOT Livewire."
    },
    {
      "id": "US-036",
      "title": "Implement SSE streaming endpoint and controller",
      "description": "As a Developer, I want the backend streaming endpoint for AI chat via Server-Sent Events.",
      "acceptanceCriteria": [
        "Create App\\Http\\Controllers\\AI\\ChatController with stream() method",
        "Register POST /admin/ai/chat route in routes/web.php with middleware ['web', 'auth']",
        "Controller calls set_time_limit(120) as safety net",
        "Input validation: max 2000 chars, not empty, HTML stripped (US-AI123)",
        "Rate limiting check before agent execution (US-AI005)",
        "Agent uses ->stream() method from SDK for incremental SSE responses",
        "Audit log created after each interaction with user_id, conversation_id, message_text, tools_invoked, tokens, estimated_cost, duration_ms",
        "High token usage warning in metadata if tokens_input > 100K",
        "Error responses: 429 for rate limit, 422 for validation, 500 for server error",
        "Typecheck passes"
      ],
      "priority": 36,
      "passes": true,
      "notes": "PRD ref: US-AI102 (backend), US-AI122, US-AI123. This is the server-side streaming logic. Deploy note: Nginx proxy_read_timeout 120s and PHP-FPM request_terminate_timeout=120 required."
    },
    {
      "id": "US-037",
      "title": "Implement frontend SSE streaming consumer",
      "description": "As an Operator, I want to see AI responses appear progressively (streaming).",
      "acceptanceCriteria": [
        "Alpine.js component consumes SSE via fetch() API with ReadableStream reader (NOT EventSource — POST not supported)",
        "Include X-CSRF-TOKEN header from meta tag in every request",
        "Typing indicator (3 animated dots) while waiting for first chunk",
        "Auto-scroll to bottom during streaming",
        "Handle HTTP 419 (CSRF/session expired): show 'Session expired. Please reload.' with reload button",
        "Handle HTTP 429 (rate limit): show 'Rate limit exceeded. Try again in {minutes} minutes.'",
        "Handle generic errors: inline 'Something went wrong. Please try again.'",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 37,
      "passes": true,
      "notes": "PRD ref: US-AI102 (frontend). Alpine.js is already used in the project."
    },
    {
      "id": "US-038",
      "title": "Implement advanced message rendering (Markdown, tables, tool badges)",
      "description": "As an Operator, I want AI responses rendered with rich formatting.",
      "acceptanceCriteria": [
        "Markdown rendering: headings, bold, italic, inline code, code blocks",
        "Markdown tables rendered as HTML tables with Filament-consistent styling",
        "Ordered and unordered lists rendered correctly",
        "Internal Filament URLs (/admin/...) rendered as clickable links",
        "Tool call badges: tool name, module icon, execution time",
        "Numbers and amounts formatted with monospace font",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 38,
      "passes": true,
      "notes": "PRD ref: US-AI103. Use a lightweight JS markdown parser (e.g., marked.js or similar)."
    },
    {
      "id": "US-039",
      "title": "Build conversation API endpoints and sidebar",
      "description": "As an Operator, I want a sidebar with my conversation list to navigate between sessions.",
      "acceptanceCriteria": [
        "Create migration 2026_02_15_500002_alter_agent_conversations_add_title.php adding title (string nullable) and deleted_at (timestamp nullable)",
        "Create App\\Http\\Controllers\\AI\\ConversationController with index, messages, update, destroy methods",
        "Register routes in routes/web.php grouped under admin/ai with ['web', 'auth'] middleware: GET /conversations, GET /conversations/{id}/messages, PATCH /conversations/{id}, DELETE /conversations/{id}",
        "Controller has private conversationsQuery() helper that always includes whereNull('deleted_at') and where('user_id', auth()->id())",
        "GET index returns paginated list: id, title, updated_at, message_count, ordered by updated_at DESC",
        "GET messages returns messages for a conversation, verifying ownership",
        "DELETE soft-deletes by setting deleted_at = now()",
        "PATCH updates title only",
        "Sidebar shows conversations ordered by last message DESC, each with truncated title (50 chars), timestamp, message count",
        "New Conversation button with heroicon-o-plus at top",
        "Click loads conversation history, active conversation highlighted bg-primary-50",
        "Auto-generated title from first message (first 60 chars at word boundary + '...')",
        "Delete button with trash icon and confirmation on each conversation",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 39,
      "passes": true,
      "notes": "PRD ref: US-AI104, US-AI110, US-AI111, US-AI112. Centralizes all conversation management. SDK model does NOT use SoftDeletes — filter manually."
    },
    {
      "id": "US-040",
      "title": "Add context window management",
      "description": "As a Developer, I want to manage the conversation context window to avoid exceeding token limits.",
      "acceptanceCriteria": [
        "Maximum last 30 messages sent as context to API (from config max_context_messages)",
        "Older messages excluded from API context but retained in database for UI display",
        "Visual divider in UI: 'Older messages not included in AI context' above oldest context message",
        "If tokens_input exceeds 100K for a request, add warning to audit log metadata",
        "Typecheck passes"
      ],
      "priority": 40,
      "passes": true,
      "notes": "PRD ref: US-AI113. Monitor tokens_input in audit logs and adjust max_context_messages if needed."
    },
    {
      "id": "US-041",
      "title": "Implement role-based tool access filtering",
      "description": "As an Admin, I want AI tools to respect the authenticated user's role.",
      "acceptanceCriteria": [
        "Each tool's requiredAccessLevel() is checked before execution via BaseTool::authorizeForUser()",
        "ErpAssistantAgent::tools() filters tools based on authenticated user's role",
        "If tool unauthorized: agent responds with permission denied message including minimum required role",
        "Mapping: super_admin/admin → Full, manager → Standard, editor → Basic, viewer → Overview",
        "Denied tool calls logged in ai_audit_logs with metadata",
        "Typecheck passes"
      ],
      "priority": 41,
      "passes": true,
      "notes": "PRD ref: US-AI120. Authorization is declarative — each tool declares its ToolAccessLevel."
    },
    {
      "id": "US-042",
      "title": "Add top bar quick-access chat icon",
      "description": "As an Operator, I want a chat icon in the Filament top bar for quick access from any page.",
      "acceptanceCriteria": [
        "Chat bubble icon (heroicon-o-chat-bubble-left-right) in Filament top bar via renderHook('panels::user-menu.before')",
        "Register in AdminPanelProvider: ->renderHook('panels::user-menu.before', fn () => view('filament.hooks.ai-chat-icon'))",
        "Create resources/views/filament/hooks/ai-chat-icon.blade.php",
        "Click opens slide-over panel with simplified chat interface (no sidebar)",
        "Slide-over shows last active conversation or new, input field, streaming responses",
        "Closing preserves conversation state via Alpine.store('aiChat') persisted in localStorage",
        "Open full view link passes ?conversation={id} query param to full page",
        "State survives full page navigations",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 42,
      "passes": true,
      "notes": "PRD ref: US-AI105. First use of renderHook() in the ERP."
    },
    {
      "id": "US-043",
      "title": "Create audit log viewer Filament page",
      "description": "As an Admin, I want to view AI interaction audit logs for compliance and cost tracking.",
      "acceptanceCriteria": [
        "Admin view for ai_audit_logs: Filament table page with filters by user, date range, tool used",
        "Cost report: estimated cost calculated from tokens * price_per_token (from config)",
        "Only accessible to admin and super_admin roles",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 43,
      "passes": true,
      "notes": "PRD ref: US-AI122 (admin view portion)."
    },
    {
      "id": "US-044",
      "title": "Unit tests for all AI tools",
      "description": "As a Developer, I want unit tests for every AI tool to ensure query correctness.",
      "acceptanceCriteria": [
        "Test files in tests/Unit/AI/Tools/{Module}/{ToolName}Test.php",
        "Each test uses RefreshDatabase and seeds test data",
        "Minimum 3 tests per tool: happy path, filtering, authorization",
        "Verify: correct output structure, filters work, limits respected, currency formatting correct",
        "Authorization test: insufficient role returns error",
        "All 25 tools have tests",
        "All tests pass with php artisan test",
        "Typecheck passes"
      ],
      "priority": 44,
      "passes": true,
      "notes": "PRD ref: US-AI130. 25 tools × 3 tests minimum = 75+ tests."
    },
    {
      "id": "US-045",
      "title": "Integration tests for agent and feature tests for UI",
      "description": "As a Developer, I want integration tests for agent orchestration and feature tests for the UI page.",
      "acceptanceCriteria": [
        "Create tests/Feature/AI/ErpAssistantAgentTest.php using ErpAssistantAgent::fake() from SDK",
        "Verify: agent responds, conversation persisted, audit log created",
        "Verify: rate limiting works (exceed limit returns 429)",
        "Verify: role-based access (viewer cannot access finance tools)",
        "Create tests/Feature/Filament/AiAssistantPageTest.php",
        "Verify: page accessible for authenticated user, not accessible without login, role check works",
        "All tests pass",
        "Typecheck passes"
      ],
      "priority": 45,
      "passes": true,
      "notes": "PRD ref: US-AI131, US-AI132."
    },
    {
      "id": "US-046",
      "title": "PHPStan and Pint compliance for all AI code",
      "description": "As a Developer, I want all AI code compliant with PHPStan level 5 and Laravel Pint.",
      "acceptanceCriteria": [
        "composer analyse reports no errors for files in app/AI/, app/Filament/Pages/AiAssistant.php, app/Models/AI/, app/Enums/AI/, app/Http/Controllers/AI/",
        "composer lint:test reports no errors for all AI files",
        "All types explicit, no unnecessary @var, no avoidable mixed types",
        "Typecheck passes"
      ],
      "priority": 46,
      "passes": true,
      "notes": "PRD ref: US-AI133. Final quality gate."
    }
  ]
}
